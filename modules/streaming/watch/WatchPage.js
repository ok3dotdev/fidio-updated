function _extends(){return(_extends=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var a,c=arguments[e];for(a in c)Object.prototype.hasOwnProperty.call(c,a)&&(t[a]=c[a])}return t}).apply(this,arguments)}import React from"react";import WatchPageStyles from"./WatchPage.module.scss";import{checkSignedIn}from"../../utility/onboarding";import{doFetchAuthForStream,checkAuthorization}from"../../utility/streaming";import{ensureAutoPlay}from"../../video/player/utility";import{v4 as uuidv4}from"uuid";import{handleInteractMedia,isObjectEmpty}from"../../util";import{initializePlayer}from"/modules/streaming/watch/runtime/initialize";import{checkiOS}from"/modules/util";import{Watch}from"/layout";const defaultPoster="img/internal/videoposter.png";let options={autoplay:!0};const Module=s=>{const[a,c]=React.useState(!1),[r,o]=React.useState(null),[e,i]=React.useState(!1),[n,l]=React.useState({action:"page_loaded",trying:"play_video",src:""}),[h,u]=React.useState(""),[m,d]=React.useState(!1),[p,g]=React.useState({}),[t,y]=React.useState({});var[,,]=React.useState(null);const[f,w]=React.useState({}),[v,R]=React.useState(defaultPoster),[_,D]=React.useState(!1),[S,E]=React.useState(!1),[b,P]=React.useState(!1),[,k]=React.useState(!1);let L=React.useRef();React.useRef(),React.useRef(),React.useRef();const A=React.useRef(),O=(r&&(s._LocalEventEmitter.unsubscribe(r),s._LocalEventEmitter.subscribe(r,t=>{if(t&&t.dispatch)if("updateAuth"===t.dispatch){if(!s?.watchData||isObjectEmpty(s.watchData))return null;var e;!m&&A.current&&(e={type:"auth",lead:"Not Authorized",description:"You have not been authorized to watch the stream"},console.log("auth req",p),p&&(p.password&&(e.password="The stream requires a password"),p.tags)&&p.dates&&(0<p.tags.length||0<p.dates.length)&&(e.tags="The stream has tags that authorize viewership of the stream. Please purchase tickets from the users shop to watch",e.tagsList=p.tags.map(t=>t)+" "+p.dates.map(t=>t)),y(e))}else"attemptAutoPlay"===t.dispatch&&L?.current&&(console.log("Attempt Play",L.current,n),L.current.play().catch(t=>{console.log(t,t.message),/failed because the user didn\'t interact with the document first/.test(t.toString())&&(L.current.muted(!0),console.log("Attemt play muted",L.current),L.current.play().catch(t=>{console.log(t)}))}))})),React.useEffect(()=>{s?._LocalEventEmitter&&(s._LocalEventEmitter.unsubscribe("video_set_chat_state"),s._LocalEventEmitter.subscribe("video_set_chat_state",t=>{console.log("Open",_),D(!_)}))},[s._LocalEventEmitter,_]),React.useEffect(()=>{(async()=>{var t;e||s.watchData&&s.watchData.id&&(!f.stream||f.stream&&f.stream!==s.watchData.id)&&(i(!0),t=await doFetchAuthForStream(s.apiUrl,s.domainKey,s.watchData.id,checkSignedIn),console.log("do fetch auth",t),t)&&w({stream:s.watchData.id,allowed:t.allowed||!1,meta:t.meta})})()},[s.watchData,f,e]),async(t,e)=>{var a=e??s?.watchData,c="Live"==a?.__typename||checkiOS()?"hls":"mpd";a&&a[c]&&(a=s.cdn.static+"/video/"+a[c],console.log(a,window.videojs,e),console.log("Player Auto Play",t),t.src({src:a,type:"hls"==c?"application/x-mpegURL":"application/dash+xml"}),console.log(t.play),await ensureAutoPlay(t.play,t),setTimeout(()=>{s._LocalEventEmitter.dispatch(r,{dispatch:"attemptAutoPlay"})},1))}),x=()=>{s._LocalEventEmitter.dispatch("video_set_chat_state",{})},z=(React.useEffect(()=>{if(console.log(a,b,r),!a&&window.videojs){c((new Date).getTime());const e=uuidv4();o(e),setTimeout(()=>{s._LocalEventEmitter.dispatch(e,{dispatch:"updateAuth"})},2500)}else{var t;a&&!b&&r&&(t=[{innerHTML:"chat",className:"material-icons VideoPlayer_ChatBtn",btnEvent:x}],L.current=initializePlayer(s,s.watchData,n,"player-"+r,options,L,t,null,null,P,O,k))}},[a,L.current,n,s.cdn,s.watchData,b,r]),()=>{t&&t.type&&["prompt","auth"].indexOf(t.type)&&y({})}),U=(console.log(f,t),s.watchData);React.useEffect(()=>{let t;var e;"Live"==U?.__typename&&U?.id&&L.current&&L.current.paused()?(D(!0),U?.meta?.channel?.playbackUrl&&n.src!==U.meta.channel.playbackUrl&&(t=U.meta.channel.playbackUrl)):"Video"==U?.__typename&&(D(!1),e=checkiOS()?"hls":"mpd",U)&&U[e]&&(e=s.cdn.static+"/video/"+U[e],n.src!==e)&&(t=e),t&&n.src!==t&&L?.current?.play&&((e={...n}).src=t,l(e),handleInteractMedia(s,s.watchData,n.trying))},[s.watchData,L.current,n?.src,U]),React.useEffect(()=>{var t;n?.src&&m&&h!==n.src&&(t="hls"==("Live"==U?.__typename||checkiOS()?"hls":"mpd")?"application/x-mpegURL":"application/dash+xml",u(n.src),L.current.src({src:n.src,type:t}))},[L?.current,n?.src,m,h,U]),React.useEffect(()=>{var t,e,a;s.watchData&&(t=checkAuthorization(s.watchData,f,s,z),s.watchData.meta&&s.watchData.meta.streamSettings&&g(s.watchData.meta.streamSettings),console.log(m,t),m!==t)&&(e=s.watchData?.meta?.channel&&s.watchData.meta?.channel?.playbackUrl&&n?.src===s.watchData.meta.channel.playbackUrl,a=s?.watchData?.hls||s?.watchData?.mpd,e||a)&&(d(t),console.log("Auth",t))},[n,m,s.watchData,L.current,f,s?._loggedIn?.identifier]);React.useEffect(()=>{s?.watchData&&s?.watchData?.thumbtrack[0]&&s?.cdn?.static&&R(s.cdn.static+"/thumbtrack/"+s.watchData.thumbtrack[0])},[s?.watchData]);var j={donateTo:s?.watchData?.author??"",title:s?.watchData?.title??"",description:s?.watchData?.description??""},C=(console.log(s,_,b,n),s.menuConfig&&s.menuConfig.height?s.menuConfig.height+2+"px":"35px");return React.createElement("div",{className:s.className+" WatchPage_Container"},React.createElement(Watch,_extends({},s,{chatState:_,handleSetMobileStyleConfigs:t=>{S!==t&&E(t)},menuHeight:C,currentPoster:v,streamLeadPrompt:t,authContainer:A,WatchPageStyles:WatchPageStyles,watchMeta:j,playerInitialized:b,playerName:r?"player-"+r:null})))};export default Module;