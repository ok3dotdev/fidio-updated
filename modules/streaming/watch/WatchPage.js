function _extends(){return(_extends=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var a,c=arguments[e];for(a in c)Object.prototype.hasOwnProperty.call(c,a)&&(t[a]=c[a])}return t}).apply(this,arguments)}import React from"react";import Script from"next/script";import WatchPageStyles from"./WatchPage.module.scss";import{checkSignedIn}from"../../utility/onboarding";import{doFetchAuthForStream}from"../../utility/streaming";import{ensureAutoPlay}from"../../video/player/utility";import{v4 as uuidv4}from"uuid";import{handleInteractMedia}from"../../util";import{Watch}from"/layout";const defaultPoster="img/internal/videoposter.png",Module=a=>{const[e,c]=React.useState(!1),[t,r]=React.useState(null),[n,s]=React.useState(!1),[o,i]=React.useState({action:"page_loaded",trying:"play_video",src:""}),[l,h]=React.useState(!1),[u,d]=React.useState({}),[m,p]=React.useState({});var[,,]=React.useState(null);const[w,g]=React.useState({});var[v,,]=React.useState(defaultPoster);const[y,f]=React.useState(!0),[D,R]=React.useState(!1);let _=React.useRef();React.useRef(),React.useRef(),React.useRef();const S=React.useRef(),E=(t&&(a._LocalEventEmitter.unsubscribe(t),a._LocalEventEmitter.subscribe(t,t=>{t&&t.dispatch&&"updateAuth"===t.dispatch&&!l&&S.current&&(t={type:"auth",lead:"Not Authorized",description:"You have not been authorized to watch the stream"},console.log("auth req",u),u&&(u.password&&(t.password="The stream requires a password"),u.tags)&&u.dates&&(0<u.tags.length||0<u.dates.length)&&(t.tags="The stream has tags that authorize viewership of the stream. Please purchase tickets from the users shop to watch",t.tagsList=u.tags.map(t=>t)+" "+u.dates.map(t=>t)),p(t))})),React.useEffect(()=>{a?._LocalEventEmitter&&(a._LocalEventEmitter.unsubscribe("video_set_chat_state"),a._LocalEventEmitter.subscribe("video_set_chat_state",t=>{console.log("Open",y),f(!y)}))},[a._LocalEventEmitter,y]),React.useEffect(()=>{(async()=>{var t;n||a.watchData&&a.watchData.id&&(!w.stream||w.stream&&w.stream!==a.watchData.id)&&(s(!0),t=await doFetchAuthForStream(a.apiUrl,a.domainKey,a.watchData.id,checkSignedIn),console.log("do fetch auth",t),t)&&g({stream:a.watchData.id,allowed:t.allowed||!1,meta:t.meta})})()},[a.watchData,w,n]),React.useEffect(()=>{if(!e&&window.videojs){c((new Date).getTime());const t=uuidv4();r(t),setTimeout(()=>{a._LocalEventEmitter.dispatch(t,{dispatch:"updateAuth"})},2500);a.cdn&&a.watchData&&E({})}},[e,_.current,o,a.cdn,a.watchData]),React.useEffect(()=>{var t;a.cdn&&a.watchData&&(t={},E(t))},[_.current,o,a.cdn,a.watchData]),t=>{var e;!_.current&&window.videojs&&((e=window.videojs.players)&&Object.keys(e).length&&e["my-player"]&&e["my-player"].dispose(),_.current=window.videojs("my-player",t,async function(){window.videojs.log("Your player is ready!"),console.log(_.current);var t=_.current.controlBar.addChild("button"),e=t.el(),t=(e.innerHTML="chat",t.addClass("chat material-icons chat-button"),console.log(t,e),()=>{a._LocalEventEmitter.dispatch("video_set_chat_state",{})});e.removeEventListener("click",t),e.addEventListener("click",t),console.log(o,a),"play_video"===o.trying&&a.watchData&&"Live"==a.watchData.__typename&&a.watchData.id&&a.cdn&&a.cdn.live&&a.watchData.meta&&a.watchData.meta.channel&&a.watchData.meta.channel.playbackUrl&&(e={...o},t=a.watchData.meta.channel.playbackUrl,e.src=t,i(e),handleInteractMedia(a,a.watchData,o.trying)),this.on("error",t=>{console.log(t)}),this.on("ended",function(){window.videojs.log("Awww...over so soon?!"),this.dispose()}),o.src&&ensureAutoPlay(this.play(),this)}))}),b=()=>{m&&m.type&&"prompt"===m.type&&p({})};console.log(w),React.useEffect(()=>{var t,e;a.watchData&&"Live"==a.watchData.__typename&&a.watchData.id&&_.current&&_.current.paused()&&(console.log("source",a.watchData),a.watchData.meta)&&a.watchData.meta.channel&&a.watchData.meta.channel.playbackUrl&&o.src!==a.watchData.meta.channel.playbackUrl&&(t={...o},e=a.watchData.meta.channel.playbackUrl,t.src=e,i(t),ensureAutoPlay(_.current.play(),_.current),handleInteractMedia(a,a.watchData,o.trying))},[a.watchData,_.current,o]),React.useEffect(()=>{var t;a.watchData&&(t=(t=>{if(t&&t.meta&&t.meta.streamSettings){var e=t.meta.streamSettings;if(console.log("Settings",e),e.private)return a._loggedIn&&a._loggedIn.identifier&&t.author==a._loggedIn.identifier?(b(),!0):!(!w||!w.allowed||(console.log("relevant ticket",w),b(),0))}return b(),!0})(a.watchData),a.watchData.meta&&a.watchData.meta.streamSettings&&d(a.watchData.meta.streamSettings),l!==t)&&a.watchData&&a.watchData.meta&&a.watchData.meta.channel&&a.watchData.meta.channel.playbackUrl&&o&&o.src===a.watchData.meta.channel.playbackUrl&&(h(t),t)&&_.current.src({src:o.src,type:"application/x-mpegURL"})},[o,l,a.watchData,_.current,w]);console.log(a,y);var L=a.menuConfig&&a.menuConfig.height?a.menuConfig.height+2+"px":"35px";return React.createElement("div",{className:a.className+" WatchPage_Container"},React.createElement(Script,{src:"https://d2zsu4v7czjhvo.cloudfront.net/all/videojs/8.9.0/video.min.js"}),React.createElement(Watch,_extends({},a,{chatState:y,handleSetMobileStyleConfigs:t=>{D!==t&&R(t)},menuHeight:L,currentPoster:v,streamLeadPrompt:m,authContainer:S,WatchPageStyles:WatchPageStyles})))};export default Module;