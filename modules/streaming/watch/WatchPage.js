function _extends(){return(_extends=Object.assign?Object.assign.bind():function(t){for(var a=1;a<arguments.length;a++){var e,c=arguments[a];for(e in c)Object.prototype.hasOwnProperty.call(c,e)&&(t[e]=c[e])}return t}).apply(this,arguments)}import React from"react";import Script from"next/script";import WatchPageStyles from"./WatchPage.module.scss";import{checkSignedIn}from"../../utility/onboarding";import{doFetchAuthForStream,checkAuthorization}from"../../utility/streaming";import{ensureAutoPlay}from"../../video/player/utility";import{v4 as uuidv4}from"uuid";import{handleInteractMedia}from"../../util";import{Watch}from"/layout";const defaultPoster="img/internal/videoposter.png",Module=e=>{const[a,c]=React.useState(!1),[t,r]=React.useState(null),[n,o]=React.useState(!1),[s,i]=React.useState({action:"page_loaded",trying:"play_video",src:""}),[h,l]=React.useState(!1),[u,d]=React.useState({}),[m,p]=React.useState({});var[,,]=React.useState(null);const[w,g]=React.useState({});var[v,,]=React.useState(defaultPoster);const[y,f]=React.useState(!0),[D,R]=React.useState(!1);let _=React.useRef();React.useRef(),React.useRef(),React.useRef();const E=React.useRef(),S=(t&&(e._LocalEventEmitter.unsubscribe(t),e._LocalEventEmitter.subscribe(t,t=>{t&&t.dispatch&&"updateAuth"===t.dispatch&&!h&&E.current&&(t={type:"auth",lead:"Not Authorized",description:"You have not been authorized to watch the stream"},console.log("auth req",u),u&&(u.password&&(t.password="The stream requires a password"),u.tags)&&u.dates&&(0<u.tags.length||0<u.dates.length)&&(t.tags="The stream has tags that authorize viewership of the stream. Please purchase tickets from the users shop to watch",t.tagsList=u.tags.map(t=>t)+" "+u.dates.map(t=>t)),p(t))})),React.useEffect(()=>{e?._LocalEventEmitter&&(e._LocalEventEmitter.unsubscribe("video_set_chat_state"),e._LocalEventEmitter.subscribe("video_set_chat_state",t=>{console.log("Open",y),f(!y)}))},[e._LocalEventEmitter,y]),React.useEffect(()=>{(async()=>{var t;n||e.watchData&&e.watchData.id&&(!w.stream||w.stream&&w.stream!==e.watchData.id)&&(o(!0),t=await doFetchAuthForStream(e.apiUrl,e.domainKey,e.watchData.id,checkSignedIn),console.log("do fetch auth",t),t)&&g({stream:e.watchData.id,allowed:t.allowed||!1,meta:t.meta})})()},[e.watchData,w,n]),React.useEffect(()=>{if(!a&&window.videojs){c((new Date).getTime());const t=uuidv4();r(t),setTimeout(()=>{e._LocalEventEmitter.dispatch(t,{dispatch:"updateAuth"})},2500);e.cdn&&e.watchData&&S({})}},[a,_.current,s,e.cdn,e.watchData]),React.useEffect(()=>{var t;e.cdn&&e.watchData&&(t={},S(t))},[_.current,s,e.cdn,e.watchData]),t=>{var a;!_.current&&window.videojs&&((a=window.videojs.players)&&Object.keys(a).length&&a["my-player"]&&a["my-player"].dispose(),_.current=window.videojs("my-player",t,async function(){window.videojs.log("Your player is ready!"),console.log(_.current);var t=_.current.controlBar.addChild("button"),a=t.el(),t=(a.innerHTML="chat",t.addClass("chat material-icons chat-button"),console.log(t,a),()=>{e._LocalEventEmitter.dispatch("video_set_chat_state",{})});a.removeEventListener("click",t),a.addEventListener("click",t),console.log(s,e),"play_video"===s.trying&&e.watchData&&"Live"==e.watchData.__typename&&e.watchData.id&&e.cdn&&e.cdn.live&&e.watchData.meta&&e.watchData.meta.channel&&e.watchData.meta.channel.playbackUrl&&(a={...s},t=e.watchData.meta.channel.playbackUrl,a.src=t,i(a),handleInteractMedia(e,e.watchData,s.trying)),this.on("error",t=>{console.log(t)}),this.on("ended",function(){window.videojs.log("Awww...over so soon?!"),this.dispose()}),s.src&&ensureAutoPlay(this.play,this)}))}),b=()=>{m&&m.type&&["prompt","auth"].indexOf(m.type)&&p({})};console.log(w,m),React.useEffect(()=>{var t,a;e.watchData&&"Live"==e.watchData.__typename&&e.watchData.id&&_.current&&_.current.paused()&&(console.log("source",e.watchData),e.watchData.meta)&&e.watchData.meta.channel&&e.watchData.meta.channel.playbackUrl&&s.src!==e.watchData.meta.channel.playbackUrl&&(t={...s},a=e.watchData.meta.channel.playbackUrl,t.src=a,i(t),ensureAutoPlay(_.current.play,_.current),handleInteractMedia(e,e.watchData,s.trying))},[e.watchData,_.current,s]),React.useEffect(()=>{var t;e.watchData&&(t=checkAuthorization(e.watchData,w,e,b),e.watchData.meta&&e.watchData.meta.streamSettings&&d(e.watchData.meta.streamSettings),h!==t)&&e.watchData&&e.watchData.meta&&e.watchData.meta.channel&&e.watchData.meta.channel.playbackUrl&&s&&s.src===e.watchData.meta.channel.playbackUrl&&(l(t),console.log("Auth",t),t)&&_.current.src({src:s.src,type:"application/x-mpegURL"})},[s,h,e.watchData,_.current,w,e?._loggedIn?.identifier]);var L={donateTo:e?.watchData?.author??"",title:e?.watchData?.title??"",description:e?.watchData?.description??""},k=(console.log(e,y),e.menuConfig&&e.menuConfig.height?e.menuConfig.height+2+"px":"35px");return React.createElement("div",{className:e.className+" WatchPage_Container"},React.createElement(Script,{src:"https://d2zsu4v7czjhvo.cloudfront.net/all/videojs/8.9.0/video.min.js"}),React.createElement(Watch,_extends({},e,{chatState:y,handleSetMobileStyleConfigs:t=>{D!==t&&R(t)},menuHeight:k,currentPoster:v,streamLeadPrompt:m,authContainer:E,WatchPageStyles:WatchPageStyles,watchMeta:L})))};export default Module;