import React from"react";import Link from"next/link";import{v4 as uuidv4}from"uuid";import TextareaAutosize from"react-textarea-autosize";import{attemptBanUserChat,joinChat,requestBanTable,sendChat}from"../../utility/socket";import{isObjectEmpty}from"../../util";import ChatStyles from"./Chat.module.scss";import{handleKeyPressChat,scrollChatDown}from"./utility";import Close from"@mui/icons-material/Close";import Reply from"@mui/icons-material/Reply";import ArrowUpward from"@mui/icons-material/ArrowUpward";import Tooltip from"@mui/material/Tooltip";const CONNECT_THRESHOLD=12500,ADHOC_BLOCK_CHAT=1500,RECENT_CHAT_THRESHOLD=2e4,RECENT_CHAT_TIMEOUT=1e4,MAX_RECENT_CHATS=9,Module=r=>{const[t,U]=React.useState(!1),[,F]=React.useState(null),[a,n]=React.useState(!1),[l,e]=React.useState(!1),[o,M]=React.useState({}),[i,$]=React.useState(!1),[c,B]=React.useState(null),[s,m]=React.useState(!1),[u,h]=React.useState(!1),[j,g]=React.useState(!1),[,z]=React.useState(-1),[d,K]=React.useState([]),[C,R]=React.useState(null),[p,W]=React.useState({}),[E,y]=React.useState(null),[_,q]=React.useState(null),[b,P]=React.useState(-1),[v,T]=React.useState(null),[S,f]=React.useState(null),[N,V]=React.useState([]),[X,A]=React.useState(null),[L,Y]=React.useState(-1),[I,w]=React.useState(!1),[G,J]=React.useState(null),k=React.useRef(),H=React.useRef(),O=React.useRef(),D=(React.useEffect(()=>{var e;t||(e=uuidv4(),F(e),setInterval(()=>{J(window?.innerWidth??null)},1e3),U(!0))},[t]),React.useEffect(()=>{r._LocalEventEmitter&&(r._LocalEventEmitter.unsubscribe("receive_chat"),r._LocalEventEmitter.subscribe("receive_chat",e=>{if(e){var t=Object.entries(e);for(let e=0;e<t.length;e++)if(t[e][0]&&t[e][0]===i&&t[e][1]){console.log(t[e][1],c);const a=!c||c.length<50,r=c?.length?t[e][1].length-c.length:0;setTimeout(()=>{(te(r)||a)&&scrollChatDown(H,c?"smooth":"instant")},50),B(t[e][1]);break}}}))},[r._LocalEventEmitter,r.chatConfig,i,H.current,O.current,c]),React.useEffect(()=>{r._LocalEventEmitter&&(r._LocalEventEmitter.unsubscribe("receive_ban_table"),r._LocalEventEmitter.subscribe("receive_ban_table",e=>{if(console.log(e),e){var t=Object.entries(e);for(let e=0;e<Object.entries(t).length;e++){var a=r.chatFor+"-chat-"+r.dborigin;if(t[e][0]&&t[e][0]===a){console.log("Setting ban table",t[e][1]),q(t[e][1]??{});break}}}}))},[r._LocalEventEmitter,r.chatFor,r.dborigin]),React.useEffect(()=>{r._LocalEventEmitter&&(r._LocalEventEmitter.unsubscribe("join_chat_waiting"),r._LocalEventEmitter.subscribe("join_chat_waiting",e=>{var t=r.chatFor+"-chat";Q(t)}))},[a,r._socket,r.dborigin,r._rooms,r.chatFor,r._loggedIn,r.dborigin,l,o,i]),React.useEffect(()=>{r?.videoStatus&&r?._loggedIn?.identifier&&r?._loggedIn?.hash&&r.chatFor&&-1<["live"].indexOf(r.videoStatus)?e(!0):e(!1)},[r._loggedIn,r.chatFor,r.videoStatus,l]),e=>{console.log("Manage Chats",e,d);var t=d;e&&t.push({chat:e,time:(new Date).getTime()});for(let e=0;e<t.length;e++)t[e].time<(new Date).getTime()-RECENT_CHAT_THRESHOLD&&t.splice(e,1);K(t),ae(t)}),Q=(React.useEffect(()=>{console.log(a,r._rooms,r._socket,r.chatFor);var e=r.chatFor+"-chat";Q(e),Z(),D()},[a,r._socket,r.dborigin,r._rooms,r.chatFor,r._loggedIn,r.dborigin,l,o,i,D]),e=>{try{i&&r.chatFor+"-chat-"+r.dborigin===i&&c||(console.log(r._rooms.rooms.indexOf(e+"-"+r.dborigin),r._rooms,e+"-"+r.dborigin),!a&&r._rooms&&l&&(!r._rooms.rooms||r._rooms.rooms.indexOf(e+"-"+r.dborigin)<0||!c)&&(isObjectEmpty(o)||o.time<(new Date).getTime()-CONNECT_THRESHOLD&&o.attempt<5)&&(console.log(o),n(!0),setTimeout(()=>{n(!1),setTimeout(()=>{r._LocalEventEmitter.dispatch("join_chat_waiting",{})},500)},(o.attempt??1)*CONNECT_THRESHOLD),joinChat(r._socket,r._loggedIn,r.dborigin,e,o.attempt??1),M({time:(new Date).getTime(),attempt:o.attempt?o.attempt+1:2})))}catch(e){}}),Z=()=>{var e;r.chatFor&&(e=r.chatFor+"-chat",r.dborigin)&&-1<r?._rooms?.rooms?.indexOf(e+"-"+r.dborigin)&&i!==e+"-"+r.dborigin&&$(e+"-"+r.dborigin)},ee=async e=>{var t,a;k?.current?.value&&!s&&(t=k.current.value,console.log("Chat To Send",t),r.chatFor&&r._socket&&r?._loggedIn?.username&&r?._loggedIn?.identifier&&r?._loggedIn?.hash&&r.dborigin&&(a=r.chatFor+"-chat",D(t),sendChat(r._socket,r._loggedIn,r.dborigin,a,t,v,S),T(null),f(null)),h(!0),z((new Date).getTime()),setTimeout(()=>{h(!1),setTimeout(()=>{k?.current&&k.current.select()},50)},ADHOC_BLOCK_CHAT),setTimeout(()=>{scrollChatDown(H,"smooth")},250),k.current.value="",k.current.setAttribute("style","height: 1.35rem"))},te=(e=0)=>{if(H?.current&&O?.current){var t=e*(r?.chatConfig?.chatItemHeight??17.5),e=(console.log(H.current.scrollTop,O.current.clientHeight-H.current.clientHeight,e,t,H.current.scrollTop+t),H.current.clientHeight+100);if(console.log(H.current.scrollTop+t,O.current.clientHeight-e),H.current.scrollTop+t>O.current.clientHeight-e)return!0}return!1},ae=e=>{(e??d).length>MAX_RECENT_CHATS&&!C&&(m(!0),g(!0),e=setTimeout(()=>{m(!1),g(!1),R(null)},RECENT_CHAT_TIMEOUT),C?.r&&clearTimeout(C.r),R({r:e,time:(new Date).getTime()+RECENT_CHAT_TIMEOUT}))};React.useEffect(()=>{var e,t=p;let a=!1;r?.watchData?.author!==r._loggedIn?.identifier||p.canBan||(a=!0,t.canBan=!0,!_&&b<(new Date).getTime()-10&&(P((new Date).getTime()),e=r.chatFor+"-chat",requestBanTable(r._socket,r._loggedIn,r.dborigin,e))),a&&W(t)},[r.watchData,r._loggedIn,p,_,r.chatFor,r._socket,r.dborigin,b]);const re=e=>{var t;e?.target?.getAttribute("username")&&e?.target?.getAttribute("author")&&(t=e.target.getAttribute("username"),e=e.target.getAttribute("author"),y({user:t,id:e}),te())&&scrollChatDown(H,"instant")};const ne=e=>{var t=e?.target.getAttribute("logid")?e.target:e.target.parentElement,t=e?.target.getAttribute("logid")?e.target:e.target.parentElement;if(console.log(e),t.getAttribute("logid")&&t.getAttribute("username")&&t.getAttribute("author")){const r=t.getAttribute("logid");e=t.getAttribute("username"),t=t.getAttribute("author");if(r&&e&&t){T(r),f(e);t=c.find(e=>e.id===r);if(t?.content&&t?.username){const n=[];n.push({id:r,username:t.username,content:t.content,replyLogid:t.replyLogid??null});for(let t=0;t<3;t++)if(n[t]?.replyLogid){var a=c.find(e=>e.id===n[t]?.replyLogid);if(!a)break;n.push({id:a.id,username:a.username,content:a.content,replyLogid:a.replyLogid??null})}V(n)}}}};const le=e=>{var t=e?.target.getAttribute("logid")?e.target:e.target.parentElement,t=e?.target.getAttribute("logid")?e.target:e.target.parentElement;console.log(t),t.getAttribute("logid")&&(e=t.getAttribute("logid"),t=document.querySelector(`div[logid='${e}']`),console.log(t),t?.scrollIntoView)&&(A(e),-1<L&&clearTimeout(L),e=setTimeout(()=>{A(null)},1e4),Y(e),t.scrollIntoView({behavior:"smooth",block:"center"}))},oe=()=>{t&&r?._isMobile&&(document?.activeElement!==k?.current||I?document&&document.activeElement&&document?.activeElement===k?.current||!I||(w(!1),r?.setMobileStyleConfigs&&r.setMobileStyleConfigs(!1)):(w(!0),window&&setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},250),r?.setMobileStyleConfigs&&r.setMobileStyleConfigs(!0)))};oe();var x=r?.chatConfig?.menuThreadOffset??2.85;const ie=r?.chatConfig?.replyOff;return console.log("Chat Log",c,Array.isArray(c),r.className,d,r,E,_,x,u,s),React.createElement("div",{className:`${r.className} ${ChatStyles.chatContainer} Chat_ChatContainer`,style:{height:null===G||700<G?`calc(100vh - ${r?.menuHeight})`:"50vh"},onClick:()=>{oe()}},E?React.createElement("div",{className:ChatStyles.userDisplayContainer+" Chat_UserDisplayContainer"},React.createElement("div",null,React.createElement("div",{className:"Chat_UserDisplayInternalContainer",style:{display:"flex",gap:".25rem"}},React.createElement("div",{className:"Chat_UserDisplayUser"},React.createElement(Link,{href:"/p?u="+E.user,style:{alignSelf:"center"}},E.user)),p?.canBan&&E.id!==r._loggedIn.identifier?_&&_[E.id]?React.createElement("button",{style:{fontSize:".75rem",padding:".125rem .25rem"},onClick:e=>{var t;e?.target?.getAttribute("userid")&&(t=r.chatFor+"-chat",attemptBanUserChat(r._socket,r._loggedIn,r.dborigin,t,e.target.getAttribute("userid"),{unban:!0}))},userid:""+E.id},"Unban User"):React.createElement("button",{style:{fontSize:".75rem",padding:".125rem .25rem"},onClick:e=>{var t;e?.target?.getAttribute("userid")&&(t=r.chatFor+"-chat",attemptBanUserChat(r._socket,r._loggedIn,r.dborigin,t,e.target.getAttribute("userid")))},userid:""+E.id},"Ban User"):null)),React.createElement(Close,{className:""+ChatStyles.close,onClick:e=>{y(null)},modif:"close"})):null,React.createElement("div",{className:`${ChatStyles.chatLogExternalContainer} ${I?""+ChatStyles.mobileChatLogExternalContainer:null} Chat_ChatLogExternalContainer`,ref:H},React.createElement("div",{className:ChatStyles.chatLogContainer+" Chat_ChatLogContainer",ref:O},c&&Array.isArray(c)?c.map((e,t)=>React.createElement("div",{className:"Chat_ChatLogItemContainer",key:t,index:t},e.id&&e.content&&e.author?React.createElement("div",{className:"Chat_ChatLogItemInternalContainer",logid:e.id,time:e.time,author:e.author,replylogid:e.replyLogid??null,replyusername:e.replyUsername},React.createElement("div",{className:`${ChatStyles.chatLogMain} ${X===e.id?""+ChatStyles.highlightedChat:""} Chat_ChatLogMain`},React.createElement("div",{className:`${ChatStyles.username} ${ChatStyles.usernameChat} Chat_ChatUsername`,username:e.username,author:e.author,onClick:re},e.username),ie?null:React.createElement(React.Fragment,null,e.replyLogid&&e.replyUsername?React.createElement("div",{className:""+ChatStyles.replyMeta},React.createElement("div",null,"Chat is Reply to ",React.createElement("b",null,"@",e.replyUsername))):React.createElement("div",{className:""+ChatStyles.replyMeta},React.createElement("div",null,"Reply to ",React.createElement("b",null,"@",e.username)))),React.createElement("div",{className:"Chat_Content"},e.content),ie?null:React.createElement(React.Fragment,null,e.replyLogid?React.createElement("div",{className:ChatStyles.viewReplyTo+" Chat_ViewReplyTo",onClick:le,logid:e.replyLogid,style:{marginTop:".25rem"}},React.createElement(ArrowUpward,{logid:e.replyLogid})):null,React.createElement("div",{className:ChatStyles.replyTo+" Chat_ReplyTo",onClick:ne,logid:e.id,username:e.username,author:e.author,style:{marginTop:".25rem"}},React.createElement(Reply,{logid:e.id,username:e.username,author:e.author}))))):React.createElement(React.Fragment,null))):React.createElement("div",null))),React.createElement("div",{className:`${ChatStyles.chatInputContainer} ${r.chatState?null:""+ChatStyles.forceHideChat} Chat_ChatInputContainer`},React.createElement("div",{className:ChatStyles.chatInputInternalContainer+" Chat_ChatInputInternalContainer"},C?React.createElement("div",{className:ChatStyles.chatWarningContainer+" Chat_ChatWarningContainer"},React.createElement("div",{className:ChatStyles.warningText+" Chat_WarningText"},C?"Timed Out":""),d?.length?React.createElement("div",{className:""+ChatStyles.warningBody,style:{fontSize:".85rem"}},"You have sent ",d.length," recent chats"):null):null,v&&S?React.createElement("div",null,N&&Array.isArray(N)&&0<N.length?React.createElement("div",{className:ChatStyles.replyToRepliesContainer+" Chat_ReplyToRepliesContainer",style:{top:`-${4<N.length?4+x:N.length+x}rem`}},React.createElement("div",{className:ChatStyles.threadLabel+" Chat_ThreadLabel"},"Thread"),N.slice(0).reverse().map((e,t)=>t<4?React.createElement("div",{className:ChatStyles.replyToRepliesThread+" Chat_ReplyToRepliesThread",style:{display:"flex",gap:".25rem"},key:t,index:t},React.createElement("div",{className:"Chat_ReplyToRepliesUsername"},React.createElement("b",null,e.username??"")),React.createElement("div",{className:"Chat_ReplyToRepliesContent"},e.content??"")):null)):null,React.createElement("div",{className:ChatStyles.replyToContainer+" Chat_ReplyToContainer",replytoid:v},React.createElement("div",{className:"Chat_ReplyingToUsername"},"Replying to ",React.createElement("b",null,"@",S)),React.createElement(Tooltip,{title:"Cancel Reply",placement:"top"},React.createElement(Close,{onClick:e=>{T(null),f(null)},className:""+ChatStyles.chatCancelReplyTo,sx:{height:"17.5px"}})))):null,React.createElement("div",{className:ChatStyles.chatInputSendContainer+" Chat_ChatInputSendContainer"},React.createElement(TextareaAutosize,{className:`${ChatStyles.textChatInput} ${ChatStyles.highlightBorder} Chat_TextChatInput`,ref:k,onKeyPress:e=>{handleKeyPressChat(e,ee)},onChange:e=>{},disabled:s||!i}),React.createElement("button",{className:`${ChatStyles.send} ${ChatStyles.highlightBorder} Chat_Send`,onClick:ee,disabled:u||j},"Send")))))};export default Module;