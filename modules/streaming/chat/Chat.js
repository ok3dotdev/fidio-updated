function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,n=arguments[t];for(a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}import React from"react";import Link from"next/link";import{v4 as uuidv4}from"uuid";import TextareaAutosize from"react-textarea-autosize";import{attemptBanUserChat,joinChat,requestBanTable,sendChat}from"../../utility/socket";import{isObjectEmpty}from"../../util";import DonateBar from"./DonateBar";import ChatStyles from"./Chat.module.scss";import{handleKeyPressChat,scrollChatDown}from"./utility";import Close from"@mui/icons-material/Close";import Tooltip from"@mui/material/Tooltip";import{ChatLog,DonationsLedger}from"/layout/chat";const CONNECT_THRESHOLD=12500,ADHOC_BLOCK_CHAT=1500,RECENT_CHAT_THRESHOLD=2e4,RECENT_CHAT_TIMEOUT=1e4,MAX_RECENT_CHATS=9,Module=r=>{const[t,M]=React.useState(!1),[a,F]=React.useState(null),[n,l]=React.useState(!1),[i,e]=React.useState(!1),[o,B]=React.useState({}),[c,U]=React.useState(!1),[s,j]=React.useState(null),[u,g]=React.useState(!1),[m,h]=React.useState(!1),[$,d]=React.useState(!1),[,z]=React.useState(-1),[C,K]=React.useState([]),[p,_]=React.useState(null),[E,P]=React.useState({}),[R,b]=React.useState(null),[y,W]=React.useState(null),[v,q]=React.useState(-1),[f,T]=React.useState(null),[S,A]=React.useState(null),[L,V]=React.useState([]),[X,N]=React.useState(null),[G,Y]=React.useState(-1),[I,J]=React.useState(!1),[Q,Z]=React.useState(null),[D,ee]=React.useState([]),O=React.useRef(),w=React.useRef(),x=React.useRef(),H=(React.useEffect(()=>{if(!t){const e=uuidv4();F(e);setInterval(()=>{Z(window?.innerWidth??null)},1e3);setInterval(()=>{r._LocalEventEmitter.dispatch(e,{dispatch:"calculate_donations_ledger"})},5e3),M(!0)}},[t]),React.useEffect(()=>{r._LocalEventEmitter&&(r._LocalEventEmitter.unsubscribe("receive_chat"),r._LocalEventEmitter.subscribe("receive_chat",e=>{if(e){var t=Object.entries(e);for(let e=0;e<t.length;e++)if(t[e][0]&&t[e][0]===c&&t[e][1]){console.log(t[e][1],s);const a=!s||s.length<50,n=s?.length?t[e][1].length-s.length:0;setTimeout(()=>{(re(n)||a)&&scrollChatDown(w,s?"smooth":"instant")},50),j(t[e][1]);break}}}),r._LocalEventEmitter.unsubscribe(a),r._LocalEventEmitter.subscribe(a,e=>{if(e&&"calculate_donations_ledger"===e.dispatch&&s&&Array.isArray(s)){const n=[...D];n.map((e,t)=>{e.expiryMs<(new Date).getTime()-1e4&&n.splice(t,1)}),s.slice(75<s.length?s.length-75:0,s.length).map(t=>{var e,a;"donation"===t?.type&&-1===D.findIndex(e=>e.id===t.id)&&t?.time&&(e=t?.expiry?Number(t.expiry):12e4,(a=new Date(Number(t.time)).getTime()+e)>(new Date).getTime())&&n.unshift(Object.assign(t,{expiry:e,expiryMs:a}))}),console.log(n),ee(n)}}))},[a,r._LocalEventEmitter,r.chatConfig,c,w.current,x.current,s,D]),React.useEffect(()=>{r._LocalEventEmitter&&(r._LocalEventEmitter.unsubscribe("receive_ban_table"),r._LocalEventEmitter.subscribe("receive_ban_table",e=>{if(console.log(e),e){var t=Object.entries(e);for(let e=0;e<Object.entries(t).length;e++){var a=r.chatFor+"-chat-"+r.dborigin;if(t[e][0]&&t[e][0]===a){console.log("Setting ban table",t[e][1]),W(t[e][1]??{});break}}}}))},[r._LocalEventEmitter,r.chatFor,r.dborigin]),React.useEffect(()=>{r._LocalEventEmitter&&(r._LocalEventEmitter.unsubscribe("join_chat_waiting"),r._LocalEventEmitter.subscribe("join_chat_waiting",e=>{var t=r.chatFor+"-chat";te(t)}))},[n,r._socket,r.dborigin,r._rooms,r.chatFor,r._loggedIn,r.dborigin,i,o,c]),React.useEffect(()=>{r?.videoStatus&&r?._loggedIn?.identifier&&r?._loggedIn?.hash&&r.chatFor&&-1<["live"].indexOf(r.videoStatus)?e(!0):e(!1)},[r._loggedIn,r.chatFor,r.videoStatus,i]),e=>{console.log("Manage Chats",e,C);var t=C;e&&t.push({chat:e,time:(new Date).getTime()});for(let e=0;e<t.length;e++)t[e].time<(new Date).getTime()-RECENT_CHAT_THRESHOLD&&t.splice(e,1);K(t),le(t)}),te=(React.useEffect(()=>{console.log(n,r._rooms,r._socket,r.chatFor);var e=r.chatFor+"-chat";te(e),ae(),H()},[n,r._socket,r.dborigin,r._rooms,r.chatFor,r._loggedIn,r.dborigin,i,o,c,H]),e=>{try{c&&r.chatFor+"-chat-"+r.dborigin===c&&s||(console.log(r._rooms.rooms.indexOf(e+"-"+r.dborigin),r._rooms,e+"-"+r.dborigin),!n&&r._rooms&&i&&(!r._rooms.rooms||r._rooms.rooms.indexOf(e+"-"+r.dborigin)<0||!s)&&(isObjectEmpty(o)||o.time<(new Date).getTime()-CONNECT_THRESHOLD&&o.attempt<5)&&(console.log(o),l(!0),setTimeout(()=>{l(!1),setTimeout(()=>{r._LocalEventEmitter.dispatch("join_chat_waiting",{})},500)},(o.attempt??1)*CONNECT_THRESHOLD),joinChat(r._socket,r._loggedIn,r.dborigin,e,o.attempt??1),B({time:(new Date).getTime(),attempt:o.attempt?o.attempt+1:2}),setTimeout(()=>{r._LocalEventEmitter.dispatch(a,{dispatch:"calculate_donations_ledger"})},1500)))}catch(e){}}),ae=()=>{var e;r.chatFor&&(e=r.chatFor+"-chat",r.dborigin)&&-1<r?._rooms?.rooms?.indexOf(e+"-"+r.dborigin)&&c!==e+"-"+r.dborigin&&U(e+"-"+r.dborigin)},ne=async e=>{var t,a,n;O?.current?.value&&!u&&(t=O.current.value,a=r?._loggedIn?.icon,console.log("Chat To Send",t),r.chatFor&&r._socket&&r?._loggedIn?.username&&r?._loggedIn?.identifier&&r?._loggedIn?.hash&&r.dborigin&&(n=r.chatFor+"-chat",H(t),sendChat(r._socket,r._loggedIn,r.dborigin,n,t,f,S,a),T(null),A(null)),h(!0),z((new Date).getTime()),setTimeout(()=>{h(!1),setTimeout(()=>{O?.current&&O.current.select()},50)},ADHOC_BLOCK_CHAT),setTimeout(()=>{scrollChatDown(w,"smooth")},250),O.current.value="",O.current.setAttribute("style","height: 1.35rem"))},re=(e=0)=>{if(w?.current&&x?.current){var t=e*(r?.chatConfig?.chatItemHeight??17.5),e=(console.log(w.current.scrollTop,x.current.clientHeight-w.current.clientHeight,e,t,w.current.scrollTop+t),w.current.clientHeight+100);if(console.log(w.current.scrollTop+t,x.current.clientHeight-e),w.current.scrollTop+t>x.current.clientHeight-e)return!0}return!1},le=e=>{(e??C).length>MAX_RECENT_CHATS&&!p&&(g(!0),d(!0),e=setTimeout(()=>{g(!1),d(!1),_(null)},RECENT_CHAT_TIMEOUT),p?.r&&clearTimeout(p.r),_({r:e,time:(new Date).getTime()+RECENT_CHAT_TIMEOUT}))};React.useEffect(()=>{var e,t=E;let a=!1;r?.watchData?.author!==r._loggedIn?.identifier||E.canBan||(a=!0,t.canBan=!0,!y&&v<(new Date).getTime()-10&&(q((new Date).getTime()),e=r.chatFor+"-chat",requestBanTable(r._socket,r._loggedIn,r.dborigin,e))),a&&P(t)},[r.watchData,r._loggedIn,E,y,r.chatFor,r._socket,r.dborigin,v]);const ie=()=>{t&&r?._isMobile&&(document?.activeElement!==O?.current||I?document&&document.activeElement&&document?.activeElement===O?.current||!I||(J(!1),r?.setMobileStyleConfigs&&r.setMobileStyleConfigs(!1)):(J(!0),window&&setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},250),r?.setMobileStyleConfigs&&r.setMobileStyleConfigs(!0)))};const oe=e=>{var t=(new Date).getTime(),a=(e.expiryMs-t)/1e3,n=e.expiry/1e3,r=n-a,l=a/n,i=1-l;return console.log(e,r,n,t,e.expiryMs),console.log(r,n,l,a,i),{"--animation-duration":`${0<a?a:0}s`,"--gradient-scale":0<l?l:0}};var ce=React.useMemo(()=>React.createElement(DonationsLedger,_extends({},r,{donationsLedger:D,calculateAnimationStyles:oe})),[D]),k=(ie(),r?.chatConfig?.menuThreadOffset??2.85),se=r?.chatConfig?.replyOff;return console.log("Chat Log",s,Array.isArray(s),r.className,C,r,R,y,k,m,u),console.log(D),React.createElement("div",{className:`${r.className} ${ChatStyles.chatContainer} Chat_ChatContainer`,style:{height:""+(r.chatState?null===Q||700<Q?`calc(100vh - ${r?.menuHeight})`:"50vh":0)},onClick:()=>{ie()}},R?React.createElement("div",{className:ChatStyles.userDisplayContainer+" Chat_UserDisplayContainer"},React.createElement("div",null,React.createElement("div",{className:"Chat_UserDisplayInternalContainer",style:{display:"flex",gap:".25rem"}},React.createElement("div",{className:"Chat_UserDisplayUser"},React.createElement(Link,{href:"/p?u="+R.user,style:{alignSelf:"center"}},R.user)),E?.canBan&&R.id!==r._loggedIn.identifier?y&&y[R.id]?React.createElement("button",{style:{fontSize:".75rem",padding:".125rem .25rem"},onClick:e=>{var t;e?.target?.getAttribute("userid")&&(t=r.chatFor+"-chat",attemptBanUserChat(r._socket,r._loggedIn,r.dborigin,t,e.target.getAttribute("userid"),{unban:!0}))},userid:""+R.id},"Unban User"):React.createElement("button",{style:{fontSize:".75rem",padding:".125rem .25rem"},onClick:e=>{var t;e?.target?.getAttribute("userid")&&(t=r.chatFor+"-chat",attemptBanUserChat(r._socket,r._loggedIn,r.dborigin,t,e.target.getAttribute("userid")))},userid:""+R.id},"Ban User"):null)),React.createElement(Close,{className:""+ChatStyles.close,onClick:e=>{b(null)},modif:"close"})):null,ce,React.createElement(ChatLog,_extends({},r,{replyOff:se,mobileStyleConfigs:I,scrollChatRef:w,scrollChatInnerRef:x,chatLog:s,handleSetUserDisplay:e=>{var t;e?.target?.getAttribute("username")&&e?.target?.getAttribute("author")&&(t=e.target.getAttribute("username"),e=e.target.getAttribute("author"),b({user:t,id:e}),re())&&scrollChatDown(w,"instant")},handleGoToPost:e=>{var t=e?.target.getAttribute("logid")?e.target:e.target.parentElement,t=e?.target.getAttribute("logid")?e.target:e.target.parentElement;console.log(t),t.getAttribute("logid")&&(e=t.getAttribute("logid"),t=document.querySelector(`div[logid='${e}']`),console.log(t),t?.scrollIntoView)&&(N(e),-1<G&&clearTimeout(G),e=setTimeout(()=>{N(null)},1e4),Y(e),t.scrollIntoView({behavior:"smooth",block:"center"}))},handleReplyTo:e=>{var t=e?.target.getAttribute("logid")?e.target:e.target.parentElement,t=e?.target.getAttribute("logid")?e.target:e.target.parentElement;if(console.log(e),t.getAttribute("logid")&&t.getAttribute("username")&&t.getAttribute("author")){const n=t.getAttribute("logid");e=t.getAttribute("username"),t=t.getAttribute("author");if(n&&e&&t){T(n),A(e);t=s.find(e=>e.id===n);if(t?.content&&t?.username){const r=[];r.push({id:n,username:t.username,content:t.content,replyLogid:t.replyLogid??null,avatar:t?.avatar??null});for(let t=0;t<3;t++)if(r[t]?.replyLogid){var a=s.find(e=>e.id===r[t]?.replyLogid);if(!a)break;r.push({id:a.id,username:a.username,content:a.content,replyLogid:a.replyLogid??null,avatar:a?.avatar??null})}V(r)}}}},highlightedChat:X})),React.createElement("div",{className:`${ChatStyles.chatInputContainer} ${r.chatState?null:""+ChatStyles.forceHideChat} Chat_ChatInputContainer`},React.createElement("div",{className:ChatStyles.chatInputInternalContainer+" Chat_ChatInputInternalContainer"},p?React.createElement("div",{className:ChatStyles.chatWarningContainer+" Chat_ChatWarningContainer"},React.createElement("div",{className:ChatStyles.warningText+" Chat_WarningText"},p?"Timed Out":""),C?.length?React.createElement("div",{className:""+ChatStyles.warningBody,style:{fontSize:".85rem"}},"You have sent ",C.length," recent chats"):null):null,React.createElement(DonateBar,r),f&&S?React.createElement("div",null,L&&Array.isArray(L)&&0<L.length?React.createElement("div",{className:ChatStyles.replyToRepliesContainer+" Chat_ReplyToRepliesContainer",style:{top:`-${4<L.length?4+k:L.length+k}rem`}},React.createElement("div",{className:ChatStyles.threadLabel+" Chat_ThreadLabel"},"Thread"),React.createElement("div",{className:""+ChatStyles.chatLogContainer},L.slice(0).reverse().map((e,t)=>t<4?React.createElement("div",{className:`${ChatStyles.replyToRepliesThread} ${ChatStyles.chatLogMain} Chat_ReplyToRepliesThread`,style:{display:"flex",gap:".25rem"},key:t,index:t},e?.avatar?React.createElement("div",{className:ChatStyles.chatMessageAvatarContainer+" Chat_ChatMessageAvatarContainer"},React.createElement("img",{src:e.avatar})):null,React.createElement("div",{className:"Chat_ReplyToRepliesUsername"},React.createElement("b",null,e.username??"")),React.createElement("div",{className:"Chat_ReplyToRepliesContent"},e.content??"")):null))):null):null,f&&S?React.createElement("div",{className:ChatStyles.replyToContainer+" Chat_ReplyToContainer",replytoid:f},React.createElement("div",{className:"Chat_ReplyingToUsername"},"Replying to ",React.createElement("b",null,"@",S)),React.createElement(Tooltip,{title:"Cancel Reply",placement:"top"},React.createElement("div",{className:""+ChatStyles.chatCancelReplyTo},React.createElement(Close,{onClick:e=>{T(null),A(null)},sx:{height:"17.5px"}})))):null,React.createElement("div",{className:ChatStyles.chatInputSendContainer+" Chat_ChatInputSendContainer"},React.createElement(TextareaAutosize,{className:`${ChatStyles.textChatInput} ${ChatStyles.highlightBorder} Chat_TextChatInput`,ref:O,onKeyPress:e=>{handleKeyPressChat(e,ne)},onChange:e=>{},disabled:u||!c}),React.createElement("button",{className:`${ChatStyles.send} ${ChatStyles.highlightBorder} Chat_Send`,onClick:ne,disabled:m||$},"Send")))))};export default Module;