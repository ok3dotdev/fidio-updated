function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,o=arguments[t];for(a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e}).apply(this,arguments)}import React from"react";import ChatStyles from"./Chat.module.scss";import apiReq from"/modules/utility/api/apiReq";import{resolveRegionBasedPrice}from"/modules/utility/ecommerce";import ChatPrompts from"./ChatPrompts";import ChatCommandBar from"/layout/chat/ChatCommandBar";const DEFAULT_PROMPT_STATE={message:"",value:null,amount:"",highlight:"",showing:!1},DEFAULT_POST_FETCH_STATUS={state:"",showing:!1},DEFAULT_FETCH_STATUS={state:""},Module=s=>{const[c,T]=React.useState(!1),[t,l]=React.useState(DEFAULT_FETCH_STATUS),[a,u]=React.useState(DEFAULT_POST_FETCH_STATUS),[m,d]=React.useState(DEFAULT_PROMPT_STATE),g=React.useRef(),h=React.useRef(),_=resolveRegionBasedPrice(s),S=async()=>{let t;try{var a,o,r,n,i;console.log(m),0<m?.value&&!c&&s?.watchMeta?.donateTo&&(t=setTimeout(()=>{T(!1),l({state:""})},35e3),T(!0),l({state:"Sending Donation"}),a=m?.donateTo??s?.watchMeta?.donateTo,o=m?.value,r=m?.offer??s?.offer,n=m?.forLive??s?.watchMeta?.id,console.log(a,o,_),a&&o&&(i=await apiReq("/ecommerce/donate",{identifier:s._loggedIn.identifier,hash:s._loggedIn.hash,donateTo:a,amount:o,offer:r,location:_,options:{extra:{type:s?.regionsData[_.code].payment},forLive:n}}))&&"success"===i.status?(clearTimeout(t),T(!1),u({state:`${_?.symbol??""}${i.data?.totals?.total} ${i.data?.currency} donated to `+(i.data?.meta?.donateToUser??""),header:"Donation sent",href:`https://${s?.domainUrl}/r?o=`+i.data.id,message:"View receipt here",showing:!0}),d(DEFAULT_PROMPT_STATE),setTimeout(()=>{u(DEFAULT_POST_FETCH_STATUS)},1e4),l(DEFAULT_FETCH_STATUS),console.log(i),i?.data?.donation&&e?.currentTarget?.getAttribute("action")&&fireGlobalEvent({action:"donate_complete",donateTo:a,amount:o,offer:r},s._LocalEventEmitter)):(clearTimeout(t),T(!1),l(DEFAULT_FETCH_STATUS)))}catch(e){console.log(e),t&&(clearTimeout(t),T(!1),l(DEFAULT_FETCH_STATUS))}};var o=React.useCallback(e=>{var t,a,o,r,n,i;s?._loggedIn?s?._validCc?(n="customDonate"===e?.currentTarget?.getAttribute("modif")?g?.current?.value:e?.currentTarget?.getAttribute("value")??e?.currentTarget?.value,i=_?.symbol+` ${n} `+_?.currency,t=" to "+(s?.watchMeta?.authorData?.username??"User"),a=s?.watchMeta?.donateTo,o=s?.offer,r=s?.watchMeta?.id,d({header:"Send Donation",message:"Confirm Donation of",value:Number(n),amount:i,highlight:t,showing:!0,confirm:S,donateTo:a,offer:o,forLive:r})):(s._toggleSingleOpenMenu(e,"cart",!0),d({header:"Valid Credit Card required",message:"Please add a Credit Card to send a donation",showing:!0}),h?.current&&clearTimeout(h.current),n=setTimeout(()=>{d(DEFAULT_PROMPT_STATE),h.current=null},5e3),h.current=n):(s._LocalEventEmitter.dispatch("attemptInitializeGoogle",{}),e&&s?._toggleSingleOpenMenu&&s._toggleSingleOpenMenu(e,"main_settings"),d({header:"Sign In",message:"Please register or sign in to send a donation",showing:!0}),h?.current&&clearTimeout(h.current),i=setTimeout(()=>{d(DEFAULT_PROMPT_STATE),h.current=null},5e3),h.current=i)}),r=React.useCallback(e=>{d(DEFAULT_PROMPT_STATE),u(DEFAULT_POST_FETCH_STATUS)});return React.createElement("div",{className:ChatStyles.chatActionBar+" Chat_chatActionBar",style:{background:"#161616"}},React.createElement(ChatPrompts,_extends({},s,{prompt:m,postFetchStatus:a,fetchStatus:t,fetchBusy:c,handlePromptClose:r,handleFireDonate:S})),React.createElement(ChatCommandBar,_extends({},s,{promptDonate:o,customDonate:g})))};export default Module;