function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,o=arguments[t];for(a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e}).apply(this,arguments)}import React from"react";import ChatStyles from"./Chat.module.scss";import{CreditCard}from"/modules/payment";import apiReq from"/modules/utility/api/apiReq";import{resolveRegionBasedPrice}from"/modules/utility/ecommerce";import ChatPrompts from"./ChatPrompts";import ChatCommandBar from"/layout/chat/ChatCommandBar";const DEFAULT_PROMPT_STATE={message:"",value:null,amount:"",highlight:"",showing:!1},DEFAULT_POST_FETCH_STATUS={state:"",showing:!1},DEFAULT_FETCH_STATUS={state:""},Module=c=>{const[s,l]=React.useState(!1),[t,T]=React.useState(DEFAULT_FETCH_STATUS),[a,d]=React.useState(DEFAULT_POST_FETCH_STATUS),[u,m]=React.useState(DEFAULT_PROMPT_STATE),h=React.useRef(),_=React.useRef(),g=resolveRegionBasedPrice(c),E=async()=>{let t;try{var a,o,r,n,i;console.log(u),0<u?.value&&!s&&c?.watchMeta?.donateTo&&(t=setTimeout(()=>{l(!1),T({state:""})},35e3),l(!0),T({state:"Sending Donation"}),a=u?.donateTo??c?.watchMeta?.donateTo,o=u?.value,r=u?.offer??c?.offer,n=u?.forLive??c?.watchMeta?.id,console.log(a,o,g),a&&o&&(i=await apiReq("/ecommerce/donate",{identifier:c._loggedIn.identifier,hash:c._loggedIn.hash,donateTo:a,amount:o,offer:r,location:g,options:{extra:{type:c?.regionsData[g.code].payment},forLive:n}}))&&"success"===i.status?(clearTimeout(t),l(!1),d({state:`${g?.symbol??""}${i.data?.totals?.total} ${i.data?.currency} donated to `+(i.data?.meta?.donateToUser??""),header:"Donation sent",href:`https://${c?.domainUrl}/r?o=`+i.data.id,message:"View receipt here",showing:!0}),m(DEFAULT_PROMPT_STATE),setTimeout(()=>{d(DEFAULT_POST_FETCH_STATUS)},1e4),T(DEFAULT_FETCH_STATUS),console.log(i),i?.data?.donation&&e?.currentTarget?.getAttribute("action")&&fireGlobalEvent({action:"donate_complete",donateTo:a,amount:o,offer:r},c._LocalEventEmitter)):(clearTimeout(t),l(!1),T(DEFAULT_FETCH_STATUS)))}catch(e){console.log(e),t&&(clearTimeout(t),l(!1),T(DEFAULT_FETCH_STATUS))}};React.useEffect(()=>{c._validCc&&u?.header?.match("Credit Card required")&&m(DEFAULT_PROMPT_STATE)},[c._validCc]);var o=React.useCallback(e=>{var t,a,o,r,n,i;c?._loggedIn?c?._validCc?(n="customDonate"===e?.currentTarget?.getAttribute("modif")?h?.current?.value:e?.currentTarget?.getAttribute("value")??e?.currentTarget?.value,i=g?.symbol+` ${n} `+g?.currency,t=" to "+(c?.watchMeta?.authorData?.username??"User"),a=c?.watchMeta?.donateTo,o=c?.offer,r=c?.watchMeta?.id,m({header:"Send Donation",message:"Confirm Donation of",value:Number(n),amount:i,highlight:t,showing:!0,confirm:E,donateTo:a,offer:o,forLive:r})):(c._toggleSingleOpenMenu(e,"cart",!0),m({header:"Valid Credit Card required",message:"Please add a Credit Card to send a donation",showing:!0}),_?.current&&clearTimeout(_.current),n=setTimeout(()=>{m(DEFAULT_PROMPT_STATE),_.current=null},5e3),_.current=n):(c._LocalEventEmitter.dispatch("attemptInitializeGoogle",{}),e&&c?._toggleSingleOpenMenu&&c._toggleSingleOpenMenu(e,"main_settings"),m({header:"Sign In",message:"Please register or sign in to send a donation",showing:!0}),_?.current&&clearTimeout(_.current),i=setTimeout(()=>{m(DEFAULT_PROMPT_STATE),_.current=null},5e3),_.current=i)}),r=React.useCallback(e=>{m(DEFAULT_PROMPT_STATE),d(DEFAULT_POST_FETCH_STATUS)});return React.createElement("div",{className:ChatStyles.chatActionBar+" Chat_chatActionBar",style:{background:"#161616"}},c?._validCc?null:React.createElement("div",{style:{display:"none"}},React.createElement(CreditCard,c)),React.createElement(ChatPrompts,_extends({},c,{prompt:u,postFetchStatus:a,fetchStatus:t,fetchBusy:s,handlePromptClose:r,handleFireDonate:E})),React.createElement(ChatCommandBar,_extends({},c,{promptDonate:o,customDonate:h})))};export default Module;