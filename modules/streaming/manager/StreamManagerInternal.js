function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,r=arguments[t];for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}import React from"react";import{beginStream,endStream,updateStreamConfigRequest,requestStreamingPermissions}from"../../utility/streaming";import{checkSignedIn,logout}from"../../utility/onboarding/SignIn";import{v4 as uuidv4}from"uuid";import ManagerStyles from"./Manager.module.scss";import StreamManager from"/layout/StreamManager";const generateBackground=(e={})=>{var t=e?.palette??["#39e662","#71d1ff","#f371ff","#ee5252","#9a74ff","#4defc9"],a=Math.floor(Math.random()*t.length);let r=0;for(;a==(r=Math.floor(Math.random()*t.length)););return`linear-gradient(${Math.floor(360*Math.random())}deg, ${t[a]} 0%, ${t[r]} 100%)`},Module=s=>{let[,t]=React.useState(null);const[a,r]=React.useState(!1),[e,D]=React.useState(null),[n,N]=React.useState(!1),[c,u]=React.useState(!1),[O,i]=React.useState(null),[B,o]=React.useState(null),[l,m]=React.useState(!1),[K,d]=React.useState(!1),[g,S]=React.useState({password:null,private:!1,dates:[],tags:[],input:[]}),[p,q]=React.useState(null),[U,f]=React.useState(null),[h,H]=React.useState([]),[v,R]=React.useState(!1),[$,y]=React.useState(!1),[J,z]=React.useState(!1),[G,k]=React.useState(!1),E=React.useRef(),[_,T]=React.useState(!0),[Q,V]=React.useState(Array.from(Array(100).keys()).map(e=>generateBackground(s))),[W,b]=React.useState(0),[C,M]=React.useState(!1),w=React.useRef(),P=React.useRef(),F=React.useRef(),L=React.useRef(),I=React.useRef(),j=React.useRef(),A=(React.useEffect(()=>{var e;a||(e=uuidv4(),D(e),r(!0))},[a]),React.useEffect(()=>{s._loggedIn&&!n&&(N(!0),A(!0))},[s._loggedIn,n,p,C]),console.log("Record Sstream",C),async(e=!1,t=!1)=>{try{var a,r,n;l||(m(!0),d(!0),E.current=setTimeout(()=>{m(!1),d(!1)},1e4),a={stripeSecret:s._stripeSecret,dontForce:e,streamSettings:g,streamingFor:p?.id??null,record:C},r=await beginStream(s.apiUrl,s.domainKey,a,checkSignedIn),E.current&&clearTimeout(E.current),r?"disauthenticated"==r?(s._setLoggedIn(!1),s._setStripeSecret(!1),m(!1),d(!1),logout()):"success"==r.status&&(m(!1),d(!1),z(r.canStream),r.askStream&&k(!0),r.upcomingEvents&&(H(r.upcomingEvents),V(r.upcomingEvents.map(e=>generateBackground(s)))),r?.data?.streamForProduct?f(r.data.streamForProduct):f(null),t?s._LocalEventEmitter&&s._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):r.data&&"streaming"==r.data.status&&r.data.stream&&(u(r.data.stream),s?._setCurrentlyStreaming&&s._setCurrentlyStreaming(r.data.stream),X(r.data.stream),r.data.key&&i(r.data.key),r.data.streamTo&&o(r.data.streamTo+"/443/app/"),r.data.stream.meta&&r.data.stream.meta.streamSettings&&(n=r.data.stream.meta.streamSettings,S(n)),s._LocalEventEmitter)&&s._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"})):(e?m:(s._setPageError("Failed to save begin stream"),m(!1),d))(!1))}catch(e){console.log(e),E.current&&clearTimeout(E.current),m(!1),d(!1)}}),X=e=>{try{e&&(F.current.value=e.title,L.current.value=e.description,I.current.value=e.tags)}catch(e){}};var Y=React.useCallback(e=>{e?.currentTarget?.checked?M(!0):M(!1)}),Z=React.useCallback(e=>{A()},[p,C]);React.useEffect(()=>{g&&ee(g)},[e,s._LocalEventEmitter,s.adminPanelState,g]);const ee=e=>{e=e||g;w.current&&(w.current.checked=e.private),P.current&&(P.current.value=e.password)};var te=React.useCallback(e=>{t(null)}),ae=React.useCallback(e=>{var t={...g};t.private=e.currentTarget.checked,S(t)}),re=React.useCallback(e=>{var t={...g};t.password=e.currentTarget.value,S(t)}),ne=React.useCallback(e=>{if(e.currentTarget.getAttribute("modif"))if("yes"==e.currentTarget.getAttribute("modif"))try{(async()=>{var e;l||(m(!0),E.current=setTimeout(()=>{m(!1)},1e4),e={stream:c.id},e=await endStream(s.apiUrl,s.domainKey,e,checkSignedIn),E.current&&clearTimeout(E.current),e?"disauthenticated"==e?(R(!1),s._setLoggedIn(!1),s._setStripeSecret(!1),m(!1),logout()):"success"==e.status&&(R(!1),m(!1),u(!1),s?._setCurrentlyStreaming&&s._setCurrentlyStreaming(!1),i(null),o(null),S({password:null,private:!1,dates:[],tags:[],input:[]}),A(!0),s._LocalEventEmitter)&&s._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):(R(!1),s._setPageError("Failed to end stream"),m(!1)))})()}catch(e){R(!1),E.current&&clearTimeout(E.current),m(!1)}else R(!1);else v||R(!0)});var se=React.useCallback(e=>{if(_)b("0px"),T(!1);else{T(!0);try{var t=j.current.children[0].clientHeight+(j.current.children[0].marginTop??0)+(j.current.children[0].marginBottom??0);b(t+"px")}catch(e){}}}),ce=React.useCallback(e=>{const t=e?.currentTarget?.getAttribute("modif")??null;var a;t&&(e=h.find(e=>e.id===t))&&((a=JSON.parse(JSON.stringify(g))).private=!0,S(a),w.current.checked=!0,q(e),e={title:e?.name,description:e?.detailmeta?.description},S(Object.assign(a,e)))}),ue=React.useCallback(e=>{var t,a=e?.currentTarget?.getAttribute("modif")??"";a&&((t=g)[a]=e.currentTarget.value,S(t))});const x=e=>{F?.current&&e.title&&(F.current.value=e?.title),L?.current&&e?.description&&(L.current.value=e.description),I?.current&&(e?.input?.join&&0<e.input.length?I.current.value=e.input.join(" "):e?.tags?.join&&e.dates?.join&&(I.current.value=e.tags.join(" ")+" "+e.dates.join(" ")),e.streamForProduct)&&!I?.current?.value.match(e.streamForProduct)&&(I.current.value+=" "+e.streamForProduct),P?.current&&e.password&&(P.current.value=e.password),_&&j?.current?.children&&(e=j.current.children[0].clientHeight+(j.current.children[0].marginTop??0)+(j.current.children[0].marginBottom??0),b(e+"px"))};return React.useMemo(()=>{x(g)},[g,F?.current,L?.current,I?.current,l]),React.createElement("div",{className:ManagerStyles.container+" "+s.className},React.createElement(StreamManager,_extends({},s,{backgrounds:Q,beginStreaming:Z,fetchBusy:l,currentlyStreaming:c,ongoingStreamFor:U,streamChecking:K,streamingFor:p,canStream:J,titleRef:F,descriptionRef:L,myTagsRef:I,updateStreamData:ue,streamSettings:g,moreSettings:_,settingsHeight:W,moreSettingsContainerRef:j,openMoreSettings:se,updateTags:e=>{if(e){var t={...g},e=e.currentTarget.value.split(" ");const a=[],r=[];e.map(e=>{isNaN(new Date(e))?r.push(e):a.push(new Date(e))}),t.dates=a,t.tags=r,t.input=e,S(t)}},setPrivate:ae,privateRef:w,upcomingStreams:h,setNextStream:ce,askEndStream:v,updatingStreamConfig:$,handleAskEndStream:ne,streamTo:B,streamKey:O,setPassword:re,passwordRef:P,checkStream:A,updateStreamConfigFn:async()=>{try{if(!l){m(!0),y(!0),E.current=setTimeout(()=>{m(!1),y(!1)},1e4);var e={title:F.current&&F.current.value?F.current.value:null,description:L.current&&L.current.value?L.current.value:null,tags:I.current&&I.current.value?I.current.value:null},t={stream:c.id,streamData:e,streamSettings:g},a=await updateStreamConfigRequest(s.apiUrl,s.domainKey,t,checkSignedIn);if(E.current&&clearTimeout(E.current),a){if("disauthenticated"==a)s._setLoggedIn(!1),s._setStripeSecret(!1),m(!1),y(!1),logout();else if("success"==a.status&&(m(!1),y(!1),a.data)&&"streaming"==a.data.status&&(u(a.data.stream),s?._setCurrentlyStreaming&&s._setCurrentlyStreaming(a.data.stream),a.data.key&&i(a.data.key),a.data.streamTo&&o(a.data.streamTo),a.data.stream)&&a.data.stream.meta&&a.data.stream.meta.streamSettings){const r=a.data.stream.meta.streamSettings;S(r),setTimeout(()=>{x(r)},150)}}else s._setPageError("Failed to save begin stream"),m(!1),y(!1)}}catch(e){console.log(e),E.current&&clearTimeout(E.current),m(!1),y(!1)}},handleClearError:te,handleAskForStreamingPermissions:()=>{try{(async()=>{var e;l||(m(!0),E.current=setTimeout(()=>{m(!1)},1e4),e=await requestStreamingPermissions(s.apiUrl,s.domainKey,checkSignedIn),E.current&&clearTimeout(E.current),e?"disauthenticated"==e?(R(!1),s._setLoggedIn(!1),s._setStripeSecret(!1),m(!1),logout()):"success"==e.status&&(R(!1),m(!1),e?.data?.created&&k(!0),s._LocalEventEmitter)&&s._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):(R(!1),m(!1)))})()}catch(e){E.current&&clearTimeout(E.current),m(!1)}},ManagerStyles:ManagerStyles,didCheckStream:n,didAskStream:G,recordStream:C,handleSetRecordingStream:Y})))};export default Module;