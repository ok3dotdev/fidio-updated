function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,r=arguments[t];for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}import React from"react";import{beginStream,endStream,updateStreamConfigRequest,requestStreamingPermissions}from"../../utility/streaming";import{checkSignedIn,logout}from"../../utility/onboarding/SignIn";import{v4 as uuidv4}from"uuid";import ManagerStyles from"./Manager.module.scss";import StreamManager from"/layout/StreamManager";const generateBackground=(e={})=>{var t=e?.palette??["#39e662","#71d1ff","#f371ff","#ee5252","#9a74ff","#4defc9"],a=Math.floor(Math.random()*t.length);let r=0;for(;a==(r=Math.floor(Math.random()*t.length)););e=Math.floor(360*Math.random());return console.log(t[a],t[r],e),`linear-gradient(${e}deg, ${t[a]} 0%, ${t[r]} 100%)`},Module=n=>{let[,t]=React.useState(null);const[a,r]=React.useState(!1),[e,s]=React.useState(null),[c,u]=React.useState(!1),[i,o]=React.useState(!1),[D,l]=React.useState(null),[N,m]=React.useState(null),[d,g]=React.useState(!1),[O,S]=React.useState(!1),[p,f]=React.useState({password:null,private:!1,dates:[],tags:[],input:[]}),[h,B]=React.useState(null),[v,R]=React.useState(null),[y,K]=React.useState([]),[k,E]=React.useState(!1),[q,_]=React.useState(!1),[U,H]=React.useState(!1),[$,T]=React.useState(!1),b=React.useRef(),[C,M]=React.useState(!1),[J,z]=React.useState(Array.from(Array(100).keys()).map(e=>generateBackground(n))),[G,w]=React.useState(0),P=React.useRef(),F=React.useRef(),L=React.useRef(),I=React.useRef(),j=React.useRef(),A=React.useRef(),x=(n._LocalEventEmitter.unsubscribe("manager"),n._LocalEventEmitter.subscribe("manager",e=>{e&&e.dispatch&&"setMenu"===e.dispatch&&"stream"===e?.menu&&setOpenMenu("stream")}),React.useEffect(()=>{var e;a||(e=uuidv4(),s(e),r(!0))},[a]),React.useEffect(()=>{n._loggedIn&&!c&&(u(!0),x(!0))},[n._loggedIn,c,h]),async(e=!1)=>{try{var t,a,r;d||(g(!0),S(!0),b.current=setTimeout(()=>{g(!1),S(!1)},1e4),t={stripeSecret:n._stripeSecret,dontForce:e,streamSettings:p,streamingFor:h?.id??null},a=await beginStream(n.apiUrl,n.domainKey,t,checkSignedIn),b.current&&clearTimeout(b.current),console.log("Stream",a),a?"disauthenticated"==a?(n._setLoggedIn(!1),n._setStripeSecret(!1),g(!1),S(!1),logout()):"success"==a.status&&(g(!1),S(!1),console.log("check stream",a),H(a.canStream),a.askStream&&T(!0),a.upcomingEvents&&(K(a.upcomingEvents),z(a.upcomingEvents.map(e=>generateBackground(n)))),a?.data?.streamForProduct?R(a.data.streamForProduct):R(null),a.data)&&"streaming"==a.data.status&&a.data.stream&&(o(a.data.stream),n?._setCurrentlyStreaming&&n._setCurrentlyStreaming(a.data.stream),Q(a.data.stream),a.data.key&&l(a.data.key),a.data.streamTo&&m(a.data.streamTo),a.data.stream.meta&&a.data.stream.meta.streamSettings&&(r=a.data.stream.meta.streamSettings,f(r)),n._LocalEventEmitter)&&n._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):(e?g:(n._setPageError("Failed to save begin stream"),g(!1),S))(!1))}catch(e){console.log(e),b.current&&clearTimeout(b.current),g(!1),S(!1)}}),Q=e=>{try{e&&(L.current.value=e.title,I.current.value=e.description,j.current.value=e.tags)}catch(e){}};var V=React.useCallback(e=>{x()});React.useEffect(()=>{p&&W(p)},[e,n._LocalEventEmitter,n.adminPanelState,p]);const W=e=>{e=e||p;P.current&&(P.current.checked=e.private),F.current&&(F.current.value=e.password)};var X=React.useCallback(e=>{t(null)}),Y=React.useCallback(e=>{var t={...p};t.private=e.currentTarget.checked,f(t)}),Z=React.useCallback(e=>{var t={...p};t.password=e.currentTarget.value,f(t)}),ee=React.useCallback(e=>{if(e.currentTarget.getAttribute("modif"))if("yes"==e.currentTarget.getAttribute("modif"))try{(async()=>{var e;console.log("end st",d),d||(g(!0),b.current=setTimeout(()=>{g(!1)},1e4),e={stream:i.id},e=await endStream(n.apiUrl,n.domainKey,e,checkSignedIn),b.current&&clearTimeout(b.current),e?"disauthenticated"==e?(E(!1),n._setLoggedIn(!1),n._setStripeSecret(!1),g(!1),logout()):"success"==e.status&&(E(!1),g(!1),o(!1),n?._setCurrentlyStreaming&&n._setCurrentlyStreaming(!1),l(null),m(null),f({password:null,private:!1,dates:[],tags:[],input:[]}),x(!0),n._LocalEventEmitter)&&n._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):(E(!1),n._setPageError("Failed to end stream"),g(!1)))})()}catch(e){E(!1),b.current&&clearTimeout(b.current),g(!1)}else E(!1);else k||E(!0)});var te=React.useCallback(e=>{if(C)w("0px"),M(!1);else{M(!0);try{var t=A.current.children[0].clientHeight+(A.current.children[0].marginTop??0)+(A.current.children[0].marginBottom??0);w(t+"px")}catch(e){}}}),ae=React.useCallback(e=>{const t=e?.currentTarget?.getAttribute("modif")??null;var a;t&&(e=y.find(e=>e.id===t))&&((a=JSON.parse(JSON.stringify(p))).private=!0,f(a),P.current.checked=!0,B(e))}),re=React.useCallback(e=>{var t,a=e?.currentTarget?.getAttribute("modif")??"";a&&((t=p)[a]=e.currentTarget.value,console.log(t,a),f(t))});return React.useMemo(()=>{var e=p;console.log(L,e),L?.current&&e.title&&(L.current.value=e?.title),I?.current&&e?.description&&(I.current.value=e.description),j?.current&&(e?.input?.join&&0<e.input.length?j.current.value=e.input.join(" "):e?.tags?.join&&e.dates?.join&&(j.current.value=e.tags.join(" ")+" "+e.dates.join(" ")),e.streamForProduct)&&!j?.current?.value.match(e.streamForProduct)&&(j.current.value+=" "+e.streamForProduct),F?.current&&e.password&&(F.current.value=e.password),C&&A?.current?.children&&(e=A.current.children[0].clientHeight+(A.current.children[0].marginTop??0)+(A.current.children[0].marginBottom??0),w(e+"px"))},[p,L?.current,I?.current,j?.current,d]),console.log(v,p,i),React.createElement("div",{className:ManagerStyles.container+" "+n.className},React.createElement(StreamManager,_extends({},n,{backgrounds:J,beginSreaming:V,fetchBusy:d,currentlyStreaming:i,ongoingStreamFor:v,streamChecking:O,streamingFor:h,canStream:U,titleRef:L,descriptionRef:I,myTagsRef:j,updateStreamData:re,streamSettings:p,moreSettings:C,settingsHeight:G,moreSettingsContainerRef:A,openMoreSettings:te,updateTags:e=>{if(e){var t={...p},e=(console.log(p),e.currentTarget.value.split(" "));const a=[],r=[];e.map(e=>{isNaN(new Date(e))?r.push(e):a.push(new Date(e))}),t.dates=a,t.tags=r,t.input=e,f(t)}},setPrivate:Y,privateRef:P,upcomingStreams:y,setNextStream:ae,askEndStream:k,updatingStreamConfig:q,handleAskEndStream:ee,streamTo:N,streamKey:D,setPassword:Z,passwordRef:F,checkStream:x,updateStreamConfigFn:async()=>{try{var e,t,a,r;d||(g(!0),_(!0),b.current=setTimeout(()=>{g(!1),_(!1)},1e4),e={title:L.current&&L.current.value?L.current.value:null,description:I.current&&I.current.value?I.current.value:null,tags:j.current&&j.current.value?j.current.value:null},t={stream:i.id,streamData:e,streamSettings:p},a=await updateStreamConfigRequest(n.apiUrl,n.domainKey,t,checkSignedIn),b.current&&clearTimeout(b.current),a?"disauthenticated"==a?(n._setLoggedIn(!1),n._setStripeSecret(!1),g(!1),_(!1),logout()):"success"==a.status&&(console.log("check stream",a),g(!1),_(!1),a.data)&&"streaming"==a.data.status&&(o(a.data.stream),n?._setCurrentlyStreaming&&n._setCurrentlyStreaming(a.data.stream),a.data.key&&l(a.data.key),a.data.streamTo&&m(a.data.streamTo),a.data.stream)&&a.data.stream.meta&&a.data.stream.meta.streamSettings&&(r=a.data.stream.meta.streamSettings,f(r)):(n._setPageError("Failed to save begin stream"),g(!1),_(!1)))}catch(e){console.log(e),b.current&&clearTimeout(b.current),g(!1),_(!1)}},handleClearError:X,handleAskForStreamingPermissions:()=>{try{(async()=>{var e;d||(g(!0),b.current=setTimeout(()=>{g(!1)},1e4),e=await requestStreamingPermissions(n.apiUrl,n.domainKey,checkSignedIn),b.current&&clearTimeout(b.current),e?"disauthenticated"==e?(E(!1),n._setLoggedIn(!1),n._setStripeSecret(!1),g(!1),logout()):"success"==e.status&&(E(!1),g(!1),e?.data?.created&&T(!0),n._LocalEventEmitter)&&n._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):(E(!1),g(!1)))})()}catch(e){b.current&&clearTimeout(b.current),g(!1)}},ManagerStyles:ManagerStyles,didCheckStream:c,didAskStream:$})))};export default Module;