import React from"react";import{Elements,CardElement,ElementsConsumer}from"@stripe/react-stripe-js";import{loadStripe}from"@stripe/stripe-js";import{getStripeSecretData,saveCreditCardInfo}from"../utility/payment/index";import{checkSignedIn,checkSignedInAndPrompt,logout}from"../utility/onboarding/SignIn";const DEFAULT_SOLUTION={payment:"stripe"},Module=i=>{const r=React.useRef(),[e,t]=React.useState(!1),[a,n]=React.useState(!1),[c,l]=React.useState(!1),[s,o]=React.useState(!1),[m,d]=React.useState(null),[p,u]=React.useState(!1),[g,S]=React.useState(!1),[y,_]=React.useState(DEFAULT_SOLUTION),f=React.useRef(),E=(React.useEffect(()=>{e||(i.setSolution&&i.setSolution(y),i.stagger&&(f.current=setTimeout(()=>{n(!0)},i.stagger)),t(!0))},[e,i.stagger,y]),React.useEffect(()=>{var e;i?._loggedIn?.meta?.location&&i?.regionsData&&i.regionsData[i._loggedIn.meta.location]&&((e=i.regionsData[i._loggedIn.meta.location]).payment!==y.payment||!y||y&&!y.payment)&&(_(e),i.setSolution&&i.setSolution(e),i.setShowContent)&&i.setShowContent(-1<["stripe"].indexOf(e.payment))},[i._loggedIn,i.regionsData,y,i.setSolution]),React.useEffect(()=>{var e;console.log(i.useAdmin,i.paymentConfig),i?.useAdmin?(e=loadStripe(i.useAdmin))&&d(e):i?.paymentConfig?.keys?.stripe&&!m&&(e=loadStripe(i.paymentConfig.keys.stripe))&&d(e)},[i?.paymentConfig?.keys?.stripe,i.useAdmin]),React.useEffect(()=>{!async function(){if("stripe"===y.payment&&!c&&i._loggedIn&&!s&&!i._stripeSecret)try{o(!0);var e=await getStripeSecretData(i.apiUrl,i.domainKey,i._loggedIn,{useAdmin:i?.useAdmin});if(!(e&&e.client_secret&&e.card))throw new Error;i._setStripeSecret(e),o(!1)}catch(e){console.log(e),o(!1)}}()},[i._loggedIn,i._stripeSecret,y,i.useAdmin]),React.useEffect(()=>{E(i._stripeSecret)},[i._stripeSecret]),e=>{e?.card?.data&&e.card.data[0]&&e.card.data[0]?.card&&e.card.data[0]?.billing_details&&e.card.data[0].card?.last4&&e.card.data[0].card?.exp_month&&e.card.data[0].card?.exp_year&&l({name:e.card.data[0].billing_details.name||null,last4:e.card.data[0].card.last4,exp_month:e.card.data[0].card.exp_month,exp_year:(t=>{try{var e=t.toString();if(4===e.length)return e.substring(2,4);throw new Error}catch(e){return t}})(e.card.data[0].card.exp_year)})});i.setValidCc&&i.validCc!==c&&i.setValidCc(c),React.useEffect(()=>{(i?._stripeSecret.adminSecret&&i.validCc&&!i.useAdmin||i.useAdmin&&i?._stripeSecret&&!i._stripeSecret.adminSecret)&&(l(!1),i._setStripeSecret(!1))},[i?._stripeSecret,i?.useAdmin,i?.validCc]);var R=React.useCallback(e=>{if(p)return u(!1),1;u(!0)});return console.log("CC",y,i._stripeSecret),React.createElement("div",{className:""+i.className,style:i.sx},React.createElement("div",{className:g?"fetchNotBusy fetchBusy":"fetchNotBusy"}),i.useAdmin?React.createElement("div",{style:{background:"#353535"}},"Payments to Tycoon Systems Corp."):null,!i.stagger||i.stagger&&a?React.createElement(React.Fragment,null,"stripe"===y?.payment?c&&!p?React.createElement("div",null,React.createElement("div",{className:"Ecommerce_CreditCard_Container",style:{padding:".125rem"}},i.purchaseDescription?React.createElement("span",null,i.purchaseDescription):null,React.createElement("div",{className:"Ecommerce_CreditCard_Container_Meta"},React.createElement("div",null,React.createElement("p",{style:{marginBottom:"0.1rem",paddingBottom:"0rem",margin:0}},"Ending in ",React.createElement("span",null,c.last4)),React.createElement("p",{style:{marginBottom:"0.1rem",paddingBottom:"0rem",margin:0}},"Expiry ",React.createElement("span",null,c.exp_month," / ",c.exp_year))),c.name?React.createElement("p",{style:{marginTop:0,margin:0}},c.name):null))):i._stripeSecret&&i._stripeSecret.client_secret?React.createElement(Elements,{stripe:m,options:{clientSecret:i._stripeSecret.client_secret}},React.createElement(ElementsConsumer,null,({elements:t,stripe:a})=>React.createElement("form",{onSubmit:e=>{(async(e,t,a,r)=>{try{var n,c;e.preventDefault(),console.log(e,t,a,r),g||(S(!0),setTimeout(()=>{S(!1)},15e3),checkSignedInAndPrompt()&&(r&&r.current&&r.current.value?((n={fullName:"",result:null,stripeSecret:i._stripeSecret}).fullName=r.current.value,n.result=await a.confirmCardSetup(i._stripeSecret.client_secret,{payment_method:{card:t.getElement(CardElement),billing_details:{name:n.fullName}}}),console.log("Stripe Payment",n,i),(c=await saveCreditCardInfo(i.apiUrl,i.domainKey,n,checkSignedIn,{useAdmin:i?.useAdmin}))?"disauthenticated"==c?(i._setLoggedIn(!1),i._setStripeSecret(!1),logout(),S(!1)):"success"==c.status&&c.newSecret&&(u(!1),i._setStripeSecret(c.newSecret),S(!1)):(i._setPageError("Failed to save Credit Card"),S(!1))):(i._setPageError("Please type in your Full Name as it appears on your Credit Card"),S(!1))))}catch(e){console.log(e),S(!1)}})(e,t,a,r)},style:{display:"grid",gap:".125rem"}},React.createElement("input",{type:"text",placeholder:"Full Name on Card",ref:r}),React.createElement(CardElement,{options:{iconStyle:"solid",style:{base:{fontSize:"16px",color:"black",fontWeight:500,"::placeholder":{color:"grey"},fontSmoothing:"antialiased",width:"100%",backgroundColor:"white"},invalid:{color:"#9e2146"}}}}),React.createElement("button",{type:"submit"},"Save Billing Info")))):null:null,"stripe"===y?.payment&&c?React.createElement("div",{style:{display:"grid",gap:".125rem",marginTop:".125rem"}},React.createElement("button",{type:"submit",onClick:R},p?"Use Current Card":"Register New Card")):null):null,i.children)};export default Module;