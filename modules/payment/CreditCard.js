import React from"react";import{Elements,CardElement,ElementsConsumer}from"@stripe/react-stripe-js";import{loadStripe}from"@stripe/stripe-js";import{getStripeSecretData,saveCreditCardInfo}from"../utility/payment/index";import{checkSignedIn,checkSignedInAndPrompt,logout}from"../utility/onboarding/SignIn";const DEFAULT_SOLUTION={payment:"stripe"},Module=c=>{const r=React.useRef(),[e,t]=React.useState(!1),[a,n]=React.useState(!1),[i,l]=React.useState(!1),[s,o]=React.useState(!1),[m,d]=React.useState(null),[u,p]=React.useState(!1),[g,S]=React.useState(!1),[_,y]=React.useState(DEFAULT_SOLUTION),f=React.useRef(),E=(React.useEffect(()=>{e||(c._setSolution&&c._setSolution(_),c.stagger&&(f.current=setTimeout(()=>{n(!0)},c.stagger)),t(!0))},[e,c.stagger,_]),React.useCallback(e=>{var t;return"incomplete"===c?._loggedIn?.meta?.account?(t=c._loggedIn.meta).firstName+" "+t.lastName:""})),C=(React.useEffect(()=>{var e;c?._loggedIn?.meta?.location&&c?.regionsData&&c.regionsData[c._loggedIn.meta.location]&&((e=c.regionsData[c._loggedIn.meta.location]).payment!==_.payment||!_||_&&!_.payment)&&(y(e),c.setSolution&&c.setSolution(e),c.setShowContent)&&c.setShowContent(-1<["stripe"].indexOf(e.payment))},[c._loggedIn,c.regionsData,_,c.setSolution]),React.useEffect(()=>{var e;console.log(c.useAdmin,c.paymentConfig),c?.useAdmin?(e=loadStripe(c.useAdmin))&&d(e):c?.paymentConfig?.keys?.stripe&&!m&&(e=loadStripe(c.paymentConfig.keys.stripe))&&d(e)},[c?.paymentConfig?.keys?.stripe,c.useAdmin]),React.useEffect(()=>{!async function(){if("stripe"===_.payment&&!i&&c._loggedIn&&!s&&!c._stripeSecret)try{o(!0);var e=await getStripeSecretData(c.apiUrl,c.domainKey,c._loggedIn,{useAdmin:c?.useAdmin});if(!(e&&e.client_secret&&e.card))throw new Error;c._setStripeSecret(e),o(!1)}catch(e){console.log(e),o(!1)}}()},[c._loggedIn,c._stripeSecret,_,c.useAdmin]),React.useEffect(()=>{C(c._stripeSecret)},[c._stripeSecret]),e=>{e?.card?.data&&e.card.data[0]&&e.card.data[0]?.card&&e.card.data[0]?.billing_details&&e.card.data[0].card?.last4&&e.card.data[0].card?.exp_month&&e.card.data[0].card?.exp_year&&l({name:e.card.data[0].billing_details.name||null,last4:e.card.data[0].card.last4,exp_month:e.card.data[0].card.exp_month,exp_year:(t=>{try{var e=t.toString();if(4===e.length)return e.substring(2,4);throw new Error}catch(e){return t}})(e.card.data[0].card.exp_year)})});c.setValidCc&&c.validCc!==i&&c.setValidCc(i),React.useEffect(()=>{(c?._stripeSecret.adminSecret&&c.validCc&&!c.useAdmin||c.useAdmin&&c?._stripeSecret&&!c._stripeSecret.adminSecret)&&(l(!1),c._setStripeSecret(!1))},[c?._stripeSecret,c?.useAdmin,c?.validCc]);var R=React.useCallback(e=>{if(u)return p(!1),1;p(!0)});console.log("CC",_,c._stripeSecret);const h=c._loggedIn?.meta?.account?.full;return React.createElement("div",{className:""+c.className,style:c.sx},React.createElement("div",{className:g?"fetchNotBusy fetchBusy":"fetchNotBusy"}),c.useAdmin?React.createElement("div",{style:{background:"#353535"}},"Payments to Tycoon Systems Corp."):null,!c.stagger||c.stagger&&a?React.createElement(React.Fragment,null,"stripe"===_?.payment?i&&!u?React.createElement("div",null,React.createElement("div",{className:"Ecommerce_CreditCard_Container",style:{padding:".125rem"}},c.purchaseDescription?React.createElement("span",null,c.purchaseDescription):null,React.createElement("div",{className:"Ecommerce_CreditCard_Container_Meta"},React.createElement("div",null,React.createElement("p",{style:{marginBottom:"0.1rem",paddingBottom:"0rem",margin:0}},"Ending in ",React.createElement("span",null,i.last4)),React.createElement("p",{style:{marginBottom:"0.1rem",paddingBottom:"0rem",margin:0}},"Expiry ",React.createElement("span",null,i.exp_month," / ",i.exp_year))),i.name?React.createElement("p",{style:{marginTop:0,margin:0}},i.name):null))):c._stripeSecret&&c._stripeSecret.client_secret?React.createElement(Elements,{stripe:m,options:{clientSecret:c._stripeSecret.client_secret}},React.createElement(ElementsConsumer,null,({elements:t,stripe:a})=>React.createElement("form",{onSubmit:e=>{(async(e,t,a,r)=>{try{e.preventDefault();var n,i,l=document.getElementById("Ecommerce_CreditCard_FullNameInput")??r?.current;console.log(e,t,a,l),g||(S(!0),setTimeout(()=>{S(!1)},15e3),checkSignedInAndPrompt()&&(l.value?((n={fullName:"",result:null,stripeSecret:c._stripeSecret}).fullName=l.value,n.result=await a.confirmCardSetup(c._stripeSecret.client_secret,{payment_method:{card:t.getElement(CardElement),billing_details:{name:n.fullName}}}),console.log("Stripe Payment",n,c),(i=await saveCreditCardInfo(c.apiUrl,c.domainKey,n,checkSignedIn,{useAdmin:c?.useAdmin}))?"disauthenticated"==i?(c._setLoggedIn(!1),c._setStripeSecret(!1),logout(),S(!1)):"success"==i.status&&i.newSecret&&(p(!1),c._setStripeSecret(i.newSecret),S(!1),c.saveBillingInfoFunction)&&(c.setFetchBusy(!0),setTimeout(()=>{c.setFetchBusy(!1),setTimeout(()=>{c.saveBillingInfoFunction()},1)},Object.prototype.hasOwnProperty.call(c,"saveBillingInfoFunctionDelay")?c.saveBillingInfoFunctionDelay:150)):(c._setPageError("Failed to save Credit Card"),S(!1))):(c._setPageError("Please type in your Full Name as it appears on your Credit Card"),S(!1))))}catch(e){console.log(e),S(!1)}})(e,t,a,r)},style:{display:"grid",gap:".125rem"}},React.createElement("input",{className:"Ecommerce_CreditCard_FullNameInput_Default",type:"text",placeholder:"Full Name on Card",ref:r,defaultValue:E()}),React.createElement(CardElement,{options:{iconStyle:"solid",style:{base:{fontSize:"16px",color:"black",fontWeight:500,"::placeholder":{color:"grey"},fontSmoothing:"antialiased",width:"100%",backgroundColor:"white"},invalid:{color:"#9e2146"}}}}),h?React.createElement("button",{type:"submit"},c.saveBillingInfoText??"Save Billing Info"):!h&&c?._stripeSecret?.client_secret?React.createElement("button",{type:"submit",modif:"hidden_initiate_save_billing_info"},c.saveBillingInfoText??"Save Billing Info"):null))):null:null,"stripe"===_?.payment&&i?React.createElement("div",{style:{display:"grid",gap:".125rem",marginTop:".125rem"}},React.createElement("button",{type:"submit",onClick:R},u?"Use Current Card":"Register New Card")):null):null,c.children)};export default Module;