function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,s=arguments[t];for(a in s)Object.prototype.hasOwnProperty.call(s,a)&&(e[a]=s[a])}return e}).apply(this,arguments)}import React from"react";import{v4 as uuidv4}from"uuid";import apiReq from"/modules/utility/api/apiReq";import WatchPageStyles from"/modules/streaming/watch/WatchPage.module.scss";import{ReadComment}from".";import{submitPost}from"/modules/utility/utility/comment";const Module=l=>{const[e,a]=React.useState(!1),[,t]=React.useState(!1),[s,i]=React.useState(null),[n,r]=React.useState(!1),[,m]=React.useState(-1),[c,o]=React.useState(null),[d,u]=React.useState([]),[p,h]=React.useState(0),[w,f]=React.useState(null),[R,g]=React.useState(null),v=(l?.pipe&&(l._LocalEventEmitter.unsubscribe(l.pipe),l._LocalEventEmitter.subscribe(l.pipe,e=>{if(e&&"comment_published"===e.dispatch&&e?.comment){var t,a,s,c=[...d];const o=e?.comment?.meta?.opId;o?-1<(t=d.findIndex(e=>e.id===o))&&(c[t].replies||(c[t].replies=[]),(a=[...c[t].replies]).push(e.comment),(s={...c[t]}).replies=a,c[t]=s):c.unshift(e.comment),e.comment?.meta?.opId&&l._LocalEventEmitter.dispatch(e.comment.meta.opId,{dispatch:"comment_published",comment:e.comment}),u(c)}})),l._LocalEventEmitter.unsubscribe(c),l._LocalEventEmitter.subscribe(c,e=>{if(e&&"scroll_window"===e.dispatch){var t,e=document.body,a=document.documentElement,s=e?.scrollHeight??0,e=e?.offsetHeight??0,c=a?.clientHeight??0,o=a?.scrollHeight??0,a=a?.offsetHeight??0,i=window?.scrollY+window?.innerHeight,s=Math.max(s,e,c,o,a);if(!n)try{s-(window?.innerHeight<450?window.innerHeight/2:600)<i&&(null===R||R?.scrollY>window?.scrollY+50||R?.scrollY<window?.scrollY-50)&&(g({scrollX:window?.scrollX,scrollY:window?.scrollY}),t=p+25,h(t),r(!0),v(l.watchData.id,t))}catch(e){}}}),React.useEffect(()=>{if(!e){const t=uuidv4();try{window.addEventListener("scroll_window",function(e){l._LocalEventEmitter.dispatch(t,{dispatch:"scroll_window"})})}catch(e){}g({scrollX:window?.scrollX,scrollY:window?.scrollY}),o(t),a(!0)}},[e]),React.useEffect(()=>{n||l?.watchData?.id&&l.watchData.id!==s&&(r(!0),t(!0),v(l.watchData.id,p))},[l?.watchData?.id,n,s]),async(e,t,a,s)=>{try{i(e);var c,o=await apiReq("/p/getposts",{apiUrl:l?.apiUrl,id:e,offset:t,par:a,parentOffset:s});o?.data?(m((new Date).getTime()),r(!1),0<t&&!a&&!s?(c=[...d].concat(o.data),u(c)):u(o.data)):(r(!1),f({dispatch:"error",message:o?.message??"Failed to get posts"}))}catch(e){r(!1)}});var E=React.useCallback(e=>{f(null)});const b=React.useCallback((e,t,a,s,c,o)=>{console.log("Handle Post",e,t);var i=l?.commentUseParent??"",n=l?.commentUseParentType??"";submitPost(e,l,t,a,i,n,s,c,o)});var y=React.useMemo(()=>d.map((e,t)=>React.createElement("div",{key:t},React.createElement(ReadComment,_extends({},l,{commentData:e,i:t,handlePost:b,sub:e})))),[d]);return React.createElement("div",{className:l.className+" AddComment_Container"},d?.map?React.createElement("div",{className:`${WatchPageStyles.readCommentsListContainer} ${WatchPageStyles.readCommentsListContainerOp} Post_ReadCommentsListContainer`},y):null,React.createElement("div",{className:"spinner spinnerBig "+(n?"opacity1 spinnerRelative":"opacity0 spinnerHide"),style:{marginTop:n?"1rem":0}}),w?React.createElement("div",{className:"error CommentForceNoBlur",style:{margin:".25rem",marginBottom:"0"},onClick:E},w.message):null)};export default Module;