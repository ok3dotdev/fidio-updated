function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,l=arguments[t];for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a])}return e}).apply(this,arguments)}import React from"react";import Image from"next/image";import Link from"next/link";import styles from"./upload.module.scss";import WatchPageStyles from"/modules/streaming/watch/WatchPage.module.scss";import{v4 as uuidv4}from"uuid";import{SignIn,Username}from"/modules/onboarding/signin";import{Player}from"/modules/streaming/watch";import UploadVideoFile from"./UploadVideoFile";import{ensureAutoPlay}from"/modules/video/player/utility";import{initializePlayer}from"/modules/streaming/watch/runtime/initialize";import apiReq from"/modules/utility/api/apiReq";import{checkiOS,debounce,resolveNestedProperty,setNestedProperty}from"/modules/util";import TextareaAutosize from"react-textarea-autosize";const Module=i=>{const[e,t]=React.useState(null),[a,l]=React.useState(!1),[s,n]=React.useState(null),[r,c]=React.useState(null),[o,d]=React.useState(!1),[u,m]=React.useState(!1),[p,g]=React.useState(!1),[y,h]=React.useState(!1),[v,R]=React.useState(null),[b,,]=React.useState(0),[f,E]=React.useState(20),[B,O]=React.useState(!1),[_,I]=React.useState(null),[P,N]=React.useState({}),[S,A]=React.useState({message:""}),[C,q]=React.useState({action:"page_loaded",trying:"play_video",src:""}),k=React.useRef(),T=React.useRef(),z=(React.useEffect(()=>{var e;a||(e=uuidv4(),n(e),z(),l(!0))},[a,s,p]),i._LocalEventEmitter.unsubscribe(s),i._LocalEventEmitter.subscribe(s,e=>{var t;e&&("fetchVideos"===e.dispatch?f<100&&(t=f+20,E(t),x(b,t)):"initializeVideosHandler"===e.dispatch&&L())}),async()=>{var e=await apiReq("/p/uploadvideopayload");e?.data?.uploadVideoPayload&&I(e.data.uploadVideoPayload,{})}),D=React.useCallback(debounce(e=>{e?.target&&e.target.scrollLeft+e.target.offsetWidth>e.target.scrollWidth-300&&!y&&i._LocalEventEmitter.dispatch(s,{dispatch:"fetchVideos"})},500),[f,y,v]),L=()=>{T?.current&&!B&&(O(!0),T.current.addEventListener("scroll",D))},x=(React.useEffect(()=>{!i._loggedIn||y||v||x(b,f)},[i?._loggedIn,y,b,f]),async(e,t)=>{let a;try{var l;y||(v||R([]),h("videos"),a=setTimeout(()=>{h(!1)},35e3),(l=await apiReq("/fetch/fetchhandler",{handlerArgs:[{videoReq:[{limit:t,offset:20*e,sortField:"creation",sort:"desc"}]}]}))?.data?.fetchedData&&l.data.fetchedData[0]&&l.data.fetchedData[0]?.videoReq[0]?(h(!1),clearTimeout(a),R(l.data.fetchedData[0].videoReq[0]),setTimeout(()=>{i._LocalEventEmitter.dispatch(s,{dispatch:"initializeVideosHandler"})},150)):(h(!1),clearTimeout(a)))}catch(e){h(!1),clearTimeout(a)}});var F=React.useCallback(e=>{t(null)});const U=(e,t)=>{var a=t??r;const l=checkiOS()?"hls":"mpd";if(t&&t[l]){const n=i.cdn.static+"/video/"+a[l];console.log(n,window.videojs,t),console.log("Player",k.current,e),k.current?V(n,l,k.current):setTimeout(()=>{V(n,l,k.current)},5e3)}},V=(e,t,a)=>{k.current&&(k.current.src({src:e,type:"hls"===t?"application/x-mpegURL":"application/dash+xml"}),ensureAutoPlay(k.current.play,k.current))},w=i=>{c(i),setTimeout(()=>{Object.entries(_).map(t=>{var a,l,n=document.querySelector(`[selectelement="${s}-${t[0]}"]`);if(n){let e=resolveNestedProperty(i,t[1].path);"date"===t[1].type&&(t=new Date(Number(e)))&&(a=(t.getMonth()+1).toString(),l=t.getDate().toString(),e=`${t.getFullYear()}-${a.padStart(2,"0")}-`+l.padStart(2,"0")),n.value=e}})},150)},$=e=>{var t,a,l;w(e),N({}),s&&(p?U(k.current,e):(t=U,e=e,l=checkiOS()?"hls":"mpd",e&&e[l]&&(l=i.cdn.static+"/video/"+e[l],(a={...C}).src=l,q(a),k.current=initializePlayer(i,e,C,"player-"+s,{},k,[],null,null,g,t))))},j=(i._LocalEventEmitter.unsubscribe("uploadUpdate"),i._LocalEventEmitter.subscribe("uploadUpdate",e=>{e?.message&&(-1<["Ready to watch","Began processing video"].indexOf(e.message)&&x(b,f),A({message:e.message})),(e?.record?.id&&r?.id&&e.record.id===r.id||-1<["Video queued for processing","Began processing video"].indexOf(e.message))&&$(e.record)}),React.useCallback(e=>{if(e?.currentTarget?.getAttribute("item")){const t=e.currentTarget.getAttribute("item");if(t){const a=v.find(e=>e.id===t);a&&new Promise((e,t)=>{e(m(!0))}).then(()=>{$(a)})}}}));var H=React.useCallback(e=>{m(!1),w(null),N({}),d(!1)});React.useEffect(()=>{!u&&k?.current&&k.current.pause()},[u,k?.current]);const W=React.useCallback(e=>{var t,a=e?.currentTarget?.getAttribute("modif");let l=e?.currentTarget?.value;console.log(a,l),a&&r&&_&&(e=_[a]).path&&("date"===e.type?l=new Date(l).getTime():"array"===e.type&&"string"===e.item&&(l=l.split(",")),(t=P)[a]=!0,N(t),a=setNestedProperty({...r},e.path,l),console.log(a),a)&&c(a)});var Y=React.useMemo(()=>r&&_?React.createElement("div",{className:WatchPageStyles.uploadMetaContainer+" Video_UploadMetaContainer"},React.createElement("div",{className:WatchPageStyles.uploadMetaPrimaryContainer+" Video_UploadMetaPrimaryContainer"},Object.entries(_).map((e,t)=>React.createElement("div",{className:"label_input",key:t},React.createElement("div",{className:"label_data"},React.createElement("label",null,e[0].toUpperCase?""+e[0].charAt(0).toUpperCase()+(1<e[0].length?e[0].substring(1,e[0].length):""):""),e[1]?.type?"string"===e[1].type?React.createElement("input",{className:`uploadPage_${e[0]} `+(e[1].readonly?"input_readonly":null),type:"text",selectelement:s+"-"+e[0],disabled:e[1].readonly,modif:e[0],onChange:W}):"text"===e[1].type?React.createElement(TextareaAutosize,{className:`uploadPage_${e[0]} `+(e[1].readonly?"input_readonly":null),selectelement:s+"-"+e[0],minRows:e[1]?.rows??2,disabled:e[1].readonly,modif:e[0],onChange:W}):"array"===e[1].type&&"string"===e[1].item?React.createElement("div",{className:"label_data_container"},React.createElement(TextareaAutosize,{className:`uploadPage_${e[0]} `+(e[1].readonly?"input_readonly":null),selectelement:s+"-"+e[0],minRows:e[1]?.rows??2,disabled:e[1].readonly,modif:e[0],onChange:W}),resolveNestedProperty(r,e[1].path)?.map?React.createElement("div",{className:"tagContainer",style:{marginTop:".25rem"}},resolveNestedProperty(r,e[1].path).map((e,t)=>""!==e?React.createElement("div",{className:"tagItem",key:t},e):React.createElement("div",null))):React.createElement("div",null)):"date"===e[1].type?React.createElement("input",{type:"date",className:`uploadPage_${e[0]} `+(e[1].readonly?"input_readonly":null),selectelement:s+"-"+e[0],disabled:e[1].readonly,modif:e[0],onChange:W}):null:null)))),React.createElement("div",null)):null,[r,_]);var M=React.useCallback(e=>{(async e=>{const t=await apiReq("/p/publishvideo",{user:i?._loggedIn,videoDocument:r,modif:e,updatedFields:P,updatedFields:P});var a;N({}),t?.data?.updated?.id&&(w(t.data.updated),-1<(a=(e=[...v]).findIndex(e=>e.id===t.data.updated.id))&&(e[a]=t.data.updated),R(e))})(e?.currentTarget?.getAttribute("modif"))}),Q=(console.log(i,r,p,C,v,_),0<v?.length?v:Array(20).fill().map(()=>{}));return React.createElement("div",{className:`${styles.container} ${i.className} Upload_Container PagePadding`},React.createElement("h3",null,"Upload"),i?._loggedIn?i._loggedIn&&!i._loggedIn?.username?React.createElement(Username,i):null:React.createElement(SignIn,i),i?._loggedIn?.username?React.createElement("div",null,e?React.createElement("div",{className:"error",style:{margin:".25rem",marginBottom:"0"},onClick:F},e.message):null,u?null:React.createElement("div",null,React.createElement(UploadVideoFile,_extends({},i,{setProcessing:d,processing:o,handlingMeta:u,setHandlingMeta:e=>{m(e),p||setTimeout(()=>{k.current=initializePlayer(i,null,C,"player-"+s,{},k,[],null,null,g,null)},250)}}))),React.createElement("div",{className:WatchPageStyles.externalThumbnailContainer+" Thumbnails_ExternalContainer",style:{position:"relative"}},"videos"===y?React.createElement("div",{className:"fetchBusy",style:{position:"absolute",background:"transparent"}}):null,React.createElement("div",{className:"spinner spinnerBig "+("videos"===y?"opacity1 spinnerRelative":"opacity0 spinnerHide"),style:{position:"absolute",left:"49vw",top:"1rem"}}),React.createElement("div",{className:`${WatchPageStyles.thumbnailsContainer} ${"videos"===y?WatchPageStyles.thumbnailsContainerBusy:""} Thumbnails_Container tinyBar`,ref:T},Q.map((e,t)=>React.createElement("div",{key:t,className:WatchPageStyles.thumbnailContainer+" Thumbnail_Container"},React.createElement("div",{className:`${WatchPageStyles.thumbnail} ${-1<["processing","queued"].indexOf(e?.status)?WatchPageStyles.thumbnailProcessing:""} Thumbnail_Thumbnail`,style:{background:"url("+(i?.cdn?.static&&e?.thumbtrack[0]?i.cdn.static+"/thumbtrack/"+e.thumbtrack[0]:"img/default/greythumb.jpg")},onClick:j,item:e?.id}),React.createElement("h4",{className:""+WatchPageStyles.thumbnailTitle},e?.title??""))))),React.createElement("div",{className:styles.videoMessageContainer+" Video_MessageContainer"},React.createElement("p",{className:styles.videoMessage+" "+(S?.message?styles.videoMessageVisible:null)},S.message)),React.createElement("div",{style:{display:u?"block":"none"}},React.createElement("div",{className:styles.videoContainer+" Video_VideoUploadContainer"},React.createElement("div",{className:`${WatchPageStyles.videoQuadrant} ${WatchPageStyles.videoQuadrantSimple} WatchPage_VideoQuadrant`,style:{height:`calc(100vh - ${i?.menuHeight})`}},React.createElement(Player,_extends({},i,{playerName:s?"player-"+s:null,playerInitialized:p})))),Y,r?.status?"processing"===r.status?React.createElement("div",null,React.createElement("h4",null,"Your video is processing")):-1<["ready","good"].indexOf(r.status)?React.createElement("div",null,React.createElement("h4",null,"Your video is ready to be published")):"published"===r.status?React.createElement("div",null,React.createElement("h4",null,"Your video was published ",new Date(Number(r.publish))?.toDateString()??"")):null:null,React.createElement("div",null,React.createElement("div",{className:"flex gap-p5",style:{paddingBottom:".5rem"}},r?.status&&-1<["ready","good"].indexOf(r.status)?React.createElement("button",{className:"Video_PublishButton",onClick:M,modif:"publish"},"Publish"):null,r?React.createElement("button",{className:"Video_UpdateButton",onClick:M,modif:"update"},"Update"):null,"published"===r?.status?React.createElement(React.Fragment,null,r?.meta?.private?React.createElement("button",{className:"Video_UnprivateButton",onClick:M,modif:"unprivate"},"Unprivate"):React.createElement("button",{className:"Video_PrivateButton",onClick:M,modif:"private"},"Make Private"),React.createElement("button",{className:"Video_UnpublishButton",onClick:M,modif:"unpublish"},"Unpublish")):null,React.createElement("button",{className:"Video_UploadButton",onClick:H},"Upload New"))))):null)};export default Module;