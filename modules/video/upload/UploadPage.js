function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,l=arguments[t];for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a])}return e}).apply(this,arguments)}import React from"react";import styles from"./upload.module.scss";import WatchPageStyles from"/modules/streaming/watch/WatchPage.module.scss";import{v4 as uuidv4}from"uuid";import{SignIn,Username}from"/modules/onboarding/signin";import{Player}from"/modules/streaming/watch";import UploadVideoFileInternal from"./UploadVideoFileInternal";import{ensureAutoPlay}from"/modules/video/player/utility";import{initializePlayer}from"/modules/streaming/watch/runtime/initialize";import apiReq from"/modules/utility/api/apiReq";import{checkiOS,debounce,resolveNestedProperty}from"/modules/util";import VideoReel from"/modules/video/upload/VideoReel";import TextareaAutosize from"react-textarea-autosize";import Upload from"/modules/video/upload/class/Upload";import{fetchVideos}from"/modules/video/upload/tools";const Module=s=>{const[e,t]=React.useState(null),[a,l]=React.useState(!1),[i,n]=React.useState(null),[r,o]=React.useState(null),[c,d]=React.useState(null),[u,m]=React.useState(!1),[p,g]=React.useState(!1),[R,y]=React.useState(!1),[v,h]=React.useState(!1),[E,b]=React.useState(null),[f,,]=React.useState(0),[_,P]=React.useState(20),[C,O]=React.useState(!1),[U,$]=React.useState({message:""}),[N,B]=React.useState({action:"page_loaded",trying:"play_video",src:""}),S=React.useRef(),V=React.useRef(),z=(React.useEffect(()=>{var e;a||(e=uuidv4(),n(e),l(!0))},[a,i,R]),s._LocalEventEmitter.unsubscribe(i),s._LocalEventEmitter.subscribe(i,e=>{var t;e&&("fetchVideos"===e.dispatch?_<100&&(t=_+20,P(t),x(f,t)):"initializeVideosHandler"===e.dispatch&&T())}),React.useCallback(debounce(e=>{e?.target&&e.target.scrollLeft+e.target.offsetWidth>e.target.scrollWidth-300&&!v&&s._LocalEventEmitter.dispatch(i,{dispatch:"fetchVideos"})},500),[_,v,E])),T=()=>{V?.current&&!C&&(O(!0),V.current.addEventListener("scroll",z))},x=(React.useEffect(()=>{!s._loggedIn||v||E||x(f,_)},[s?._loggedIn,v,f,_]),async(e,t)=>{e=await fetchVideos(s,e,t,h,v,i);e&&b(e)});var W=React.useCallback(e=>{t(null)});const I=(e,t)=>{var a=t??r;const l=checkiOS()?"hls":"mpd";if(t&&t[l]){const n=s.cdn.static+"/video/"+a[l];S.current?k(n,l,S.current):setTimeout(()=>{k(n,l,S.current)},5e3)}},k=(e,t,a)=>{S.current&&(S.current.src({src:e,type:"hls"===t?"application/x-mpegURL":"application/dash+xml"}),ensureAutoPlay(S.current.play,S.current))},w=r=>{let e=r;r instanceof Upload?o(r):(e=new Upload(s._loggedIn.identifier,r),o(e)),e.player||(e.player=S),d(e.getInstance()),setTimeout(()=>{e?.usePayload&&Object.entries(e.usePayload).map(t=>{var a,l,n=document.querySelector(`[selectelement="${i}-${t[0]}"]`);if(n){let e=resolveNestedProperty(r,t[1].path);"date"===t[1].type&&(t=new Date(Number(e)))&&(a=(t.getMonth()+1).toString(),l=t.getDate().toString(),e=`${t.getFullYear()}-${a.padStart(2,"0")}-`+l.padStart(2,"0")),n.value=e}})},150)},F=e=>{var t,a,l;w(e),r?.updatedFields&&(r.updatedFields={}),i&&(R?I(S.current,e):(t=I,e=e,l=checkiOS()?"hls":"mpd",e&&e[l]&&(l=s.cdn.static+"/video/"+e[l],(a={...N}).src=l,B(a),S.current=initializePlayer(s,e,N,"player-"+i,{},S,[],null,null,y,t))))};s._LocalEventEmitter.unsubscribe("uploadUpdate"),s._LocalEventEmitter.subscribe("uploadUpdate",e=>{e?.message&&(-1<["Ready to watch","Began processing video"].indexOf(e.message)&&x(f,_),$({message:e.message})),(e?.record?.id&&r?.getInstance()?.id&&e.record.id===r.getInstance().id||-1<["Video queued for processing","Began processing video"].indexOf(e.message))&&F(e.record)});var L=React.useCallback(e=>{if(e?.currentTarget?.getAttribute("item")){const t=e.currentTarget.getAttribute("item");if(t){const a=E.find(e=>e.id===t);a&&new Promise((e,t)=>{e(g(!0))}).then(()=>{F(a)})}}}),D=React.useCallback(e=>{g(!1),w(null),r?.updatedFields&&(r.updatedFields={}),m(!1)},[r]);React.useEffect(()=>{!p&&S?.current&&S.current.pause()},[p,S?.current]);const M=React.useCallback(e=>{var t=e?.target?.getAttribute("modif"),e=e?.target?.value;t&&r&&(e=r.handleUsePayload(e,t),w(e))},[r,s?._loggedIn?.identifier]);console.log(r);var j=React.useMemo(()=>c&&r.usePayload?React.createElement("div",{className:WatchPageStyles.uploadMetaContainer+" Video_UploadMetaContainer"},React.createElement("div",{className:WatchPageStyles.uploadMetaPrimaryContainer+" Video_UploadMetaPrimaryContainer"},Object.entries(r.usePayload).map((e,t)=>React.createElement("div",{className:"label_input",key:t},React.createElement("div",{className:"label_data"},e[1]?.type?"string"===e[1].type&&"author"!==e[0]?React.createElement(React.Fragment,null,React.createElement("label",null,e[0].toUpperCase?""+e[0].charAt(0).toUpperCase()+(1<e[0].length?e[0].substring(1,e[0].length):""):""),React.createElement("input",{className:`uploadPage_${e[0]} `+(e[1].readonly?"input_readonly":null),type:"text",selectelement:i+"-"+e[0],disabled:e[1].readonly,modif:e[0],onChange:M})):"text"===e[1].type?React.createElement(React.Fragment,null,React.createElement("label",null,e[0].toUpperCase?""+e[0].charAt(0).toUpperCase()+(1<e[0].length?e[0].substring(1,e[0].length):""):""),React.createElement(TextareaAutosize,{className:`uploadPage_${e[0]} `+(e[1].readonly?"input_readonly":null),selectelement:i+"-"+e[0],minRows:e[1]?.rows??2,disabled:e[1].readonly,modif:e[0],onChange:M})):"array"===e[1].type&&"string"===e[1].item?React.createElement(React.Fragment,null,React.createElement("label",null,e[0].toUpperCase?""+e[0].charAt(0).toUpperCase()+(1<e[0].length?e[0].substring(1,e[0].length):""):""),React.createElement("div",{className:"label_data_container"},React.createElement(TextareaAutosize,{className:`uploadPage_${e[0]} `+(e[1].readonly?"input_readonly":null),selectelement:i+"-"+e[0],minRows:e[1]?.rows??2,disabled:e[1].readonly,modif:e[0],onChange:M}),resolveNestedProperty(c,e[1].path)?.map?React.createElement("div",{className:"tagContainer",style:{marginTop:".25rem"}},resolveNestedProperty(c,e[1].path).map((e,t)=>""!==e?React.createElement("div",{className:"tagItem",key:t},e):React.createElement("div",null))):React.createElement("div",null))):"date"===e[1].type?React.createElement(React.Fragment,null,React.createElement("label",null,e[0].toUpperCase?""+e[0].charAt(0).toUpperCase()+(1<e[0].length?e[0].substring(1,e[0].length):""):""),React.createElement("input",{type:"date",className:`uploadPage_${e[0]} `+(e[1].readonly?"input_readonly":null),selectelement:i+"-"+e[0],disabled:e[1].readonly,modif:e[0],onChange:M})):null:null)))),React.createElement("div",null)):null,[c,r]);var A=React.useCallback(e=>{(async e=>{var t=r.getInstance();const a=await apiReq("/p/publishvideo",{user:s?._loggedIn,videoDocument:t,modif:e,updatedFields:r.updatedFields});console.log("p",a),r.updatedFields={},a?.data?.updated?.id&&(w(a.data.updated),-1<(e=(t=[...E]).findIndex(e=>e.id===a.data.updated.id))&&(t[e]=a.data.updated),b(t))})(e?.currentTarget?.getAttribute("modif"))},[r]),q=(console.log(s,r,R,N,E),0<E?.length?E:Array(20).fill().map(()=>{}));return React.createElement("div",{className:`${styles.container} ${s.className} Upload_Container PagePadding`},React.createElement("h3",null,"Upload"),s?._loggedIn?s._loggedIn&&!s._loggedIn?.username?React.createElement(Username,s):null:React.createElement(SignIn,s),s?._loggedIn?.username?React.createElement("div",null,e?React.createElement("div",{className:"error",style:{margin:".25rem",marginBottom:"0"},onClick:W},e.message):null,p?null:React.createElement("div",null,React.createElement(UploadVideoFileInternal,_extends({},s,{setProcessing:m,processing:u,handlingMeta:p,setHandlingMeta:e=>{g(e),R||setTimeout(()=>{S.current=initializePlayer(s,null,N,"player-"+i,{},S,[],null,null,y,null)},250)},setVideoDocumentProxy:w}))),React.createElement(VideoReel,_extends({},s,{fetchBusy:v,useVideos:q,videosContainerRef:V,loadVideo:L})),React.createElement("div",{className:styles.videoMessageContainer+" Video_MessageContainer"},React.createElement("p",{className:styles.videoMessage+" "+(U?.message?styles.videoMessageVisible:null)},U.message)),React.createElement("div",{style:{display:p?"block":"none"}},React.createElement("div",{className:styles.videoContainer+" Video_VideoUploadContainer"},React.createElement("div",{className:`${WatchPageStyles.videoQuadrant} ${WatchPageStyles.videoQuadrantSimple} WatchPage_VideoQuadrant`,style:{height:`calc(100vh - ${s?.menuHeight})`}},React.createElement(Player,_extends({},s,{playerName:i?"player-"+i:null,playerInitialized:R})))),j,r?.status?"processing"===r.status?React.createElement("div",null,React.createElement("h4",null,"Your video is processing")):-1<["ready","good"].indexOf(r.status)?React.createElement("div",null,React.createElement("h4",null,"Your video is ready to be published")):"published"===r.status?React.createElement("div",null,React.createElement("h4",null,"Your video was published ",new Date(Number(r.publish))?.toDateString()??"")):null:null,React.createElement("div",null,React.createElement("div",{className:"flex gap-p5",style:{paddingBottom:".5rem"}},r?.status&&-1<["ready","good"].indexOf(r.status)?React.createElement("button",{className:"Video_PublishButton",onClick:A,modif:"publish"},"Publish"):null,r?React.createElement("button",{className:"Video_UpdateButton",onClick:A,modif:"update"},"Update"):null,"published"===r?.status?React.createElement(React.Fragment,null,r?.meta?.private?React.createElement("button",{className:"Video_UnprivateButton",onClick:A,modif:"unprivate"},"Unprivate"):React.createElement("button",{className:"Video_PrivateButton",onClick:A,modif:"private"},"Make Private"),React.createElement("button",{className:"Video_UnpublishButton",onClick:A,modif:"unpublish"},"Unpublish")):null,React.createElement("button",{className:"Video_UploadButton",onClick:D},"Upload New"))))):null)};export default Module;