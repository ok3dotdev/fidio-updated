function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,n=arguments[t];for(a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}import React from"react";import styles from"./Survey.module.scss";import TextareaAutosize from"react-textarea-autosize";import{sendSurveyEmail}from"../utility/mail";import{Lineup}from"../ecommerce/product";import{isObjectEmpty}from"../util";import{westernMoneyFormat}from"../utility/ecommerce";import{defaultDefinePriceCurrency}from"../ecommerce/product/defaults";import{doSetOptionsMetaData}from"../ecommerce/shop/Functions";import{allowedTypes}from"../ecommerce/product/defaults";import{v4 as uuidv4}from"uuid";const Module=i=>{const[e,P]=React.useState(!1),[t,M]=React.useState(!1),[c,$]=React.useState([]),[p,q]=React.useState(null),[m,L]=React.useState({}),[a,d]=React.useState(null),[n,g]=React.useState(null),[F,y]=React.useState(null),[z,r]=React.useState(null),[H,v]=React.useState(!1),[f,U]=React.useState(i?.surveyState?.pipelineObject??{}),[s,V]=React.useState({}),[o,K]=React.useState(!1),[b,_]=React.useState(0),[l,,]=React.useState(defaultDefinePriceCurrency),[h,u]=React.useState(new FormData),[R,E]=React.useState([]),[S,T]=React.useState({}),[J,Q]=React.useState("100vh"),N=React.useRef(),I=React.useRef(),O=i.survey,x=O?.stages[p],Z=O?.stages[a];var G=O?.stages[n];React.useEffect(()=>{e||(i?.imgCache&&u(i.imgCache),P(!0))},[e,i?.imgCache]);const W=e=>{var t;i.setSurveyState&&i.surveyState&&((t=i.surveyState).answers=e,i.setSurveyState(t)),L(e)},C=e=>{var t;i.setSurveyState&&i.surveyState&&((t=i.surveyState).currentStage=e,i.setSurveyState(t)),q(e),O?.stages&&O.stages[e]&&"function"==typeof O.stages[e]?.func&&O.stages[e].func()},k=(React.useEffect(()=>{!p&&O?.stages?.index&&C("index")},[O,p]),e=>{var t;i.setSurveyState&&i.surveyState&&((t=i.surveyState).pipelineDbItem=e,i.setSurveyState(t)),V(e)}),X=(React.useEffect(()=>{O?.pipelineDbItemDefault&&!isObjectEmpty(O.pipelineDbItemDefault)&&isObjectEmpty(s)?k(O.pipelineDbItemDefault):isObjectEmpty(s)&&i?.surveyState?.pipelineDbItem&&!isObjectEmpty(i?.surveyState?.pipelineDbItem)&&k(i.surveyState.pipelineDbItem)},[s,O?.pipelineDbItemDefault]),React.useCallback(e=>{var t=e?.currentTarget?.getAttribute("goto"),a=e?.currentTarget?.getAttribute("question"),n=document.getElementById("input_ref_id_current")?.value??"",e=e?.currentTarget?.getAttribute("handlestage");console.log(document.getElementById("input_ref_id_current")?.value,document.getElementById("input_ref_id_next"),document.getElementById("input_ref_id_back"),n,N?.current),B(t,a,n,null,e)},[N?.current])),Y=React.useCallback(e=>{var t=e?.currentTarget?.getAttribute("goto"),a=e?.currentTarget?.getAttribute("question"),n=e?.currentTarget?.getAttribute("value")??e.currentTarget.value,e="true"===e?.currentTarget?.getAttribute("pipeline");B(t,a,n,e)}),w=t=>{if(console.log("Do Clear",t),t)for(let e=0;e<t.length;e++)console.log(t[e]?.getAttribute("surveyclear")),t[e]?.getAttribute("surveyclear")&&(t[e].value="",console.log(t[e]),t[e].getAttribute("usedefault"))&&(t[e].value=t[e].getAttribute("usedefault"))},B=(t,a,n,e,r)=>{if(console.log(x,t,a,n),T({}),I?.current&&(I.current.innerHTML="",I.current.style.opacity=0),x?.validation&&"function"==typeof x.validation){var l,u=x.validation(x,n);if(console.log(u),u)return(l=S)[p]=u,T(l),I?.current&&(I.current.innerHTML=u,I.current.style.opacity=1),null}if(x?.pipeline?.length)for(let e=0;e<x.pipeline.length;e++)if(x.pipeline[e]?.input&&x.pipeline[e]?.input?.validation&&"function"==typeof x.pipeline[e].input.validation){var i,c=x.pipeline[e]?.input?.validation(x.pipeline[e],f[x.pipeline[e].input.var]);if(c)return console.log(c),(i=S)[p]=c,T(i),I?.current&&(I.current.innerHTML=c,I.current.style.opacity=1),null}if(e)return console.log(t,a,n),!1;d(t),g(p),setTimeout(()=>{y(!0)},100),N?.current&&N.current.select();let s="",o="";setTimeout(()=>{var e;N?.current&&(N.current.value="",N.current.placeholder=""),v(!0),t&&(console.log(a,p),a&&((e=m)[p]||(e[p]={}),e[p].question=a,e[p].answer=n,W(e)),console.log(document.getElementById("input_ref_id_next"),O,t,m),O?.stages[t]?.input&&document.getElementById("input_ref_id_next")&&(m&&m[t]&&Object.prototype.hasOwnProperty.call(m[t],"answer")?(document.getElementById("input_ref_id_next").value=m[t].answer,s=m[t].answer):Object.prototype.hasOwnProperty.call(O?.stages[t].input,"default")&&(document.getElementById("input_ref_id_next").value=O.stages[t].input.default,s=O.stages[t].input.default),Object.prototype.hasOwnProperty.call(O?.stages[t].input,"placeholder"))&&(document.getElementById("input_ref_id_next").placeholder=O.stages[t].input.placeholder,o=O.stages[t].input.placeholder),C(t),setTimeout(()=>{w(document.getElementsByTagName("textarea")),w(document.getElementsByTagName("input"))},100)),setTimeout(()=>{d(null),g(null),document.getElementById("input_ref_id_current")&&(document.getElementById("input_ref_id_current").value=s,document.getElementById("input_ref_id_current").placeholder=o,document.getElementById("input_ref_id_next").value=""),y(null),v(!1)},100)},250),ee(p,!0)},ee=(console.log(m),(e,t)=>{var a=c;t&&e?a.push(e):a.pop(),$(a)}),te=React.useCallback(e=>{if(0<c.length){const a=c[c.length-1];console.log(a),d(p),g(a),setTimeout(()=>{r(!0)},100);let e="",t="";setTimeout(()=>{v(!0),a&&(C(a),w(document.getElementsByTagName("textarea")),w(document.getElementsByTagName("input"))),console.log(O.stages,a,m),setTimeout(()=>{O?.stages[a]?.input&&document.getElementById("input_ref_id_back")&&(Object.prototype.hasOwnProperty.call(m[a],"answer")?(document.getElementById("input_ref_id_back").value=m[a].answer,e=m[a].answer):Object.prototype.hasOwnProperty.call(O?.stages[a].input,"default")&&(document.getElementById("input_ref_id_back").value=O.stages[a].input.default,e=O.stages[a].input.default),Object.prototype.hasOwnProperty.call(O?.stages[a].input,"placeholder"))&&(document.getElementById("input_ref_id_back").placeholder=O.stages[a].input.placeholder,t=O.stages[a].input.placeholder)},1),setTimeout(()=>{g(null),d(null),document.getElementById("input_ref_id_current")&&(document.getElementById("input_ref_id_current").value=e,document.getElementById("input_ref_id_current").placeholder=t),r(null),v(!1)},100)},250),ee(null,!1)}},[c,O]),A=(React.useEffect(()=>{t||N?.current&&x?.input&&(console.log("Running"),M(!0),N.current.value="",N.current.placeholder="",N.current.select(),Object.prototype.hasOwnProperty.call(x.input,"default")&&(N.current.value=x.input.default),Object.prototype.hasOwnProperty.call(x.input,"placeholder"))&&(N.current.placeholder=x.input.placeholder)},[t,x]),React.useEffect(()=>{!x?.submit&&!Z?.submit||o||((async e=>{e&&(e=await sendSurveyEmail(i.apiUrl,i.domainKey,e,O.name,i._loggedIn),console.log(e))})(m),K(!0))},[x,o]),(e,t,a)=>{var n={...f},r=(a?(n[e]||(n[e]=[]),-1===n[e].indexOf(t)?n[e].push(t):n[e].splice(n[e].indexOf(t),1)):n[e]=t,m);r[p]||(r[p]={}),r[p].pipeline||(r[p].pipeline={}),a?(r[p].pipeline[e]||(r[p].pipeline[e]=[]),-1===r[p].pipeline[e].indexOf(t)?r[p].pipeline[e].push(t):r[p].pipeline[e].splice(r[p].pipeline[e].indexOf(t),1)):r[p].pipeline[e]=t,W(r),a=n,i.setSurveyState&&i.surveyState&&((e=i.surveyState).pipelineObject=a,i.setSurveyState(e)),U(a)}),j=React.useCallback(e=>{try{var t,a,n;e&&(t=e?.target?.getAttribute("useinnerhtml")?e?.target?.innerHTML:e?.target?.value??e?.currentTarget?.value,e?.currentTarget?.getAttribute("pipeline")?(console.log(t,"Add to Obj"),A(e?.currentTarget?.getAttribute("var"),t,e?.target?.getAttribute("usemultiple"))):13===e.keyCode&&(e.preventDefault(),a=e?.currentTarget?.getAttribute("goto"),n=e?.currentTarget?.getAttribute("question"),console.log(t,n,a),B(a,n,t)))}catch(e){console.log(e)}}),ae=React.useCallback(e=>{console.log(e.currentTarget.checked,e.currentTarget.getAttribute("option")),doSetOptionsMetaData(e,s?.detailmeta,s,k,null,b,_)}),ne=React.useCallback(e=>{var t,a;e.currentTarget&&(e?.currentTarget?.getAttribute("pipeline")&&(t=e?.current?.value??e?.currentTarget?.value,console.log(t,"Add to Obj"),A(e?.currentTarget?.getAttribute("var"),t)),t={...s},"singleStyle"===e?.currentTarget?.getAttribute("method"))&&(a=t?.styles[0]?0:-1,console.log(a,e.currentTarget.value,!isNaN(Number(e.currentTarget.value))),-1<a)&&(isNaN(Number(e.currentTarget.value))||("USD"===l?.currency?t.styles[a].price=Number(e.currentTarget.value):(t.styles[a].priceTable||(t.styles[a].priceTable={}),t.styles[a].priceTable[l.currency]=Number(e.currentTarget.value)),k(t)))}),re=React.useCallback(e=>{var t,a;e.currentTarget&&(e?.currentTarget?.getAttribute("pipeline")&&(t=e?.current?.value??e?.currentTarget?.value,console.log(t,"Add to Obj"),A(e?.currentTarget?.getAttribute("var"),t)),t={...s},"singleStyle"===e?.currentTarget?.getAttribute("method"))&&-1<(a=t?.styles[0]?0:-1)&&(isNaN(Number(e.currentTarget.value))||(t.styles[a].option[0].quantity=Number(e.currentTarget.value)),k(t))}),le=React.useCallback(e=>{console.log(e,"Handle New");const a=e?.currentTarget?.getAttribute("selectmodif");console.log("Sel",a),console.log(h);var e=e?.target?.files,e=Array.from(e).slice(0,1<e.length?1:e.length).filter(e=>e.type&&-1<allowedTypes.indexOf(e.type)).map(e=>{var t=e.slice(0,e.size,e.type),a=allowedTypes[allowedTypes.indexOf(e.type)].match(/\/([a-zA-Z0-9].*)/)[1];return new File([t],uuidv4()+"."+a,{type:e.type})});console.log("Files Renamed",e,h);const n=h,r=R;e&&e.forEach(t=>{n.append("image",t),ie(t,a);var e=r.findIndex(e=>e.name===t.name);-1<e&&r.splice(e,1),r.push({name:t.name,modif:a})}),E(r),u(n),i?.setImgCache&&i.setImgCache(n),i.setSurveyState&&i.surveyState&&((e=i.surveyState).imgFor=r,i.setSurveyState(e))}),ue=React.useCallback(e=>{console.log(e,"Add Temp"),e?.currentTarget?.getAttribute("modif")&&(e=document.querySelector(`input[selectmodif='${e?.currentTarget?.getAttribute("modif")}']`))?.click&&e.click()}),ie=(n,r)=>new Promise((e,t)=>{const a=new FileReader;a.onload=()=>{console.log(a.result),document.querySelector(`img[selectimg=${r}]`).style.backgroundImage=`url(${a.result})`,e(a.result)},a.onerror=()=>{t(a.error)},a.readAsDataURL(n)}),ce=(e,t="lineup",a)=>{const n=h,r=R;e&&(e.forEach(e=>{n.append("image",e),r.push({name:e.name,modif:t,id:a})}),n.append("imgNames",JSON.stringify(r))),u(n),E(r),i?.setImgCache&&i.setImgCache(n),i.setSurveyState&&i.surveyState&&((e=i.surveyState).imgFor=r,i.setSurveyState(e))},se=e=>{var t,a;if(e?.component&&"function"==typeof e.component)return t=e.component,a=Object.assign(e?.props??{},i),React.createElement(t,_extends({},a,{m:e}))},oe=React.useCallback(e=>{e?.currentTarget&&Q(e.currentTarget.clientHeight+"px")});var D=(t,e,a,n,r,l,u)=>(console.log(l,m),React.createElement("div",{className:`${styles[a]} ${styles.item} ${F&&n?""+styles[n]:null} ${z&&e?""+styles[e]:null} ${H&&r?styles.keepCurrent+" "+styles.backToOriginal:null} ${t?.className} survey_itemContainer`,style:{background:t?.bg??null,color:t?.color??null},onChange:oe,onMouseMove:oe},React.createElement("h1",{className:styles.title+" survey_title"},t?.label),"select"===t?.input?.type?React.createElement("ul",{className:styles.survey__optionsList},t?.input?.options.map(e=>React.createElement("li",{key:e.label},React.createElement("button",{className:styles.survey__optionButton,onClick:Y,goto:e.goto,label:e.label,question:t?.label,value:e.label},e.label)))):"number"===t?.input?.type?React.createElement("div",null,React.createElement("input",{id:"input_ref_id_"+u,type:"number",className:""+styles.numberInput,defaultValue:t?.input?.default,ref:N})):"text"===t?.input?.type?React.createElement("div",null,React.createElement(TextareaAutosize,{id:"input_ref_id_"+u,type:"text",className:""+styles.textInput,placeholder:t?.input?.default,minRows:3,ref:N,onKeyDown:j,goto:t?.confirm?.goto,question:t?.label,defaultValue:m[l]?.answer})):t?.component&&"function"==typeof t.component?React.createElement("div",null,se(t)):null,t?.pipeline?.map?t.pipeline.map((t,e)=>React.createElement("div",{key:e,className:"survey_pipelineItemContainer",style:{marginBottom:".25rem"}},React.createElement("label",{className:"survey_label",style:{lineHeight:"1.5rem"}},t?.label??""),React.createElement("div",{className:"survey_inputContainer",style:{marginTop:".25rem"}},"text"===t?.input?.type?React.createElement("div",{className:t?.className+" survey_textInput"},React.createElement(TextareaAutosize,{type:"text",className:""+styles.textInput,placeholder:t?.input?.default,onInput:j,var:t?.input?.var,pipeline:"true",minRows:t?.input?.rows??1,defaultValue:f[t?.input?.var],usedefault:f[t?.input?.var],surveyclear:"true"})):"datetime-local"===t?.input?.type?React.createElement("div",{className:t?.className+" survey_datetimeInput"},React.createElement("input",{type:"datetime-local",placeholder:t?.input?.default,onInput:j,var:t?.input?.var,pipeline:"true",surveyclear:"true",usedefault:f[t?.input?.var]})):"lineup"===t?.input?.type?React.createElement("div",{className:t?.className+" survey_lineupContainer"},React.createElement(Lineup,_extends({},i,{product:s,editing:s,editingOptionsMeta:s?.detailmeta??null,setOptionsMetaData:ae,currentLineupEditing:b,setCurrentLineupEditing:_,appendFormData:ce}))):"price"===t?.input?.type?React.createElement("div",{className:t?.className+" flex gap-p2 survey_price"},React.createElement("span",{className:"survey_currency"},t.symbol??"$"),React.createElement("span",null,React.createElement("input",{type:"text",style:{width:"100%"},onChange:ne,var:t?.input?.var,pipeline:"true",surveyclear:"true",method:t?.input?.method,usedefault:!isObjectEmpty(f)&&Object.prototype.hasOwnProperty.call(f,[t?.input?.var])&&null!==f[t?.input?.var]?westernMoneyFormat.format(f[t.input.var]):"10.00"}))):"quantity"===t?.input?.type?React.createElement("div",{className:t?.className+" flex gap-p2 survey_quantity"},React.createElement("span",null,"Qty"),React.createElement("span",null,React.createElement("input",{type:"text",style:{width:"100%"},onChange:re,var:t?.input?.var,pipeline:"true",surveyclear:"true",method:t?.input?.method,usedefault:!isObjectEmpty(f)&&Object.prototype.hasOwnProperty.call(f,[t?.input?.var])&&null!==f[t?.input?.var]?f[t?.input?.var]:"100"}))):"select"===t?.input?.type?React.createElement("ul",{className:styles.survey__optionsList},t?.input?.options.map(e=>React.createElement("li",{key:e.label},React.createElement("button",{className:styles.survey__optionButton+" "+(f&&Object.prototype.hasOwnProperty.call(f,[t?.input?.var])&&(t?.input?.multiple&&-1<f[t.input.var].indexOf(e.label)||f[t.input.var]===e.label)?styles.survey__optionButtonSelected:""),onClick:j,var:t?.input?.var,pipeline:"true",useinnerhtml:"true",usemultiple:t?.input?.multiple?"true":null},e.label)))):"image"===t?.input?.type&&-1<["leadImg","featureImg"].indexOf(t?.input?.var)?React.createElement("div",{className:t?.className+" survey_image"},React.createElement("div",{style:{height:t?.height??"200px",width:t?.width??"200px"}},(t=>{let a;for(let e=0;e<R.length;e++)t?.input?.var===R[e].modif&&(a=R[e].name);var e=[...h.entries()].filter(([e])=>"image"===e);let n;e.forEach(([,e],t)=>{a===e.name&&(n=e)}),n&&ie(n,t.input.var);e="featureImg"===t.input.var&&pe?i?.cdn?.static+"/"+pe:"leadImg"===t.input.var&&me?i?.cdn?.static+"/"+me:"img/default/greythumb.jpg";return React.createElement("img",{className:"lineup_image",style:{borderRadius:".25rem",backgroundImage:`url(${e})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",width:"100%",height:"100%"},selectimg:t?.input?.var})})(t)),React.createElement("div",{className:"flex gap-p2 "+styles.pseudoButton,style:{alignItems:"center",fontSize:".8rem",marginTop:".5rem"},onClick:ue,modif:t?.input?.var},React.createElement("div",{className:"material-icons",style:{alignSelf:"center"}},"add"),React.createElement("div",null,t?.note)),React.createElement("input",{style:{display:"none"},type:"file",onChange:le,selectmodif:t.input.var})):t?.component?React.createElement("div",{className:t?.className+" survey_myCustomComponent"},se(t)):t?.jsx?React.createElement("div",{className:t?.className+" survey_myCustomComponent"},t.jsx):null))):null,React.createElement("div",{className:"survey_errorContainer"},React.createElement("div",{className:"error",ref:I,style:{opacity:0}},S[l])),React.createElement("div",{className:"flex survey_confirmBackButtonContainer",style:{direction:"rtl",marginTop:".5rem",justifyContent:"space-between"}},React.createElement("button",{className:styles.confirmButton+" survey_confirmButton",onClick:X,goto:t?.confirm?.goto,label:t?.label,value:"confirm",question:t?.label,style:{opacity:t?.confirm?1:0,transition:0},handlestage:u},t?.confirm?.label?t?.confirm.label:"end"===t?.confirm?.goto?"Confirm":"Next"),c&&0<c.length&&!t?.submit&&!o?React.createElement("button",{onClick:te,className:styles.backButton+" survey_backButton",style:{transition:0}},"Back"):null)));const pe=s?.images?s.images.find(e=>e?.bgImg):null,me=s.images?s.images.find(e=>e?.leadImg):null;return console.log("Pipeline Object",f,s,n,a,p),React.createElement("div",{className:`${styles.survey__container} ${i?.relativeStyles?styles.survey__relativeStyles+" Survey_relativeStyles":""} survey_container`,style:{height:J,width:"-webkit-fill-available"}},n?D(G,"animatingBackBack","backItem",null,null,n,"back"):null,D(x,"animatingBackCurrent","currentItem","animatingNextCurrent",!0,p,"current"),a?D(Z,null,"nextItem","animatingNextNext",null,a,"next"):null)};export default Module;