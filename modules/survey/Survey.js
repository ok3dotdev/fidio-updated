function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,r=arguments[t];for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}import React from"react";import styles from"./Survey.module.scss";import TextareaAutosize from"react-textarea-autosize";import{sendSurveyEmail}from"../utility/mail";import{Lineup}from"../ecommerce/product";import{isObjectEmpty}from"../util";import{westernMoneyFormat}from"../utility/ecommerce";import{defaultDefinePriceCurrency}from"../ecommerce/product/defaults";import{doSetOptionsMetaData}from"../ecommerce/shop/Functions";import{allowedTypes}from"../ecommerce/product/defaults";import{v4 as uuidv4}from"uuid";const Module=u=>{const[e,P]=React.useState(!1),[t,M]=React.useState(!1),[c,q]=React.useState([]),[s,$]=React.useState(null),[i,F]=React.useState({}),[a,o]=React.useState(null),[r,p]=React.useState(null),[L,m]=React.useState(null),[z,n]=React.useState(null),[H,g]=React.useState(!1),[y,U]=React.useState(u?.surveyState?.pipelineObject??{}),[d,V]=React.useState({}),[v,K]=React.useState(!1),[f,b]=React.useState(0),[l,,]=React.useState(defaultDefinePriceCurrency),[R,h]=React.useState(new FormData),[S,T]=React.useState([]),[E,N]=React.useState({}),[J,Q]=React.useState("100vh"),C=React.useRef(),O=React.useRef(),x=u.survey,k=x?.stages[s],Z=x?.stages[a];var G=x?.stages[r];React.useEffect(()=>{e||(u?.imgCache&&h(u.imgCache),P(!0))},[e,u?.imgCache]);const W=e=>{var t;u.setSurveyState&&u.surveyState&&((t=u.surveyState).answers=e,u.setSurveyState(t)),F(e)},w=e=>{var t;u.setSurveyState&&u.surveyState&&((t=u.surveyState).currentStage=e,u.setSurveyState(t)),$(e),x?.stages&&x.stages[e]&&"function"==typeof x.stages[e]?.func&&x.stages[e].func()},I=(React.useEffect(()=>{!s&&x?.stages?.index&&w("index")},[x,s]),e=>{var t;u.setSurveyState&&u.surveyState&&((t=u.surveyState).pipelineDbItem=e,u.setSurveyState(t)),V(e)}),X=(React.useEffect(()=>{x?.pipelineDbItemDefault&&!isObjectEmpty(x.pipelineDbItemDefault)&&isObjectEmpty(d)?I(x.pipelineDbItemDefault):isObjectEmpty(d)&&u?.surveyState?.pipelineDbItem&&!isObjectEmpty(u?.surveyState?.pipelineDbItem)&&I(u.surveyState.pipelineDbItem)},[d,x?.pipelineDbItemDefault]),React.useCallback(e=>{var t=e?.currentTarget?.getAttribute("goto"),a=e?.currentTarget?.getAttribute("question"),e=C?.current?.value??e?.current?.value??e?.currentTarget?.value;_(t,a,e)})),Y=React.useCallback(e=>{var t=e?.currentTarget?.getAttribute("goto"),a=e?.currentTarget?.getAttribute("question"),e=e?.currentTarget?.getAttribute("value")??e.currentTarget.value;_(t,a,e)}),A=t=>{if(console.log("Do Clear",t),t)for(let e=0;e<t.length;e++)console.log(t[e]?.getAttribute("surveyclear")),t[e]?.getAttribute("surveyclear")&&(t[e].value="",console.log(t[e]),t[e].getAttribute("usedefault"))&&(t[e].value=t[e].getAttribute("usedefault"))},_=(t,a,r)=>{if(console.log(k),N({}),O?.current&&(O.current.innerHTML="",O.current.style.opacity=0),k?.validation&&"function"==typeof k.validation){var e,n=k.validation(k,r);if(console.log(n),n)return(e=E)[s]=n,N(e),O?.current&&(O.current.innerHTML=n,O.current.style.opacity=1),null}if(k?.pipeline?.length)for(let e=0;e<k.pipeline.length;e++)if(k.pipeline[e]?.input&&k.pipeline[e]?.input?.validation&&"function"==typeof k.pipeline[e].input.validation){var l,u=k.pipeline[e]?.input?.validation(k.pipeline[e],y[k.pipeline[e].input.var]);if(u)return console.log(u),(l=E)[s]=u,N(l),O?.current&&(O.current.innerHTML=u,O.current.style.opacity=1),null}o(t),p(s),setTimeout(()=>{m(!0)},100),C?.current&&(C.current.value="",C.current.placeholder="",C.current.select()),setTimeout(()=>{var e;g(!0),t&&(console.log(a),a&&((e=i)[s]||(e[s]={}),e[s].question=a,e[s].answer=r,W(e)),x?.stages[t]?.input&&C?.current&&(Object.prototype.hasOwnProperty.call(x?.stages[t].input,"default")&&(C.current.value=x.stages[t].input.default),Object.prototype.hasOwnProperty.call(x?.stages[t].input,"placeholder"))&&(C.current.placeholder=x.stages[t].input.placeholder),w(t),setTimeout(()=>{A(document.getElementsByTagName("textarea")),A(document.getElementsByTagName("input"))},100)),setTimeout(()=>{o(null),m(null),g(!1)},100)},450),ee(s,!0)},ee=(e,t)=>{var a=c;t&&e?a.push(e):a.pop(),q(a)},te=React.useCallback(e=>{if(0<c.length){const t=c[c.length-1];console.log(t),p(t),setTimeout(()=>{n(!0)},100),setTimeout(()=>{g(!0),t&&(w(t),setTimeout(()=>{A(document.getElementsByTagName("textarea")),A(document.getElementsByTagName("input"))},1)),setTimeout(()=>{p(null),n(null),g(!1)},100),x?.stages[t]?.input&&C?.current&&(Object.prototype.hasOwnProperty.call(x?.stages[t].input,"default")&&(C.current.value=x.stages[t].input.default),Object.prototype.hasOwnProperty.call(x?.stages[t].input,"placeholder"))&&(C.current.placeholder=x.stages[t].input.placeholder)},450),ee(null,!1)}}),j=(React.useEffect(()=>{t||C?.current&&k?.input&&(console.log("Running"),M(!0),C.current.value="",C.current.placeholder="",C.current.select(),Object.prototype.hasOwnProperty.call(k.input,"default")&&(C.current.value=k.input.default),Object.prototype.hasOwnProperty.call(k.input,"placeholder"))&&(C.current.placeholder=k.input.placeholder)},[t,k]),React.useEffect(()=>{console.log(k,v),!k?.submit&&!Z?.submit||v||((async e=>{e&&(e=await sendSurveyEmail(u.apiUrl,u.domainKey,e,x.name,u._loggedIn),console.log(e))})(i),K(!0))},[k,v]),(e,t)=>{var a={...y},r=(a[e]=t,console.log("Temp",a),i);r[s]||(r[s]={}),r[s].pipeline||(r[s].pipeline={}),r[s].pipeline[e]=t,W(r),e=a,u.setSurveyState&&u.surveyState&&((t=u.surveyState).pipelineObject=e,u.setSurveyState(t)),U(e)}),D=React.useCallback(e=>{try{var t,a,r;e&&(t=e?.current?.value??e?.currentTarget?.value,e?.currentTarget?.getAttribute("pipeline")?(console.log(t,"Add to Obj"),j(e?.currentTarget?.getAttribute("var"),t)):13===e.keyCode&&(e.preventDefault(),a=e?.currentTarget?.getAttribute("goto"),r=e?.currentTarget?.getAttribute("question"),console.log(t,r,a),_(a,r,t)))}catch(e){console.log(e)}}),ae=React.useCallback(e=>{console.log(e.currentTarget.checked,e.currentTarget.getAttribute("option")),doSetOptionsMetaData(e,d?.detailmeta,d,I,null,f,b)}),re=React.useCallback(e=>{var t,a;e.currentTarget&&(e?.currentTarget?.getAttribute("pipeline")&&(t=e?.current?.value??e?.currentTarget?.value,console.log(t,"Add to Obj"),j(e?.currentTarget?.getAttribute("var"),t)),t={...d},"singleStyle"===e?.currentTarget?.getAttribute("method"))&&(a=t?.styles[0]?0:-1,console.log(a,e.currentTarget.value,!isNaN(Number(e.currentTarget.value))),-1<a)&&(isNaN(Number(e.currentTarget.value))||("USD"===l?.currency?t.styles[a].price=Number(e.currentTarget.value):(t.styles[a].priceTable||(t.styles[a].priceTable={}),t.styles[a].priceTable[l.currency]=Number(e.currentTarget.value)),I(t)))}),ne=React.useCallback(e=>{var t,a;e.currentTarget&&(e?.currentTarget?.getAttribute("pipeline")&&(t=e?.current?.value??e?.currentTarget?.value,console.log(t,"Add to Obj"),j(e?.currentTarget?.getAttribute("var"),t)),t={...d},"singleStyle"===e?.currentTarget?.getAttribute("method"))&&-1<(a=t?.styles[0]?0:-1)&&(isNaN(Number(e.currentTarget.value))||(t.styles[a].option[0].quantity=Number(e.currentTarget.value)),I(t))}),le=React.useCallback(e=>{console.log(e,"Handle New");const a=e?.currentTarget?.getAttribute("selectmodif");console.log("Sel",a),console.log(R);var e=e?.target?.files,e=Array.from(e).slice(0,1<e.length?1:e.length).filter(e=>e.type&&-1<allowedTypes.indexOf(e.type)).map(e=>{var t=e.slice(0,e.size,e.type),a=allowedTypes[allowedTypes.indexOf(e.type)].match(/\/([a-zA-Z0-9].*)/)[1];return new File([t],uuidv4()+"."+a,{type:e.type})});console.log("Files Renamed",e,R);const r=R,n=S;e&&e.forEach(t=>{r.append("image",t),ce(t,a);var e=n.findIndex(e=>e.name===t.name);-1<e&&n.splice(e,1),n.push({name:t.name,modif:a})}),T(n),h(r),u?.setImgCache&&u.setImgCache(r),u.setSurveyState&&u.surveyState&&((e=u.surveyState).imgFor=n,u.setSurveyState(e))}),ue=React.useCallback(e=>{console.log(e,"Add Temp"),e?.currentTarget?.getAttribute("modif")&&(e=document.querySelector(`input[selectmodif='${e?.currentTarget?.getAttribute("modif")}']`))?.click&&e.click()}),ce=(r,n)=>new Promise((e,t)=>{const a=new FileReader;a.onload=()=>{console.log(a.result),document.querySelector(`img[selectimg=${n}]`).style.backgroundImage=`url(${a.result})`,e(a.result)},a.onerror=()=>{t(a.error)},a.readAsDataURL(r)}),se=(e,t="lineup",a)=>{const r=R,n=S;e&&(e.forEach(e=>{r.append("image",e),n.push({name:e.name,modif:t,id:a})}),r.append("imgNames",JSON.stringify(n))),h(r),T(n),u?.setImgCache&&u.setImgCache(r),u.setSurveyState&&u.surveyState&&((e=u.surveyState).imgFor=n,u.setSurveyState(e))},ie=e=>{var t,a;if(e?.component&&"function"==typeof e.component)return t=e.component,a=Object.assign(e.props,u),React.createElement(t,_extends({},a,{m:e}))},oe=React.useCallback(e=>{e?.currentTarget&&Q(e.currentTarget.clientHeight+"px")});var B=(t,e,a,r,n,l)=>React.createElement("div",{className:`${styles[a]} ${styles.item} ${L&&r?""+styles[r]:null} ${z&&e?""+styles[e]:null} ${H&&n?styles.keepCurrent+" "+styles.backToOriginal:null} ${t?.className} survey_itemContainer`,style:{background:t?.bg??null,color:t?.color??null},onChange:oe,onMouseMove:oe},React.createElement("h1",{className:styles.title+" survey_title"},t?.label),"select"===t?.input?.type?React.createElement("ul",{className:styles.survey__optionsList},t?.input?.options.map(e=>React.createElement("li",{key:e.label},React.createElement("button",{className:styles.survey__optionButton,onClick:Y,goto:e.goto,label:e.label,question:t?.label,value:e.label},e.label)))):"number"===t?.input?.type?React.createElement("div",null,React.createElement("input",{type:"number",className:""+styles.numberInput,defaultValue:t?.input?.default,ref:C})):"text"===t?.input?.type?React.createElement("div",null,React.createElement(TextareaAutosize,{type:"text",className:""+styles.textInput,placeholder:t?.input?.default,minRows:3,ref:C,onKeyDown:D,goto:t?.confirm?.goto,question:t?.label,defaultValue:i[l]?.answer})):t?.component&&"function"==typeof t.component?React.createElement("div",null,ie(t)):null,t?.pipeline?.map?t.pipeline.map((e,t)=>React.createElement("div",{key:t,className:"survey_pipelineItemContainer",style:{marginBottom:".25rem"}},React.createElement("label",{className:"survey_label",style:{lineHeight:"1.5rem"}},e?.label??""),React.createElement("div",{className:"survey_inputContainer",style:{marginTop:".25rem"}},"text"===e?.input?.type?React.createElement("div",{className:e?.className+" survey_textInput"},React.createElement(TextareaAutosize,{type:"text",className:""+styles.textInput,placeholder:e?.input?.default,onInput:D,var:e?.input?.var,pipeline:"true",minRows:e?.input?.rows??1,defaultValue:y[e?.input?.var],usedefault:y[e?.input?.var],surveyclear:"true"})):"datetime-local"===e?.input?.type?React.createElement("div",{className:e?.className+" survey_datetimeInput"},React.createElement("input",{type:"datetime-local",placeholder:e?.input?.default,onInput:D,var:e?.input?.var,pipeline:"true",surveyclear:"true",usedefault:y[e?.input?.var]})):"lineup"===e?.input?.type?React.createElement("div",{className:e?.className+" survey_lineupContainer"},React.createElement(Lineup,_extends({},u,{product:d,editing:d,editingOptionsMeta:d?.detailmeta??null,setOptionsMetaData:ae,currentLineupEditing:f,setCurrentLineupEditing:b,appendFormData:se}))):"price"===e?.input?.type?React.createElement("div",{className:e?.className+" flex gap-p2 survey_price"},React.createElement("span",{className:"survey_currency"},e.symbol??"$"),React.createElement("span",null,React.createElement("input",{type:"text",style:{width:"100%"},onChange:re,var:e?.input?.var,pipeline:"true",surveyclear:"true",method:e?.input?.method,usedefault:!isObjectEmpty(y)&&Object.prototype.hasOwnProperty.call(y,[e?.input?.var])&&null!==y[e?.input?.var]?westernMoneyFormat.format(y[e.input.var]):"10.00"}))):"quantity"===e?.input?.type?React.createElement("div",{className:e?.className+" flex gap-p2 survey_quantity"},React.createElement("span",null,"Qty"),React.createElement("span",null,React.createElement("input",{type:"text",style:{width:"100%"},onChange:ne,var:e?.input?.var,pipeline:"true",surveyclear:"true",method:e?.input?.method,usedefault:!isObjectEmpty(y)&&Object.prototype.hasOwnProperty.call(y,[e?.input?.var])&&null!==y[e?.input?.var]?y[e?.input?.var]:"100"}))):"image"===e?.input?.type&&-1<["leadImg","featureImg"].indexOf(e?.input?.var)?React.createElement("div",{className:e?.className+" survey_image"},React.createElement("div",{style:{height:e?.height??"200px",width:e?.width??"200px"}},(t=>{let a;for(let e=0;e<S.length;e++)t?.input?.var===S[e].modif&&(a=S[e].name);var e=[...R.entries()].filter(([e])=>"image"===e);let r;e.forEach(([,e],t)=>{a===e.name&&(r=e)}),r&&ce(r,t.input.var);e="featureImg"===t.input.var&&pe?u?.cdn?.static+"/"+pe:"leadImg"===t.input.var&&me?u?.cdn?.static+"/"+me:"img/default/greythumb.jpg";return React.createElement("img",{className:"lineup_image",style:{borderRadius:".25rem",backgroundImage:`url(${e})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",width:"100%",height:"100%"},selectimg:t?.input?.var})})(e)),React.createElement("div",{className:"flex gap-p2 "+styles.pseudoButton,style:{alignItems:"center",fontSize:".8rem",marginTop:".5rem"},onClick:ue,modif:e?.input?.var},React.createElement("div",{className:"material-icons",style:{alignSelf:"center"}},"add"),React.createElement("div",null,e?.note)),React.createElement("input",{style:{display:"none"},type:"file",onChange:le,selectmodif:e.input.var})):e?.component?React.createElement("div",{className:e?.className+" survey_myCustomComponent"},ie(e)):e?.jsx?React.createElement("div",{className:e?.className+" survey_myCustomComponent"},e.jsx):null))):null,React.createElement("div",{className:"survey_errorContainer"},React.createElement("div",{className:"error",ref:O,style:{opacity:0}},E[l])),React.createElement("div",{className:"flex survey_confirmBackButtonContainer",style:{direction:"rtl",marginTop:".5rem",justifyContent:"space-between"}},React.createElement("button",{className:styles.confirmButton+" survey_confirmButton",onClick:X,goto:t?.confirm?.goto,label:t?.label,value:"confirm",question:t?.label,style:{opacity:t?.confirm?1:0,transition:0}},t?.confirm?.label?t?.confirm.label:"end"===t?.confirm?.goto?"Confirm":"Next"),c&&0<c.length&&!t?.submit&&!v?React.createElement("button",{onClick:te,className:styles.backButton+" survey_backButton",style:{transition:0}},"Back"):null));const pe=d?.images?d.images.find(e=>e?.bgImg):null,me=d.images?d.images.find(e=>e?.leadImg):null;return console.log(s,i,c,a,v,u,k),console.log("Pipeline Object",y,d,r,a),React.createElement("div",{className:styles.survey__container+" survey_container",style:{height:J,width:"-webkit-fill-available"}},r?B(G,"animatingBackBack","backItem",null,null,r):null,B(k,"animatingBackCurrent","currentItem","animatingNextCurrent",!0,s),a?B(Z,null,"nextItem","animatingNextNext",null,a):null)};export default Module;