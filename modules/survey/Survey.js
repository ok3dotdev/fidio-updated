function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,r=arguments[t];for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}import React from"react";import styles from"./Survey.module.scss";import TextareaAutosize from"react-textarea-autosize";import{sendSurveyEmail}from"../utility/mail";import{Lineup}from"../ecommerce/product";import{isObjectEmpty}from"../util";import{westernMoneyFormat}from"../utility/ecommerce";import{defaultDefinePriceCurrency}from"../ecommerce/product/defaults";import{doSetOptionsMetaData}from"../ecommerce/shop/Functions";import{allowedTypes}from"../ecommerce/product/defaults";import{v4 as uuidv4}from"uuid";const Module=u=>{const[e,P]=React.useState(!1),[t,M]=React.useState(!1),[i,q]=React.useState([]),[c,L]=React.useState(null),[s,$]=React.useState({}),[a,o]=React.useState(null),[r,p]=React.useState(null),[F,m]=React.useState(null),[z,n]=React.useState(null),[H,g]=React.useState(!1),[y,U]=React.useState(u?.surveyState?.pipelineObject??{}),[d,V]=React.useState({}),[v,K]=React.useState(!1),[f,b]=React.useState(0),[l,,]=React.useState(defaultDefinePriceCurrency),[R,h]=React.useState(new FormData),[S,E]=React.useState([]),[T,N]=React.useState({}),[J,Q]=React.useState("100vh"),O=React.useRef(),C=React.useRef(),x=u.survey,k=x?.stages[c],Z=x?.stages[a];var G=x?.stages[r];React.useEffect(()=>{e||(u?.imgCache&&h(u.imgCache),P(!0))},[e,u?.imgCache]);const W=e=>{var t;u.setSurveyState&&u.surveyState&&((t=u.surveyState).answers=e,u.setSurveyState(t)),$(e)},w=e=>{var t;u.setSurveyState&&u.surveyState&&((t=u.surveyState).currentStage=e,u.setSurveyState(t)),L(e),x?.stages&&x.stages[e]&&"function"==typeof x.stages[e]?.func&&x.stages[e].func()},_=(React.useEffect(()=>{!c&&x?.stages?.index&&w("index")},[x,c]),e=>{var t;u.setSurveyState&&u.surveyState&&((t=u.surveyState).pipelineDbItem=e,u.setSurveyState(t)),V(e)}),X=(React.useEffect(()=>{x?.pipelineDbItemDefault&&!isObjectEmpty(x.pipelineDbItemDefault)&&isObjectEmpty(d)?_(x.pipelineDbItemDefault):isObjectEmpty(d)&&u?.surveyState?.pipelineDbItem&&!isObjectEmpty(u?.surveyState?.pipelineDbItem)&&_(u.surveyState.pipelineDbItem)},[d,x?.pipelineDbItemDefault]),React.useCallback(e=>{var t=e?.currentTarget?.getAttribute("goto"),a=e?.currentTarget?.getAttribute("question"),e=O?.current?.value??e?.current?.value??e?.currentTarget?.value;I(t,a,e)})),Y=React.useCallback(e=>{var t=e?.currentTarget?.getAttribute("goto"),a=e?.currentTarget?.getAttribute("question"),r=e?.currentTarget?.getAttribute("value")??e.currentTarget.value,e="true"===e?.currentTarget?.getAttribute("pipeline");I(t,a,r,e)}),A=t=>{if(console.log("Do Clear",t),t)for(let e=0;e<t.length;e++)console.log(t[e]?.getAttribute("surveyclear")),t[e]?.getAttribute("surveyclear")&&(t[e].value="",console.log(t[e]),t[e].getAttribute("usedefault"))&&(t[e].value=t[e].getAttribute("usedefault"))},I=(t,a,r,e)=>{if(console.log(k),N({}),C?.current&&(C.current.innerHTML="",C.current.style.opacity=0),k?.validation&&"function"==typeof k.validation){var n,l=k.validation(k,r);if(console.log(l),l)return(n=T)[c]=l,N(n),C?.current&&(C.current.innerHTML=l,C.current.style.opacity=1),null}if(k?.pipeline?.length)for(let e=0;e<k.pipeline.length;e++)if(k.pipeline[e]?.input&&k.pipeline[e]?.input?.validation&&"function"==typeof k.pipeline[e].input.validation){var u,i=k.pipeline[e]?.input?.validation(k.pipeline[e],y[k.pipeline[e].input.var]);if(i)return console.log(i),(u=T)[c]=i,N(u),C?.current&&(C.current.innerHTML=i,C.current.style.opacity=1),null}if(e)return console.log(t,a,r),!1;o(t),p(c),setTimeout(()=>{m(!0)},100),O?.current&&(O.current.value="",O.current.placeholder="",O.current.select()),setTimeout(()=>{var e;g(!0),t&&(console.log(a),a&&((e=s)[c]||(e[c]={}),e[c].question=a,e[c].answer=r,W(e)),x?.stages[t]?.input&&O?.current&&(Object.prototype.hasOwnProperty.call(x?.stages[t].input,"default")&&(O.current.value=x.stages[t].input.default),Object.prototype.hasOwnProperty.call(x?.stages[t].input,"placeholder"))&&(O.current.placeholder=x.stages[t].input.placeholder),w(t),setTimeout(()=>{A(document.getElementsByTagName("textarea")),A(document.getElementsByTagName("input"))},100)),setTimeout(()=>{o(null),m(null),g(!1)},100)},450),ee(c,!0)},ee=(e,t)=>{var a=i;t&&e?a.push(e):a.pop(),q(a)},te=React.useCallback(e=>{if(0<i.length){const t=i[i.length-1];console.log(t),p(t),setTimeout(()=>{n(!0)},100),setTimeout(()=>{g(!0),t&&(w(t),setTimeout(()=>{A(document.getElementsByTagName("textarea")),A(document.getElementsByTagName("input"))},1)),setTimeout(()=>{p(null),n(null),g(!1)},100),x?.stages[t]?.input&&O?.current&&(Object.prototype.hasOwnProperty.call(x?.stages[t].input,"default")&&(O.current.value=x.stages[t].input.default),Object.prototype.hasOwnProperty.call(x?.stages[t].input,"placeholder"))&&(O.current.placeholder=x.stages[t].input.placeholder)},450),ee(null,!1)}}),j=(React.useEffect(()=>{t||O?.current&&k?.input&&(console.log("Running"),M(!0),O.current.value="",O.current.placeholder="",O.current.select(),Object.prototype.hasOwnProperty.call(k.input,"default")&&(O.current.value=k.input.default),Object.prototype.hasOwnProperty.call(k.input,"placeholder"))&&(O.current.placeholder=k.input.placeholder)},[t,k]),React.useEffect(()=>{!k?.submit&&!Z?.submit||v||((async e=>{e&&(e=await sendSurveyEmail(u.apiUrl,u.domainKey,e,x.name,u._loggedIn),console.log(e))})(s),K(!0))},[k,v]),(e,t,a)=>{var r={...y},n=(a?(r[e]||(r[e]=[]),-1===r[e].indexOf(t)?r[e].push(t):r[e].splice(r[e].indexOf(t),1)):r[e]=t,s);n[c]||(n[c]={}),n[c].pipeline||(n[c].pipeline={}),a?(n[c].pipeline[e]||(n[c].pipeline[e]=[]),-1===n[c].pipeline[e].indexOf(t)?n[c].pipeline[e].push(t):n[c].pipeline[e].splice(n[c].pipeline[e].indexOf(t),1)):n[c].pipeline[e]=t,W(n),a=r,u.setSurveyState&&u.surveyState&&((e=u.surveyState).pipelineObject=a,u.setSurveyState(e)),U(a)}),D=React.useCallback(e=>{try{var t,a,r;e&&(t=e?.target?.getAttribute("useinnerhtml")?e?.target?.innerHTML:e?.target?.value??e?.currentTarget?.value,e?.currentTarget?.getAttribute("pipeline")?(console.log(t,"Add to Obj"),j(e?.currentTarget?.getAttribute("var"),t,e?.target?.getAttribute("usemultiple"))):13===e.keyCode&&(e.preventDefault(),a=e?.currentTarget?.getAttribute("goto"),r=e?.currentTarget?.getAttribute("question"),console.log(t,r,a),I(a,r,t)))}catch(e){console.log(e)}}),ae=React.useCallback(e=>{console.log(e.currentTarget.checked,e.currentTarget.getAttribute("option")),doSetOptionsMetaData(e,d?.detailmeta,d,_,null,f,b)}),re=React.useCallback(e=>{var t,a;e.currentTarget&&(e?.currentTarget?.getAttribute("pipeline")&&(t=e?.current?.value??e?.currentTarget?.value,console.log(t,"Add to Obj"),j(e?.currentTarget?.getAttribute("var"),t)),t={...d},"singleStyle"===e?.currentTarget?.getAttribute("method"))&&(a=t?.styles[0]?0:-1,console.log(a,e.currentTarget.value,!isNaN(Number(e.currentTarget.value))),-1<a)&&(isNaN(Number(e.currentTarget.value))||("USD"===l?.currency?t.styles[a].price=Number(e.currentTarget.value):(t.styles[a].priceTable||(t.styles[a].priceTable={}),t.styles[a].priceTable[l.currency]=Number(e.currentTarget.value)),_(t)))}),ne=React.useCallback(e=>{var t,a;e.currentTarget&&(e?.currentTarget?.getAttribute("pipeline")&&(t=e?.current?.value??e?.currentTarget?.value,console.log(t,"Add to Obj"),j(e?.currentTarget?.getAttribute("var"),t)),t={...d},"singleStyle"===e?.currentTarget?.getAttribute("method"))&&-1<(a=t?.styles[0]?0:-1)&&(isNaN(Number(e.currentTarget.value))||(t.styles[a].option[0].quantity=Number(e.currentTarget.value)),_(t))}),le=React.useCallback(e=>{console.log(e,"Handle New");const a=e?.currentTarget?.getAttribute("selectmodif");console.log("Sel",a),console.log(R);var e=e?.target?.files,e=Array.from(e).slice(0,1<e.length?1:e.length).filter(e=>e.type&&-1<allowedTypes.indexOf(e.type)).map(e=>{var t=e.slice(0,e.size,e.type),a=allowedTypes[allowedTypes.indexOf(e.type)].match(/\/([a-zA-Z0-9].*)/)[1];return new File([t],uuidv4()+"."+a,{type:e.type})});console.log("Files Renamed",e,R);const r=R,n=S;e&&e.forEach(t=>{r.append("image",t),ie(t,a);var e=n.findIndex(e=>e.name===t.name);-1<e&&n.splice(e,1),n.push({name:t.name,modif:a})}),E(n),h(r),u?.setImgCache&&u.setImgCache(r),u.setSurveyState&&u.surveyState&&((e=u.surveyState).imgFor=n,u.setSurveyState(e))}),ue=React.useCallback(e=>{console.log(e,"Add Temp"),e?.currentTarget?.getAttribute("modif")&&(e=document.querySelector(`input[selectmodif='${e?.currentTarget?.getAttribute("modif")}']`))?.click&&e.click()}),ie=(r,n)=>new Promise((e,t)=>{const a=new FileReader;a.onload=()=>{console.log(a.result),document.querySelector(`img[selectimg=${n}]`).style.backgroundImage=`url(${a.result})`,e(a.result)},a.onerror=()=>{t(a.error)},a.readAsDataURL(r)}),ce=(e,t="lineup",a)=>{const r=R,n=S;e&&(e.forEach(e=>{r.append("image",e),n.push({name:e.name,modif:t,id:a})}),r.append("imgNames",JSON.stringify(n))),h(r),E(n),u?.setImgCache&&u.setImgCache(r),u.setSurveyState&&u.surveyState&&((e=u.surveyState).imgFor=n,u.setSurveyState(e))},se=e=>{var t,a;if(e?.component&&"function"==typeof e.component)return t=e.component,a=Object.assign(e?.props??{},u),React.createElement(t,_extends({},a,{m:e}))},oe=React.useCallback(e=>{e?.currentTarget&&Q(e.currentTarget.clientHeight+"px")});var B=(t,e,a,r,n,l)=>React.createElement("div",{className:`${styles[a]} ${styles.item} ${F&&r?""+styles[r]:null} ${z&&e?""+styles[e]:null} ${H&&n?styles.keepCurrent+" "+styles.backToOriginal:null} ${t?.className} survey_itemContainer`,style:{background:t?.bg??null,color:t?.color??null},onChange:oe,onMouseMove:oe},React.createElement("h1",{className:styles.title+" survey_title"},t?.label),"select"===t?.input?.type?React.createElement("ul",{className:styles.survey__optionsList},t?.input?.options.map(e=>React.createElement("li",{key:e.label},React.createElement("button",{className:styles.survey__optionButton,onClick:Y,goto:e.goto,label:e.label,question:t?.label,value:e.label},e.label)))):"number"===t?.input?.type?React.createElement("div",null,React.createElement("input",{type:"number",className:""+styles.numberInput,defaultValue:t?.input?.default,ref:O})):"text"===t?.input?.type?React.createElement("div",null,React.createElement(TextareaAutosize,{type:"text",className:""+styles.textInput,placeholder:t?.input?.default,minRows:3,ref:O,onKeyDown:D,goto:t?.confirm?.goto,question:t?.label,defaultValue:s[l]?.answer})):t?.component&&"function"==typeof t.component?React.createElement("div",null,se(t)):null,t?.pipeline?.map?t.pipeline.map((t,e)=>React.createElement("div",{key:e,className:"survey_pipelineItemContainer",style:{marginBottom:".25rem"}},React.createElement("label",{className:"survey_label",style:{lineHeight:"1.5rem"}},t?.label??""),React.createElement("div",{className:"survey_inputContainer",style:{marginTop:".25rem"}},"text"===t?.input?.type?React.createElement("div",{className:t?.className+" survey_textInput"},React.createElement(TextareaAutosize,{type:"text",className:""+styles.textInput,placeholder:t?.input?.default,onInput:D,var:t?.input?.var,pipeline:"true",minRows:t?.input?.rows??1,defaultValue:y[t?.input?.var],usedefault:y[t?.input?.var],surveyclear:"true"})):"datetime-local"===t?.input?.type?React.createElement("div",{className:t?.className+" survey_datetimeInput"},React.createElement("input",{type:"datetime-local",placeholder:t?.input?.default,onInput:D,var:t?.input?.var,pipeline:"true",surveyclear:"true",usedefault:y[t?.input?.var]})):"lineup"===t?.input?.type?React.createElement("div",{className:t?.className+" survey_lineupContainer"},React.createElement(Lineup,_extends({},u,{product:d,editing:d,editingOptionsMeta:d?.detailmeta??null,setOptionsMetaData:ae,currentLineupEditing:f,setCurrentLineupEditing:b,appendFormData:ce}))):"price"===t?.input?.type?React.createElement("div",{className:t?.className+" flex gap-p2 survey_price"},React.createElement("span",{className:"survey_currency"},t.symbol??"$"),React.createElement("span",null,React.createElement("input",{type:"text",style:{width:"100%"},onChange:re,var:t?.input?.var,pipeline:"true",surveyclear:"true",method:t?.input?.method,usedefault:!isObjectEmpty(y)&&Object.prototype.hasOwnProperty.call(y,[t?.input?.var])&&null!==y[t?.input?.var]?westernMoneyFormat.format(y[t.input.var]):"10.00"}))):"quantity"===t?.input?.type?React.createElement("div",{className:t?.className+" flex gap-p2 survey_quantity"},React.createElement("span",null,"Qty"),React.createElement("span",null,React.createElement("input",{type:"text",style:{width:"100%"},onChange:ne,var:t?.input?.var,pipeline:"true",surveyclear:"true",method:t?.input?.method,usedefault:!isObjectEmpty(y)&&Object.prototype.hasOwnProperty.call(y,[t?.input?.var])&&null!==y[t?.input?.var]?y[t?.input?.var]:"100"}))):"select"===t?.input?.type?React.createElement("ul",{className:styles.survey__optionsList},t?.input?.options.map(e=>React.createElement("li",{key:e.label},React.createElement("button",{className:styles.survey__optionButton+" "+(y&&Object.prototype.hasOwnProperty.call(y,[t?.input?.var])&&(t?.input?.multiple&&-1<y[t.input.var].indexOf(e.label)||y[t.input.var]===e.label)?styles.survey__optionButtonSelected:""),onClick:D,var:t?.input?.var,pipeline:"true",useinnerhtml:"true",usemultiple:t?.input?.multiple?"true":null},e.label)))):"image"===t?.input?.type&&-1<["leadImg","featureImg"].indexOf(t?.input?.var)?React.createElement("div",{className:t?.className+" survey_image"},React.createElement("div",{style:{height:t?.height??"200px",width:t?.width??"200px"}},(t=>{let a;for(let e=0;e<S.length;e++)t?.input?.var===S[e].modif&&(a=S[e].name);var e=[...R.entries()].filter(([e])=>"image"===e);let r;e.forEach(([,e],t)=>{a===e.name&&(r=e)}),r&&ie(r,t.input.var);e="featureImg"===t.input.var&&pe?u?.cdn?.static+"/"+pe:"leadImg"===t.input.var&&me?u?.cdn?.static+"/"+me:"img/default/greythumb.jpg";return React.createElement("img",{className:"lineup_image",style:{borderRadius:".25rem",backgroundImage:`url(${e})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",width:"100%",height:"100%"},selectimg:t?.input?.var})})(t)),React.createElement("div",{className:"flex gap-p2 "+styles.pseudoButton,style:{alignItems:"center",fontSize:".8rem",marginTop:".5rem"},onClick:ue,modif:t?.input?.var},React.createElement("div",{className:"material-icons",style:{alignSelf:"center"}},"add"),React.createElement("div",null,t?.note)),React.createElement("input",{style:{display:"none"},type:"file",onChange:le,selectmodif:t.input.var})):t?.component?React.createElement("div",{className:t?.className+" survey_myCustomComponent"},se(t)):t?.jsx?React.createElement("div",{className:t?.className+" survey_myCustomComponent"},t.jsx):null))):null,React.createElement("div",{className:"survey_errorContainer"},React.createElement("div",{className:"error",ref:C,style:{opacity:0}},T[l])),React.createElement("div",{className:"flex survey_confirmBackButtonContainer",style:{direction:"rtl",marginTop:".5rem",justifyContent:"space-between"}},React.createElement("button",{className:styles.confirmButton+" survey_confirmButton",onClick:X,goto:t?.confirm?.goto,label:t?.label,value:"confirm",question:t?.label,style:{opacity:t?.confirm?1:0,transition:0}},t?.confirm?.label?t?.confirm.label:"end"===t?.confirm?.goto?"Confirm":"Next"),i&&0<i.length&&!t?.submit&&!v?React.createElement("button",{onClick:te,className:styles.backButton+" survey_backButton",style:{transition:0}},"Back"):null));const pe=d?.images?d.images.find(e=>e?.bgImg):null,me=d.images?d.images.find(e=>e?.leadImg):null;return console.log("Pipeline Object",y,d,r,a),React.createElement("div",{className:styles.survey__container+" survey_container",style:{height:J,width:"-webkit-fill-available"}},r?B(G,"animatingBackBack","backItem",null,null,r):null,B(k,"animatingBackCurrent","currentItem","animatingNextCurrent",!0,c),a?B(Z,null,"nextItem","animatingNextNext",null,a):null)};export default Module;