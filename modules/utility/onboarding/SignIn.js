import Cookies from"universal-cookie";import{fetchPost}from"/modules/utility/fetch/fetch.js";import{updateCart}from"/modules/utility/ecommerce/ecommerce.js";import{_LocalEventEmitter}from"/modules/events/LocalEventEmitter";import{fireGlobalEvent}from"../utility";import jwt_decode from"jwt-decode";const cookies=new Cookies,updateLocalLoginSession=e=>{cookies.set("login",e)},doThirdPartySignIn=()=>{},attemptThirdPartySignIn=async function(t,n,i,o,a){try{console.log("Running",t,n,i);let e;var r,s,c,l={domainKey:i,googleData:t,token:e=t&&t.detail&&t.detail.credential?jwt_decode(t.detail.credential):e,encodedToken:t.detail.credential},u=(t.requestedUsername&&(l.requestedUsername=t.requestedUsername),await fetchPost(n+"/m/authenticate",null,null,l));return u&&u.hash&&(o&&o.dispatch("completeSignIn",{data:u}),r={identifier:u.identifier,username:u.username,email:u.email,icon:u.icon,hash:u.hash,vendor:u.vendor??null,icon:u.icon,meta:u.meta},u.plan&&(r.plan=u.plan),u.cart&&(s=JSON.parse(localStorage.getItem("cart")),updateCart(s,u.cart)),u?.admin&&(a(u.admin),r.admin=u.admin),updateLocalLoginSession(r),c=new CustomEvent("mute-login-error",{detail:!0}),document.dispatchEvent(c)),u}catch(e){return console.log(e),null}},checkSignedIn=()=>!!cookies.get("login")&&cookies.get("login"),checkSignedInAndPrompt=(e,t)=>{try{var n=checkSignedIn();return n?n:(e&&e(t||"Please sign in with google to register"),google.accounts.id.prompt(e=>{console.log("on prompt notification",e)}),!1)}catch(e){return e}},logout=()=>{try{cookies.remove("login"),fireGlobalEvent({event:"logout"},_LocalEventEmitter),updateCart("",{items:[],user:null});const e=e=>{e=new CustomEvent("thirdparty-signin",{detail:e});document.dispatchEvent(e)};return setTimeout(()=>{try{google.accounts.id.initialize({client_id:"169701902623-9a74mqcbqr38uj87qm8tm3190cicaa7m.apps.googleusercontent.com",callback:e}),console.log("Google Loaded")}catch(e){console.log(e)}},2e3),!0}catch(e){return console.log(e),!1}},grabUsername=async function(e,t,n,i,o){try{if(!i)return!1;var a=i();if(!(a&&a.identifier&&a.hash))return!1;var r={domainKey:t,identifier:a.identifier,hash:a.hash,proposedUsername:n.proposedUsername},s=await fetchPost(e+"/m/grabusername",null,null,r);if(!s)return!1;if(s.hasOwnProperty("status")&&"success"!==s.status)return"disauthenticated"==s.status?(logout(),"disauthenticated"):s.status;if(s.identifier&&s.username&&s.hash)return a.username=s.username,a.hash=s.hash,a.identifier=s.identifier,updateLocalLoginSession(a),o(a),!0}catch(e){}return!1},checkUserData=async(e,t)=>{if(console.log("Check user data",e,t),t){var n=Object.entries(t).find(e=>!0===e[1]);if(!(e?._loggedIn?.identifier&&e?._loggedIn?.hash&&e.domainKey&&e.apiUrl&&n))return!1;n={domainKey:e.domainKey,identifier:e._loggedIn.identifier,hash:e._loggedIn.hash,ip:e._loggedIn.ip,checkItems:t},t=(console.log(n),await fetchPost(e.apiUrl+"/m/checkuserdata",null,null,n));if(!t)return!1;if(t.hasOwnProperty("status")){if("disauthenticated"==t.status)return logout(),"disauthenticated";if("failed"==t.status)return!1;if("success"==t.status)return console.log("Check user data",t),console.log("must return res"),t}}return null},requestSettingsUpdate=async function(e,t,n,i={},o,a){try{if(!checkSignedIn)return!1;var r=checkSignedIn();if(console.log(r),!(r&&r.identifier&&r.hash)||a)return!1;o(!0);var s=setTimeout(()=>{o(!1)},5e3),c={domainKey:t,identifier:r.identifier,hash:r.hash,change:n},l=(console.log("Shoot req",c),await fetchPost(e+"/m/settingsupdate",null,null,c));if(console.log(l),!l)return o(!1),clearTimeout(s),!1;if(l.hasOwnProperty("status")&&"success"!==l.status)return o(!1),clearTimeout(s),"disauthenticated"==l.status?(logout(),"disauthenticated"):l;if("success"===l.status&&(o(!1),clearTimeout(s),console.log(l),l.user))return updateLocalLoginSession(l.user),i._setLoggedIn(l.user),i._LocalEventEmitter&&i._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}),!0}catch(e){console.log(e)}return!1};export{updateLocalLoginSession,attemptThirdPartySignIn,checkSignedIn,checkSignedInAndPrompt,logout,grabUsername,checkUserData,requestSettingsUpdate};