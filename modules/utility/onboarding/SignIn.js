import Cookies from"universal-cookie";import{fetchPost}from"/modules/utility/fetch/fetch.js";import{updateCart}from"/modules/utility/ecommerce/ecommerce.js";import{_LocalEventEmitter}from"/modules/events/LocalEventEmitter";import{fireGlobalEvent}from"../utility";import jwt_decode from"jwt-decode";const cookies=new Cookies,updateLocalLoginSession=e=>{cookies.set("login",e,{path:"/"})},attemptThirdPartySignIn=async function(t,n,i,a,o){try{console.log("Running",t,n,i);let e;var r,s,c,l,u={domainKey:i,googleData:t,token:e=t&&t.detail&&t.detail.credential?jwt_decode(t.detail.credential):e,encodedToken:t.detail.credential},d=(t.requestedUsername&&(u.requestedUsername=t.requestedUsername),await fetchPost(n+"/m/authenticate",null,null,u));return d&&d.hash&&(a&&a.dispatch("completeSignIn",{data:d}),_LocalEventEmitter&&d?.newUser&&(r={event:"newUser",data:d},_LocalEventEmitter.dispatch("scheduleMail",r),window.dispatchEvent(new CustomEvent("global_event",{detail:Object.assign({},r)}))),s={identifier:d.identifier,username:d.username,email:d.email,icon:d.icon,hash:d.hash,vendor:d.vendor??null,icon:d.icon,meta:d.meta},d.plan&&(s.plan=d.plan),d.cart&&(c=JSON.parse(localStorage.getItem("cart")),updateCart(c,d.cart)),d?.admin&&(o(d.admin),s.admin=d.admin),updateLocalLoginSession(s),l=new CustomEvent("mute-login-error",{detail:!0}),document.dispatchEvent(l)),d}catch(e){return console.log(e),null}},checkSignedIn=()=>!!cookies.get("login")&&cookies.get("login"),checkSignedInAndPrompt=(e,t)=>{try{var n=checkSignedIn();return n?n:(e&&e(t||"Please sign in with google to register"),google.accounts.id.prompt(e=>{console.log("on prompt notification",e)}),!1)}catch(e){return e}},logout=()=>{try{return cookies.remove("login",{path:"/"}),fireGlobalEvent({event:"logout"},_LocalEventEmitter),updateCart("",null,!0),setTimeout(()=>{_LocalEventEmitter.dispatch("attemptInitializeGoogle",{})},2e3),!0}catch(e){return console.log(e),!1}},grabUsername=async function(e,t,n,i,a){try{if(!i)return!1;var o=i();if(!(o&&o.identifier&&o.hash))return!1;var r={domainKey:t,identifier:o.identifier,hash:o.hash,proposedUsername:n.proposedUsername},s=await fetchPost(e+"/m/grabusername",null,null,r);if(!s)return!1;if(s.hasOwnProperty("status")&&"success"!==s.status)return"disauthenticated"==s.status?(logout(),"disauthenticated"):s.status;if(s.identifier&&s.username&&s.hash)return o.username=s.username,o.hash=s.hash,o.identifier=s.identifier,updateLocalLoginSession(o),a(o),!0}catch(e){}return!1},checkUserData=async(e,t)=>{if(console.log("Check user data",e,t),t){var n=Object.entries(t).find(e=>!0===e[1]);if(!(e?._loggedIn?.identifier&&e?._loggedIn?.hash&&e.domainKey&&e.apiUrl&&n))return!1;n={domainKey:e.domainKey,identifier:e._loggedIn.identifier,hash:e._loggedIn.hash,ip:e._loggedIn.ip,checkItems:t},t=(console.log(n),await fetchPost(e.apiUrl+"/m/checkuserdata",null,null,n));if(!t)return!1;if(t.hasOwnProperty("status")){if("disauthenticated"==t.status)return logout(),"disauthenticated";if("failed"==t.status)return!1;if("success"==t.status)return console.log("Check user data",t),console.log("must return res"),t}}return null},requestSettingsUpdate=async function(e,t,n,i={},a,o){try{if(!checkSignedIn)return!1;var r=checkSignedIn();if(console.log(r),!(r&&r.identifier&&r.hash)||o)return!1;a(!0);var s=setTimeout(()=>{a(!1)},5e3),c={domainKey:t,identifier:r.identifier,hash:r.hash,change:n},l=(console.log("Shoot req",c),await fetchPost(e+"/m/settingsupdate",null,null,c));if(console.log(l),!l)return a(!1),clearTimeout(s),!1;if(l.hasOwnProperty("status")&&"success"!==l.status)return a(!1),clearTimeout(s),"disauthenticated"==l.status?(logout(),"disauthenticated"):l;if("success"===l.status&&(a(!1),clearTimeout(s),console.log(l),l.user))return updateLocalLoginSession(l.user),i._setLoggedIn(l.user),i._LocalEventEmitter&&i._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}),!0}catch(e){console.log(e)}return!1};export{updateLocalLoginSession,attemptThirdPartySignIn,checkSignedIn,checkSignedInAndPrompt,logout,grabUsername,checkUserData,requestSettingsUpdate};