import{fetchPost}from"/modules/utility/fetch";import{resolveVariables}from"../../../../app.config";import{updateCart}from"/modules/utility/ecommerce/ecommerce.js";import{_LocalEventEmitter}from"/modules/events/LocalEventEmitter";import{checkSignedIn,updateLocalLoginSession}from"/modules/utility/onboarding/SignIn";import{setStripeSecretData}from"../../payment";export default async function handler(e){if(!e||checkSignedIn())return!1;var t=e.props;t.setFetchBusy(!0);try{var a={email:e.email,firstName:e.firstName,lastName:e.lastName,unregistered:!0},i=await fetchPost(resolveVariables()?.apiUrl+"/m/authenticate",null,null,a);if(!i.status||i.status&&401!==i.status){t.setFetchBusy(!1),_LocalEventEmitter&&_LocalEventEmitter.dispatch("completeSignIn",{data:i}),_LocalEventEmitter&&i?.newUser&&(r={event:"newUser",data:i},_LocalEventEmitter.dispatch("scheduleMail",r),window.dispatchEvent(new CustomEvent("global_event",{detail:Object.assign({},r)})));var r,n={identifier:i.identifier,username:i.username,email:i.email,icon:i.icon,hash:i.hash,vendor:i.vendor??null,icon:i.icon,meta:i.meta},s=(i.plan&&(n.plan=i.plan),n.admin=null,updateLocalLoginSession(n),new CustomEvent("mute-login-error",{detail:!0}));document.dispatchEvent(s);let e;return t&&(e=await setStripeSecretData(t.apiUrl,t.domainKey,n,t._setStripeSecret),t._setLoggedIn(n)),{user:n,stripeSecret:e,stripeSecret:e}}return t.setFetchBusy(!1),!1}catch(e){return t.setFetchBusy(!1),!1}}