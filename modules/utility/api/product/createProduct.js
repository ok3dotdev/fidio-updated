import{fetchPost}from"/modules/utility/fetch";import{defaultStyle,defaultProduct}from"/modules/ecommerce/product/defaults";export default async function handler(a){if(console.log("Create Product Body",a),a?.apiUrl&&a?.pipelineDbItem){const i=new FormData,d=a.pipelineDbItem??defaultProduct(),s=[];Object.entries(a.pipelineObject).map(e=>{switch(e[0]){case"name":d.name=e[1];break;case"description":d.detailmeta.description=e[1];break;case"eventDate":d?.detailmeta||(d.detailmeta=defaultProduct().detailmeta),d?.detailmeta.eventDateDef||(d.detailmeta.eventDateDef={dates:[],input:"",tags:[]}),d.detailmeta.eventDateDef.dates=[e[1]],d.detailmeta.eventDateDef.input=[e[1].toString()],d?.detailmeta.livestreamDef||(d.detailmeta.livestreamDef={dates:[],input:"",tags:[]}),d.detailmeta.livestreamDef.dates=[e[1]],d.detailmeta.livestreamDef.input=[e[1].toString()];break;case"price":d?.styles||0!=d?.styles.length||(d.styles=[defaultStyle()]),d.styles[0].price=e[1];break;case"quantity":d?.styles||0!=d?.styles.length||(d.styles=[defaultStyle()]),d.styles[0].quantity=e[1];break;case"lineup":d?.detailmeta?.lineup&&Array.isArray(e[1])&&e[1].map(e=>{e.image&&e.name&&-1<["lineup"].indexOf(e.modif)&&e.id&&(i.append("image",e.image),s.push({name:e.name,modif:e.modif,id:e.id,title:e.title,time:e.time,description:e.description}))});break;case"images":Array.isArray(e[1])&&e[1].map(e=>{e.image&&e.name&&-1<["leadImg","featureImg","productImg"].indexOf(e.modif)&&(i.append("image",e.image),s.push({name:e.name,modif:e.modif,id:e.id}))});break;default:d.meta[e[0]]=e[1]}});for(let t=0;t<a.imgFor.length;t++){var e=a.imgCache.getAll("image");e&&(e=e.find(e=>e.name===a.imgFor[t].name))&&(i.append("image",e),e={name:e.name,modif:a.imgFor[t].modif,id:a.imgFor[t]?.id??null},"lineup"===a.imgFor[t].modif&&(e.title=a.imgFor[t].title,e.description=a.imgFor[t].description,e.time=a.imgFor[t].time),s.push(e))}console.log(a),i.append("imgNames",JSON.stringify(s)),i.append("hash",a._loggedIn.hash),i.append("identifier",a._loggedIn.identifier),i.append("product",JSON.stringify(d)),i.append("shop",a?.shop?.id??null),i.append("status","publish"),i.append("existing",a.existing);var t=await fetchPost(a.apiUrl+"/m/publishproduct",null,null,i,{formData:!0});if(t&&t.hasOwnProperty("status")){if("disauthenticated"==t.status)return logout(),"disauthenticated";if("failed"==t.status)return!1;if("success"==t.status)return t}}return!1}