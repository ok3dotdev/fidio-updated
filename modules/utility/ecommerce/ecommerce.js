import{fetchPost}from"../fetch/fetch";import{logout}from"/modules/utility/onboarding/SignIn.js";import{isObjectEmpty}from"../../util";import Cookies from"universal-cookie";import{_LocalEventEmitter}from"/modules/events/LocalEventEmitter";import{resolveVariables}from"../../../app.config";const cookies=new Cookies,createShop=async(e,t,r,s)=>{if(r.identifier&&r.hash&&s&&s.shopName){t={domainKey:t,shopData:s,hash:r.hash,identifier:r.identifier},s=await fetchPost(e+"/m/createshop",null,null,t);if(s&&s.hasOwnProperty("status")){if("disauthenticated"==s.status)return logout(),"disauthenticated";if("failed"==s.status)return!1;if("success"==s.status)return s}}return!1},doPublishProduct=async(e,t,r,s,i,o)=>{if(s.identifier&&s.hash&&i&&t){s=await fetchPost(e+"/m/publishproduct",null,null,o,{formData:!0});if(s&&s.hasOwnProperty("status")){if("disauthenticated"==s.status)return logout(),"disauthenticated";if("failed"==s.status)return!1;if("success"==s.status)return s}}return!1},resolveImg=(e,t,r)=>r||"img/default/greythumb_product.jpg",resolveStyles=e=>e&&e.styles?e.styles:[],resolveCurrentPrice=(e,t,r)=>{if(console.log(e,t,r),e&&e.styles){var s=e.styles.find(e=>e.sid===t);if(s&&Object.prototype.hasOwnProperty.call(s,"price"))return""+r+s.price;if(e.styles[0]&&Object.prototype.hasOwnProperty.call(e.styles[0],"price"))return""+r+e.styles[0].price}return""},resolveCurrentStyle=(e,t)=>{return e&&e.styles?e.styles.find(e=>e.sid===t):""},resolveCurrentOption=(e,t)=>{return e&&e.option?e.option.find(e=>e.sid===t):""},resolveDefaultStyle=(e,t,r,s,i)=>{isObjectEmpty(t)&&e&&e.styles&&e.styles[0]&&e.styles[0].sid&&(r(e.styles[0].sid),!s)&&e.styles[0].option&&e.styles[0].option[0]&&e.styles[0].option[0].sid&&i(e.styles[0].option[0].sid)},updateCart=(e,t,r)=>r?(localStorage.removeItem("cart"),{}):(localStorage.setItem("cart",JSON.stringify(t)),_LocalEventEmitter.dispatch("forceUpdateProps",{dispatch:"_cart"}),t),calculateTotal=(e,t,r,s)=>{const i=[];let o=0;return e&&e.items&&e.items.map(e=>{var t=resolveCurrentStyle(e.product,e.style);t&&Object.prototype.hasOwnProperty.call(t,"price")&&(t="USD"===r?.region?.currency?t.price:r?.region?.currency&&t?.priceTable&&Object.prototype.hasOwnProperty.call(t.priceTable,r.region.currency)?t.priceTable[r.region.currency]:s?resolveRegionBasedPrice(s,t)?.price:t.price,i.push(Object.assign(e,{price:t})),o+=t*e.quantity)}),r&&r.object?{prices:i,total:o}:t?t+o:o},doUploadImageForProduct=async(e,t,r,s,i)=>{if(s.identifier&&s.hash&&r&&t){s=await fetchPost(e+"/m/uploadimageforproduct",null,null,i,{formData:!0});if(s&&s.hasOwnProperty("status")){if("disauthenticated"==s.status)return logout(),"disauthenticated";if("failed"==s.status)return!1;if("success"==s.status)return s}}return!1},doUploadImageForLineupParticipant=async(e,t,r,s,i)=>{if(s.identifier&&s.hash&&r&&t){s=await fetchPost(e+"/m/uploadimageforlineupparticipant",null,null,i,{formData:!0});if(s&&s.hasOwnProperty("status")){if("disauthenticated"==s.status)return logout(),"disauthenticated";if("failed"==s.status)return!1;if("success"==s.status)return s}}return!1},addToCartGlobal=async(e,t,r,s,i,o,a,n)=>{try{var l,c;if(console.log(e,t,r,s,i,o,a,n),i&&t&&e)return a(!0),l={domainKey:t,hash:r?.hash,identifier:r?.identifier,cart:s,product:i,spec:o,options:n},c=await fetchPost(e+"/m/addtocart",null,null,l),a(!1),!!c&&(c.hasOwnProperty("status")?"disauthenticated"==c.status?(logout(),"disauthenticated"):"failed"!=c.status&&("success"==c.status?c:void 0):void 0)}catch(e){return console.log(e),a&&a(!1),{status:"failed",message:"Could not add Product to cart"}}},addToCart=async(e,t,r,s,i,o,a,n)=>{try{if(console.log(e,t,r,i,o,s),r&&r.identifier&&r.hash&&i&&t&&e&&i&&i.styles&&o.style&&o.option){var l=i.styles.find(e=>e.sid===o.style);if(l&&l.option){var c=l.option.find(e=>e.sid===o.option);if(c&&c.quantity&&(0<c.quantity||-100===c.quantity)&&(console.log(s,i,o,n),a)){a(!0);var u={domainKey:t,hash:r.hash,identifier:r.identifier,cart:s,product:i,spec:o,options:n},d=await fetchPost(e+"/m/addtocart",null,null,u);if(a(!1),!d)return!1;if(d.hasOwnProperty("status")){if("disauthenticated"==d.status)return logout(),"disauthenticated";if("failed"==d.status)return!1;if("success"==d.status)return d}}}}throw new Error}catch(e){return console.log(e),a&&a(!1),{status:"failed",message:"Could not add Product to cart"}}},getUseCartOfCurrency=(r,e)=>{const t=e?.items&&e.items[0];if(t?.product?.styles){var s=t.product.styles.find(e=>e.sid===t.style);if(s){const i=resolveRegionBasedPrice(r,s);if(console.log(i),i){const o=[];s={items:e.items.filter(t=>{var e=t.product.styles.find(e=>e.sid===t.style);if(e){e=resolveRegionBasedPrice(r,e);if(e&&e.currency===i.currency)return!0}return o.push(t),!1}),currency:i,user:e.user};return s.remaining=o,s}}}},performPurchase=async(e,t,r,s,i,o)=>{try{var a=resolveVariables();if(a.paymentConfig&&a.dev){var n=a.paymentConfig?.keys?.stripe.match("live"),l=a.paymentConfig?.keys?.paystack.match("live");if(n||l)return console.log("Payment Cancelled: Some Payment Processing Keys are live but you are in development mode."),!1}if(r&&r.identifier&&r.hash&&s&&t&&e&&i){i(!0);var c={domainKey:t,hash:r.hash,identifier:r.identifier,cart:s,options:o},u=await fetchPost(e+"/m/performpurchase",null,null,c);if(i(!1),!u)return!1;if(u.hasOwnProperty("status")){if("disauthenticated"==u.status)return logout(),"disauthenticated";if("failed"==u.status)return!!u.message&&u;if("success"==u.status)return u}}throw new Error}catch(e){return console.log(e),i&&i(!1),{status:"failed",message:"Could not perform purchase"}}},westernMoneyFormat=new Intl.NumberFormat("en-US",{minimumIntegerDigits:1,minimumFractionDigits:2,maximumFractionDigits:2}),resolveMoneyFormat=e=>{try{return isNaN(Number(e))||null===e?null:westernMoneyFormat.format(e)}catch(e){return console.log(e),null}},resolveRegionBasedPrice=(e,t,r)=>{if(r)return{currency:r.currency??null,symbol:r.symbol??null,price:r.price??null};r=e?._loggedIn?.meta?.locationMeta?.country??"US";if(r&&e?.regionsData&&e.regionsData[r]&&t?.priceTable){if(Object.prototype.hasOwnProperty.call(t.priceTable,e.regionsData[r].currency))return{currency:e.regionsData[r].currency,symbol:e.regionsData[r].symbol,price:t.priceTable[e.regionsData[r].currency]};{const s=e.regionsData[r].region;r=Object.entries(e.regionsData).find(e=>!(e[1].region!==s||!Object.prototype.hasOwnProperty.call(t.priceTable,e[1].currency)));if(r&&r[1])return{currency:r[1].currency,symbol:r[1].symbol,price:t.priceTable[r[1].currency]}}}return{currency:"USD",symbol:"$",price:t&&Object.prototype.hasOwnProperty.call(t,"price")?t.price:null}},resolveOption=(e,t,r,s=!1)=>{if(e&&e.styles&&t){e=e.styles.find(e=>e.sid===t);if(e.option){e=e.option.find(e=>e.sid===r);if(s&&e)return e;if(e&&e.option)return e.option}}return""};export{createShop,doPublishProduct,resolveImg,resolveStyles,resolveCurrentPrice,resolveCurrentStyle,resolveCurrentOption,resolveDefaultStyle,updateCart,calculateTotal,doUploadImageForProduct,doUploadImageForLineupParticipant,addToCartGlobal,addToCart,getUseCartOfCurrency,performPurchase,westernMoneyFormat,resolveMoneyFormat,resolveRegionBasedPrice,resolveOption};