import{fetchPost}from"../fetch/fetch";import{logout}from"/modules/utility/onboarding/SignIn.js";import{isObjectEmpty}from"../../util";import Cookies from"universal-cookie";import{_LocalEventEmitter}from"/modules/events/LocalEventEmitter";import{resolveVariables}from"../../../app.config";const cookies=new Cookies,createShop=async(t,e,r,s)=>{if(r.identifier&&r.hash&&s&&s.shopName){e={domainKey:e,shopData:s,hash:r.hash,identifier:r.identifier},s=await fetchPost(t+"/m/createshop",null,null,e);if(s&&s.hasOwnProperty("status")){if("disauthenticated"==s.status)return logout(),"disauthenticated";if("failed"==s.status)return!1;if("success"==s.status)return s}}return!1},doPublishProduct=async(t,e,r,s,i,o)=>{if(s.identifier&&s.hash&&i&&e){s=await fetchPost(t+"/m/publishproduct",null,null,o,{formData:!0});if(s&&s.hasOwnProperty("status")){if("disauthenticated"==s.status)return logout(),"disauthenticated";if("failed"==s.status)return!1;if("success"==s.status)return s}}return!1},resolveImg=(t,e,r)=>r||"img/default/greythumb_product.jpg",resolveStyles=t=>t&&t.styles?t.styles:[],resolveCurrentPrice=(t,e,r)=>{if(console.log(t,e,r),t&&t.styles){var s=t.styles.find(t=>t.sid===e);if(s&&Object.prototype.hasOwnProperty.call(s,"price"))return""+r+s.price;if(t.styles[0]&&Object.prototype.hasOwnProperty.call(t.styles[0],"price"))return""+r+t.styles[0].price}return""},resolveCurrentStyle=(t,e)=>{return t&&t.styles?t.styles.find(t=>t.sid===e):""},resolveCurrentOption=(t,e)=>{return t&&t.option?t.option.find(t=>t.sid===e):""},resolveDefaultStyle=(t,e,r,s,i)=>{isObjectEmpty(e)&&t&&t.styles&&t.styles[0]&&t.styles[0].sid&&(r(t.styles[0].sid),!s)&&t.styles[0].option&&t.styles[0].option[0]&&t.styles[0].option[0].sid&&i(t.styles[0].option[0].sid)},updateCart=(t,e)=>(localStorage.setItem("cart",JSON.stringify(e)),_LocalEventEmitter.dispatch("forceUpdateProps",{dispatch:"_cart"}),e),calculateTotal=(t,e,r,s)=>{const i=[];let o=0;return t&&t.items&&t.items.map(t=>{var e=resolveCurrentStyle(t.product,t.style);e&&Object.prototype.hasOwnProperty.call(e,"price")&&(e="USD"===r?.region?.currency?e.price:r?.region?.currency&&e?.priceTable&&Object.prototype.hasOwnProperty.call(e.priceTable,r.region.currency)?e.priceTable[r.region.currency]:s?resolveRegionBasedPrice(s,e)?.price:e.price,i.push(Object.assign(t,{price:e})),o+=e*t.quantity)}),r&&r.object?{prices:i,total:o}:e?e+o:o},doUploadImageForProduct=async(t,e,r,s,i)=>{if(s.identifier&&s.hash&&r&&e){s=await fetchPost(t+"/m/uploadimageforproduct",null,null,i,{formData:!0});if(s&&s.hasOwnProperty("status")){if("disauthenticated"==s.status)return logout(),"disauthenticated";if("failed"==s.status)return!1;if("success"==s.status)return s}}return!1},doUploadImageForLineupParticipant=async(t,e,r,s,i)=>{if(s.identifier&&s.hash&&r&&e){s=await fetchPost(t+"/m/uploadimageforlineupparticipant",null,null,i,{formData:!0});if(s&&s.hasOwnProperty("status")){if("disauthenticated"==s.status)return logout(),"disauthenticated";if("failed"==s.status)return!1;if("success"==s.status)return s}}return!1},addToCartGlobal=async(t,e,r,s,i,o,a,n)=>{try{var l,c;if(console.log(t,e,r,s,i,o,a,n),r&&r.identifier&&r.hash&&i&&e&&t)return a(!0),l={domainKey:e,hash:r.hash,identifier:r.identifier,cart:s,product:i,spec:o,options:n},c=await fetchPost(t+"/m/addtocart",null,null,l),a(!1),!!c&&(c.hasOwnProperty("status")?"disauthenticated"==c.status?(logout(),"disauthenticated"):"failed"!=c.status&&("success"==c.status?c:void 0):void 0)}catch(t){return console.log(t),a&&a(!1),{status:"failed",message:"Could not add Product to cart"}}},addToCart=async(t,e,r,s,i,o,a,n)=>{try{if(console.log(t,e,r,i,o,s),r&&r.identifier&&r.hash&&i&&e&&t&&i&&i.styles&&o.style&&o.option){var l=i.styles.find(t=>t.sid===o.style);if(l&&l.option){var c=l.option.find(t=>t.sid===o.option);if(c&&c.quantity&&(0<c.quantity||-100===c.quantity)&&(console.log(s,i,o,n),a)){a(!0);var u={domainKey:e,hash:r.hash,identifier:r.identifier,cart:s,product:i,spec:o,options:n},d=await fetchPost(t+"/m/addtocart",null,null,u);if(a(!1),!d)return!1;if(d.hasOwnProperty("status")){if("disauthenticated"==d.status)return logout(),"disauthenticated";if("failed"==d.status)return!1;if("success"==d.status)return d}}}}throw new Error}catch(t){return console.log(t),a&&a(!1),{status:"failed",message:"Could not add Product to cart"}}},performPurchase=async(t,e,r,s,i,o)=>{try{var a=resolveVariables();if(a.paymentConfig&&a.dev){var n=a.paymentConfig?.keys?.stripe.match("live"),l=a.paymentConfig?.keys?.paystack.match("live");if(n||l)return console.log("Payment Cancelled: Some Payment Processing Keys are live but you are in development mode."),!1}if(r&&r.identifier&&r.hash&&s&&e&&t&&i){i(!0);var c={domainKey:e,hash:r.hash,identifier:r.identifier,cart:s,options:o},u=await fetchPost(t+"/m/performpurchase",null,null,c);if(i(!1),!u)return!1;if(u.hasOwnProperty("status")){if("disauthenticated"==u.status)return logout(),"disauthenticated";if("failed"==u.status)return!!u.message&&u;if("success"==u.status)return u}}throw new Error}catch(t){return console.log(t),i&&i(!1),{status:"failed",message:"Could not perform purchase"}}},westernMoneyFormat=new Intl.NumberFormat("en-US",{minimumIntegerDigits:1,minimumFractionDigits:2,maximumFractionDigits:2}),resolveMoneyFormat=t=>{try{return isNaN(Number(t))||null===t?null:westernMoneyFormat.format(t)}catch(t){return console.log(t),null}},resolveRegionBasedPrice=(t,e,r)=>{if(r)return{currency:r.currency??null,symbol:r.symbol??null,price:r.price??null};if(t?._loggedIn?.meta?.locationMeta?.country&&t?.regionsData){r=t._loggedIn.meta.locationMeta.country;if(t.regionsData[r]&&e?.priceTable){if(Object.prototype.hasOwnProperty.call(e.priceTable,t.regionsData[r].currency))return{currency:t.regionsData[r].currency,symbol:t.regionsData[r].symbol,price:e.priceTable[t.regionsData[r].currency]};{const s=t.regionsData[r].region;r=Object.entries(t.regionsData).find(t=>!(t[1].region!==s||!Object.prototype.hasOwnProperty.call(e.priceTable,t[1].currency)));if(r&&r[1])return{currency:r[1].currency,symbol:r[1].symbol,price:e.priceTable[r[1].currency]}}}}return{currency:"USD",symbol:"$",price:e&&Object.prototype.hasOwnProperty.call(e,"price")?e.price:null}},resolveOption=(t,e,r,s=!1)=>{if(t&&t.styles&&e){t=t.styles.find(t=>t.sid===e);if(t.option){t=t.option.find(t=>t.sid===r);if(s&&t)return t;if(t&&t.option)return t.option}}return""};export{createShop,doPublishProduct,resolveImg,resolveStyles,resolveCurrentPrice,resolveCurrentStyle,resolveCurrentOption,resolveDefaultStyle,updateCart,calculateTotal,doUploadImageForProduct,doUploadImageForLineupParticipant,addToCartGlobal,addToCart,performPurchase,westernMoneyFormat,resolveMoneyFormat,resolveRegionBasedPrice,resolveOption};