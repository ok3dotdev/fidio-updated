function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,l=arguments[t];for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a])}return e}).apply(this,arguments)}import React from"react";import Link from"next/link";import{v4 as uuidv4}from"uuid";import TextareaAutosize from"react-textarea-autosize";import StorageAdmin from"./StorageAdmin";import Tooltip from"@mui/material/Tooltip";import AdminStyles from"./Admin.module.scss";import{logout}from"../utility/onboarding/SignIn";import{fetchPost}from"../utility/fetch";import{isObjectEmpty,throttleFunctionCall}from"../util";import{loadArticle,publishArticle,deleteArticle}from"./article/utility";import{selectThisText}from"../utility/utility/event";import toolbarOptions from"./editor/toolbarOptions";const moduleName="PostAdmin",editorElementId="admin_editor_element",defaultText="Let's start a conversation.",useToolbarOptions=toolbarOptions,Module=t=>{const[a,l]=React.useState(!1),[,r]=React.useState(null),[e,,]=React.useState(!1),[n,c]=React.useState(0);var[,,]=React.useState("admin");const[i,s]=React.useState([]),[o,m]=React.useState([]),[d,u]=React.useState(!1),[p,g]=React.useState({}),[R,f]=React.useState([]),[h,v]=React.useState(!1),[E,y]=React.useState([]),[b,,]=React.useState(0),[x,S]=React.useState(!0),N=React.useRef(),T=React.useRef(),A=React.useRef(),k=React.useRef(),w=React.useRef(),I=React.useRef();var P=React.useRef();const C=defaultText,_=(t._LocalEventEmitter.unsubscribe(moduleName),t._LocalEventEmitter.subscribe(moduleName,e=>{var t,a;e&&"loadDefault"!==e.dispatch&&"save"===e.dispatch&&localStorage&&T?.current&&(e=T.current.getText(),t=T.current.getContents(),a=_(t).flat(100).filter(Boolean),f(a),e.length>C.length+25)&&(d||t&&localStorage.setItem("cached_post_admin",JSON.stringify({title:N?.current?.value,content:t,groups:i,tags:o})))}),e=>Object.entries(e).map(e=>"object"==typeof e[1]?_(e[1]):"image"===e[0]?e[1]:void 0)),L=(React.useEffect(()=>{var e;a||(e=uuidv4(),r(e),setInterval(()=>{t._LocalEventEmitter.dispatch(moduleName,{dispatch:"save"})},7500),L(),l(!0))},[a]),async()=>{var e={domainKey:t.domainKey,hash:t._loggedIn.hash,identifier:t._loggedIn.identifier,postOffset:100*b},e=await fetchPost(t.apiUrl+"/a/recentarticles",null,null,e);return!!e&&(e.hasOwnProperty("status")?"disauthenticated"==e.status?(logout(),"disauthenticated"):"failed"!=e.status&&("success"==e.status?(e?.data&&y(e.data),e):void 0):void 0)}),U=()=>{var e=n;e+=1,c(e);try{new window.Quill("#"+editorElementId,{modules:{toolbar:useToolbarOptions},theme:"snow"})}catch(e){}};React.useEffect(()=>{window?.Quill&&!e&&n<3&&document.getElementById(editorElementId)&&throttleFunctionCall(t._LocalEventEmitter,"_initializeEditor",1e3,U,[])},[e,n]);try{if(document.getElementsByClassName("ql-toolbar")){var O=document.getElementsByClassName("ql-toolbar");if(1<O.length)for(let e=0;e<O.length-1;e++)O[e]&&O[e].remove&&O[e].remove()}}catch(e){}var W=React.useCallback(e=>{var t;e?.currentTarget?.getAttribute&&e.currentTarget.getAttribute("modif")&&(t=e.currentTarget.getAttribute("modif"),e=e?.currentTarget?.value?.split?e.currentTarget.value.split(" "):[],"groups"===t?s(e):"tags"===t&&m(e))}),B=React.useCallback(e=>{publishArticle(t,d,N,i,o,m,s,k,A,T,p,v,u,L,C,x,S,w,R)}),j=React.useCallback(e=>{deleteArticle(t,d,N,m,s,k,A,T,u,L,C)});const z=React.useCallback(e=>{e?.currentTarget?.getAttribute&&(e=e.currentTarget.getAttribute("article"))&&loadArticle(t,e,T,N,A,k,s,m,u,S,w,g,f)});var D=React.useCallback(e=>{e?.currentTarget&&S(e.currentTarget.checked)}),$=React.useCallback(e=>{var t;e?.currentTarget&&((t=p).featuredImg=e.currentTarget.value,g(t),I?.current)&&(I.current.style.backgroundImage=`url(${t.featuredImg})`)});return React.createElement("div",{className:`${t.className} ${moduleName}_Container`},React.createElement("h3",null,"Post"),React.createElement("div",{className:""+AdminStyles.containerTwoSmallRight},React.createElement("div",{className:"Editor_Container Editor_MaxWidth"},React.createElement("div",null,React.createElement(TextareaAutosize,{className:""+AdminStyles.millerText,type:"text",placeholder:"Title",style:{fontStyle:"italic",width:"100%",fontSize:"2rem",fontWeight:"700"},ref:N})),React.createElement("div",{style:{fontSize:"1.125rem",marginBottom:".25rem",color:"#cccccc",fontWeight:"600"}},React.createElement("div",{className:""+AdminStyles.millerText,style:{fontStyle:"italic"}},React.createElement(Link,{href:"/p?u="+(d?.authorUsername??t?._loggedIn?.username??""),style:{alignSelf:"center"}},React.createElement("span",null,"by: "),React.createElement("span",null,d?.authorUsername??t?._loggedIn?.username??"")))),React.createElement("div",null,d?.title?React.createElement("div",{style:{background:"rgba(55, 55, 55, 1)",borderRadius:".5rem",padding:".25rem",width:"100%",textAlign:"center",marginBottom:".25rem"}},React.createElement("span",null,"Read "),React.createElement(Link,{href:t.devLocal?t.devAddress+"/a?p="+d?.id:`https://${t.domainUrl}/a?p=`+d?.id},'"',d?.title,'"'),React.createElement("span",null," at "),React.createElement("span",{selectValue:t.devLocal?t.devAddress+"/a?p="+d?.id:`https://${t.domainUrl}/a?p=`+d?.id,onClick:selectThisText},t.devLocal?t.devAddress+"/a?p="+d?.id:t.domainUrl+"/a?p="+d?.id)):null),React.createElement("div",{id:""+editorElementId,className:"Editor_Platform",style:{marginBottom:".25rem"}},React.createElement("p",null,C)),React.createElement("div",{className:AdminStyles.metaContainer+" flex gap-p2",style:{marginBottom:".25rem"}},React.createElement("div",{className:"flex gap-p2",style:{flexDirection:"column"}},React.createElement("div",{style:{minWidth:"200px"}},React.createElement("div",{style:{whiteSpace:"nowrap"}},"Featured Image"),React.createElement("input",{type:"text",placeholder:"Featured Image Url",style:{width:"100%",fontWeight:"600"},defaultValue:""+(p?.featuredImg??""),onChange:$,ref:P})),React.createElement("img",{style:{backgroundImage:"url("+(p?.featuredImg??null),height:"100px",width:"100%",minWidth:"100px",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},selectValue:""+(p?.featuredImg??null),onClick:selectThisText,ref:I})),React.createElement("div",{className:"flex gap-p2",style:{width:"100%"}},React.createElement("div",{style:{width:"100%"}},React.createElement("div",{className:"flex gap-p2"},React.createElement("div",null,"Groups"),React.createElement("input",{type:"text",id:moduleName+"_groupingInput",placeholder:"Post Groups",style:{width:"100%",fontWeight:"600"},onInput:W,modif:"groups",ref:A})),0<i?.length?React.createElement("div",{className:"tagContainer",style:{marginTop:".25rem"}},i.map(e=>""!==e?React.createElement("div",{className:"tagItem"},e):React.createElement("div",null))):null),React.createElement("div",{style:{width:"100%"}},React.createElement("div",{className:"flex gap-p2"},React.createElement("div",null,"Tags"),React.createElement("input",{type:"text",id:moduleName+"_useTagsInput",placeholder:"Tags",style:{width:"100%",fontWeight:"600"},onInput:W,modif:"tags",ref:k})),0<o?.length?React.createElement("div",{className:"tagContainer",style:{marginTop:".25rem"}},o.map(e=>""!==e?React.createElement("div",{className:"tagItem"},e):React.createElement("div",null))):null))),React.createElement("div",{className:AdminStyles.forceSafeBreak+" flex gap-p2"},d?React.createElement("div",{className:"flex gap-p2"},React.createElement("button",{style:{minWidth:"200px",maxWidth:"90%"},onClick:B},"Update"),React.createElement("button",{style:{minWidth:"200px",maxWidth:"90%"},onClick:j},"Delete")):React.createElement("button",{className:""+AdminStyles.actionButton,onClick:B},"Post"),React.createElement("div",{className:"flex gap-p2",style:{background:"rgb(55, 55, 55)",borderRadius:"1rem",padding:"0 2rem",justifyContent:"center"}},React.createElement("label",null,"Approved"),React.createElement("input",{type:"checkbox",ref:w,defaultChecked:!0,onChange:D}))),h&&d?.id?React.createElement("div",{style:{marginTop:".5rem"}},React.createElement("div",{style:{background:"rgba(55, 55, 55, 1)",borderRadius:".5rem",padding:".25rem",width:"100%",textAlign:"center"}},"Your post was made successsfully. View at ",React.createElement(Link,{href:t.devLocal?t.devAddress+"/a?p="+d?.id:`https://${t.domainUrl}/a?p=`+d?.id},t.devLocal?t.devAddress+"/a?p="+d?.id:t.domainUrl+"/a?p="+d?.id))):null),React.createElement("div",null,React.createElement("div",{style:{marginBottom:".5rem"}},React.createElement("h4",{style:{fontWeight:"600"}},"Recent Articles"),React.createElement("div",{className:AdminStyles.simpleList+" "+AdminStyles.simpleListShortText,style:{maxHeight:"200px",overflow:"auto"}},0<E?.length?E.map((e,t)=>React.createElement("div",{style:{background:"rgb(53, 53, 53)"}},React.createElement("span",{style:{cursor:"pointer"},article:e?.id,onClick:z},e.title),React.createElement("span",null,!e.publish||isNaN(Number(e.publish))||isNaN(new Date(Number(e.publish)))?"":" - "+new Date(Number(e.publish)).toDateString()))):null)),React.createElement("div",null,React.createElement(StorageAdmin,_extends({},t,{vert:!0}))))))};export default Module;