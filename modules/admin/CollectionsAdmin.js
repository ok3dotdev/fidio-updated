function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,l=arguments[t];for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a])}return e}).apply(this,arguments)}import React from"react";import{debounce}from"../util";import{v4 as uuidv4}from"uuid";import AdminStyles from"./Admin.module.scss";import{logout}from"../utility/onboarding/SignIn";import{fetchPost}from"../utility/fetch";import{printRecursiveObject}from"../utility/utility/data";import Tooltip from"@mui/material/Tooltip";import{IndexHello}from"/modules/presentation/hello/IndexHello";const moduleName="DatabaseAdmin",DO_SEARCH_DELAY=1500,Module=n=>{const[t,a]=React.useState(!1),[,j]=React.useState(null),[i,L]=React.useState(null),[o,l]=React.useState(null),[s,d]=React.useState(!1),[m,u]=React.useState(null),[f,H]=React.useState(0),[c,M]=React.useState(0),[p,K]=React.useState(null),[g,h]=React.useState(null),[R,y]=React.useState(null),[U,r]=React.useState(null),[v,E]=React.useState(null),[b,V]=React.useState(null),[C,W]=React.useState(null),[N,$]=React.useState([]),S=React.useRef(),T=React.useRef(),A=React.useRef(),x=(n._LocalEventEmitter.unsubscribe(moduleName),n._LocalEventEmitter.subscribe(moduleName,e=>{var t;e&&("loadDefault"===e.dispatch?x():"search"===e.dispatch&&null!==(t=S?.current?.value)&&k(t,"master"===e.hierarchy?"collections":o,e.hierarchy))}),React.useEffect(()=>{var e;t||(e=uuidv4(),j(e),x(),a(!0))},[t]),async()=>{var e={domainKey:n.domainKey,hash:n._loggedIn.hash,identifier:n._loggedIn.identifier},e=await fetchPost(n.apiUrl+"/a/databasecruddefaults",null,null,e);return!!e&&(e.hasOwnProperty("status")?"disauthenticated"==e.status?(logout(),"disauthenticated"):"failed"!=e.status&&("success"==e.status?(e?.data&&(L(e.data),!o&&e?.data?.model[0]&&e.data.model[0].table&&l(e.data.model[0].table),e?.newModelDefaults)&&W(e.newModelDefaults),e):void 0):void 0)}),Y=React.useCallback(e=>{e?.currentTarget?.getAttribute&&(e=e.currentTarget.getAttribute("modif"))&&(l(e),setTimeout(()=>{n._LocalEventEmitter.dispatch(moduleName,{dispatch:"search"})},150))}),k=async(e,t,a)=>{let l;try{var c,r;if(!s)return l=setTimeout(()=>{d(!1)},1e4),c={domainKey:n.domainKey,hash:n._loggedIn.hash,identifier:n._loggedIn.identifier,table:t,value:e,offset:f},(r=await fetchPost(n.apiUrl+"/a/databaserecordssearch",null,null,c))?r.hasOwnProperty("status")?(d(!1),clearTimeout(l),"disauthenticated"==r.status?(logout(),"disauthenticated"):"failed"!=r.status&&("success"==r.status?(r?.data&&("master"===a?V:u)(r.data),r):void 0)):void 0:(d(!1),clearTimeout(l),!1)}catch(e){d(!1),clearTimeout(l)}};var e=React.useCallback(debounce(e=>{var t;e?.target&&(t=e.target.value,e=e.target.getAttribute("hierarchy"),void 0!==t)&&(P(),k(t,"master"===e?"collections":o,e))},DO_SEARCH_DELAY),[o]);const _=React.useCallback(e=>{var t=e.currentTarget.getAttribute("scope");const a=e.currentTarget.getAttribute("hierarchy");t&&(e=e.currentTarget.getAttribute("i"),"itemOffset"===t&&("master"===a?M:H)(Number(e)),setTimeout(()=>{n._LocalEventEmitter.dispatch(moduleName,{dispatch:"search",hierarchy:a})},150))}),w=React.useCallback(e=>{if(P(),e?.currentTarget?.getAttribute){const a=e.currentTarget.getAttribute("modif");var t,e=e.currentTarget.getAttribute("collection");a&&(t=e?b.find(e=>e.id===a):m.find(e=>e.id===a))&&(e?h({model:"collection",record:t,config:i?.model?.find(e=>"collection"===e.table)}):K({model:o,record:t,config:i?.model?.find(e=>e.table===o)}))}});var F=React.useCallback(e=>{O(e,"collection")}),q=React.useCallback(e=>{O(e)});const O=React.useCallback((e,a)=>{if(P(),e?.currentTarget?.getAttribute){const i=e.currentTarget.getAttribute("i");var l=e.currentTarget.getAttribute("modif");const o=e.currentTarget.getAttribute("array");var e=e.currentTarget.getAttribute("parentarr"),c=("collection"===a?g:p)?.record;if("edit"===l){if(i){let t=c;var r=i.split(".");for(let e=0;e<r.length;e++)t=t[r[e]];console.log(T.current),y(null),setTimeout(()=>{y({reference:i,cur:t,arr:o,useType:a})},100)}}else if("add"===l&&i){let t=c;var n=i.split(".");if(console.log(l,o,e,t,n),1<n.length&&n.pop(),e){for(let e=0;e<n.length;e++)t=t[n[e]];console.log(t,o,i,n.join(".")),y({reference:n.join("."),cur:t,arr:o,useType:a})}else E({reference:n.join("."),field:"",value:"",useType:a})}}}),I=(e,t,a,l,c)=>{if(e){if(!(c&&!e[t[a]]||e&&t[a]&&Object.hasOwnProperty.call(e,t[a])||e&&e[t[a]]&&a===t.length-1))return I(e[t[a]],t,a+1,l,c);e[t[a]]=l}return e};var z=React.useCallback(e=>{var t;g?.record?.type!==o&&""!==g?.record?.type||!p?.record||((t={...g}).record.type=o,h(t),(t=[...N]).push(Object.assign(p.record,{temp:!0})),$(t))}),B=React.useCallback(a=>{if(a?.currentTarget?.getAttribute){a=a.currentTarget.getAttribute("modif");if("cancel"===a)y(null),E(null);else if("set"===a){let e=T.current.value;R?.arr&&(e=e.split(","));a=("collection"===R?.useType||"collection"===v?.useType?g:p).record;let t;v?.reference&&A?.current?.value?(t=v.reference.split(".")).push(A.current.value):t=R.reference.split("."),a=I(a,t,0,e,!!v?.reference&&A.current.value),"collection"===R?.useType||"collection"===v?.useType?(console.log(a,g),h({model:"collection",record:g.record,config:i?.model?.find(e=>"collection"===e.table)})):r(p),y(null),(async e=>{let a;try{if(null===e.id&&"collection"===R?.useType)return!h({model:"collection",record:e,config:i?.model?.find(e=>"collection"===e.table)});if(!s){a=setTimeout(()=>{d(!1)},1e4);var l,c,r={domainKey:n.domainKey,hash:n._loggedIn.hash,identifier:n._loggedIn.identifier,table:o,record:e??U,recordid:e?.id};let t=await fetchPost(n.apiUrl+"/a/databasecrudupdate",null,null,r);return t?t.hasOwnProperty("status")?(d(!1),clearTimeout(a),"disauthenticated"==t.status?(logout(),"disauthenticated"):"failed"!=t.status&&("success"==t.status?(t?.data&&(console.log(t.data),-1<(c=(l=m).findIndex(e=>e.id===t.data.id))&&(l[c]=t.data),console.log(l[c]),u(l)),t):void 0)):void 0:(d(!1),clearTimeout(a),!1)}}catch(e){d(!1),clearTimeout(a)}})(a),E(null)}}});const P=()=>{E(null),y(null),r(null)},D=e=>e.title&&""!==e?.title?e.title:e.name&&""!==e?.name?e.name:e.username&&""!==e?.username?e.username:e.id;var G=React.useCallback(e=>{var t;!g&&C?.Collection&&((t=structuredClone(C.Collection)).author=n?._loggedIn.identifier,h({model:"collection",record:t,config:i?.model?.find(e=>"collection"===e.table)}))}),J=[f-2,f-1,f,f+1,f+2],Q=[c-2,c-1,c,c+1,c+2],X=React.useMemo(()=>React.createElement("div",null,"video"===p?.model&&p?.record?.thumbtrack?.[0]?React.createElement("img",{className:""+AdminStyles.previewContainer,style:{width:"-webkit-fill-available"},src:n?.cdn?.static+"/thumbtrack/"+p.record.thumbtrack[0]}):null),[p?.record,n?.cdn?.static]);return console.log("Database",i,o,m,p,g,R,N),React.createElement("div",{className:`${n.className} ${moduleName}_Container`,style:{marginRight:".5rem"}},React.createElement(Tooltip,{title:"Create collections of any type to be manipulated and used in any way on the platform. Try making a list of videos or articles or even a course.",placement:"right"},React.createElement("h3",{style:{width:"fit-content"}},"Collections")),React.createElement("div",{style:{background:"$1f1f1f",borderRadius:"1rem"}},React.createElement(IndexHello,_extends({},n,{style:{marginBottom:".5rem",paddingTop:".5rem"},groupLabel:g?.record?.title??"",items:N??[],tight:!0}))),React.createElement("div",{className:""+AdminStyles.containerTwoSmallRight},React.createElement("div",null,React.createElement("div",null,v?React.createElement("div",{className:""+AdminStyles.crudUpdateContainer},React.createElement("div",{style:{marginBottom:".25rem"}},"New field under ",v?.reference," of ","collection"===v?.useType?"collection":p?.model," ",("collection"===v?.useType?g:p)?.record?.id),React.createElement("div",{className:"flex gap-p5"},React.createElement("input",{type:"text",placeholder:"Set Field",ref:A,defaultValue:R?.cur,className:""+AdminStyles.input,style:{width:"100%",marginBottom:".25rem"}}),React.createElement("input",{type:"text",placeholder:"Set Value",ref:T,defaultValue:R?.cur,className:""+AdminStyles.input,style:{width:"100%",marginBottom:".25rem"}})),React.createElement("div",{className:"flex gap-p2"},React.createElement("button",{onClick:B,modif:"set"},"Set"),React.createElement("button",{onClick:B,modif:"cancel"},"Cancel"))):null),React.createElement("div",null,R?React.createElement("div",{className:""+AdminStyles.crudUpdateContainer},React.createElement("div",{style:{marginBottom:".25rem"}},R?.reference," of ","collection"===R?.useType?"collection":p?.model," ",("collection"===R?.useType?g:p)?.record?.id),R?.arr?React.createElement("div",null,"Comma separated list of values"):null,React.createElement("input",{type:"text",placeholder:"Set Value",ref:T,defaultValue:R?.cur,className:""+AdminStyles.inputSearch,style:{width:"100%",marginBottom:".25rem"}}),React.createElement("div",{className:"flex gap-p2"},React.createElement("button",{onClick:B,modif:"set"},"Set"),React.createElement("button",{onClick:B,modif:"cancel"},"Cancel"))):null),React.createElement("div",null,React.createElement("div",{className:"flex gap-p5",style:{flexDirection:"column"}},g?React.createElement("div",{className:""+AdminStyles.crudContainer},React.createElement("div",{className:"flex gap-p5 al-cen",style:{marginBottom:".5rem"}},React.createElement("p",null,"collection")),React.createElement("div",{className:g?.record?"record_box":""},printRecursiveObject(g?.record,0,i?.model?.find(e=>"collection"===e.table),"",F)),p?null:React.createElement("div",{className:"info_box",style:{marginTop:".5rem",fontWeight:700}},"Select child record to add to collection")):null,p?.record?React.createElement("div",{className:""+AdminStyles.crudContainer},g?null:React.createElement("div",{className:"info_box",style:{marginBottom:".5rem",fontWeight:700}},"Select or create a  collection to add to"),React.createElement("div",{className:"flex gap-p5 al-cen",style:{marginBottom:".5rem"}},React.createElement("p",null,p?.model),g&&-1===N?.findIndex(e=>e.id===p.record.id)&&p&&(g?.record?.type===o||""===g?.record?.type)&&p?.record?.__typename?.toLowerCase()===o?React.createElement("button",{onClick:z,record:p?.record?.id},"Add record to collection"):null),React.createElement("div",null,X),React.createElement("h4",null,p?.record?.title??p?.record?.name??p?.record?.username??p?.record?.id),React.createElement("div",{className:"record_box"},printRecursiveObject(p.record,0,p?.config,"",q))):null))),React.createElement("div",{className:"flex",style:{flexDirection:"column",minHeight:"85vh"}},React.createElement("div",{className:"Editor_Container Editor_MaxWidth",style:{minHeight:"35vh"}},React.createElement("div",{className:"flex gap-p5 al-cen",style:{marginBottom:".5rem"}},React.createElement("h4",{style:{marginBottom:0}},"Parent"),g?null:React.createElement("button",{onClick:G},"New")),React.createElement("section",null,React.createElement("div",null,React.createElement("input",{type:"text",placeholder:"Search Records",ref:S,className:""+AdminStyles.inputSearch,style:{width:"100%"},hierarchy:"master",onChange:e})),React.createElement("div",{className:"flex",style:{flexDirection:"column",gap:".25rem"}},b?.map?b.map(e=>React.createElement("div",{className:""+AdminStyles.itemContainer,style:{cursor:"pointer"},onClick:w,modif:e.id,collection:"collection"},React.createElement("div",null,D(e)))):null),React.createElement("ul",{className:"PaginationContainer"},Q.map((e,t)=>-1<e?React.createElement("li",{className:e==c?"ActivePage":"",scope:"itemOffset",hierarchy:"master",key:t,i:e,onClick:_},e+1):null)))),React.createElement("div",{className:"Editor_Container Editor_MaxWidth",style:{height:"35vh"}},React.createElement("div",{className:"flex gap-p5 al-cen",style:{marginBottom:".5rem"}},React.createElement("h4",{style:{marginBottom:0}},"Child")),React.createElement("div",{className:"tagContainer",style:{marginBottom:".5rem"}},i?.model?.map?i.model.map((e,t)=>React.createElement("div",{className:"tagItem "+(o===e?.table?"tagItemSelected":null),style:{cursor:"pointer"},modif:e?.table,onClick:Y},e?.table)):null),React.createElement("section",{style:{height:"inherit"}},React.createElement("div",null,React.createElement("input",{type:"text",placeholder:"Search Records",ref:S,className:""+AdminStyles.inputSearch,style:{width:"100%"},hierarchy:"slave",onChange:e})),React.createElement("div",{className:"flex",style:{height:"inherit",overflow:"auto",flexDirection:"column",gap:".25rem"}},m?.map?m.map(e=>React.createElement("div",{className:""+AdminStyles.itemContainer,style:{cursor:"pointer"},onClick:w,modif:e.id},React.createElement("div",null,D(e)))):null),React.createElement("ul",{className:"PaginationContainer"},J.map((e,t)=>-1<e?React.createElement("li",{className:e==f?"ActivePage":"",scope:"itemOffset",hierarchy:"slave",key:t,i:e,onClick:_},e+1):null)))))))};export default Module;