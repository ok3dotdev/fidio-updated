function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,r=arguments[t];for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}import React from"react";import{fireGlobalEvent}from"../../utility/utility/event.js";import{CreditCard}from"../../payment/index.js";import{logout}from"/modules/utility/onboarding/SignIn.js";import{Cart}from"/layout/index.js";import{addToCart,calculateTotal,performPurchase,resolveCurrentStyle,resolveCurrentOption,resolveMoneyFormat,resolveRegionBasedPrice,updateCart,resolveImg}from"/modules/utility/ecommerce/ecommerce.js";import Inventory from"@mui/icons-material/Inventory";import{v4 as uuidv4}from"uuid";const Module=i=>{const[e,t]=React.useState(!1),[p,d]=React.useState(!1),[a,n]=React.useState(null);var[r,c]=React.useState(!0);const[o,u]=React.useState([]),[s,l]=React.useState(!1);var[m,g]=React.useState(!0);const[y,h]=React.useState(null),[f,v]=React.useState(!1),[C,R]=React.useState(!1),_=React.useRef(),b=React.useRef(),S=(React.useEffect(()=>{e||(_.current.addEventListener("mouseover",S),t(!0))},[e]),()=>{i._LocalEventEmitter.dispatch("cart_update",{dispatch:"mouseOver"})});var E=React.useCallback(e=>{e&&i&&i._toggleSingleOpenMenu&&i._toggleSingleOpenMenu(e,"main_settings")},[i._openMenu]),P=(i._LocalEventEmitter.unsubscribe("cart_update"),i._LocalEventEmitter.subscribe("cart_update",e=>{let t=[...o];var a;e&&(console.log("Cart Update",e),"purchase"===e.dispatch?(t=t.filter(e=>e&&"purchase"!==e.type),a=i.devLocal?i.devAddress:"https://"+i.domainUrl,t.push({message:"Purchase success",href:a+"/r?o="+e.id,hrefCta:"View your Receipt Here",type:"purchase"}),u(t)):"flashCart"===e.dispatch?(l(!0),i.passOveride&&i.passOveride("cart"),setTimeout(()=>{l(!1)},1500)):"purchaseComplete"===e.dispatch?"paystack"===e.type&&(console.log("paystack purchase",e),a=setTimeout(()=>{d(!1)},2e4),k(e.data.snapshot,e.data.cart,a,e.data)):"mouseOver"===e.dispatch&&(console.log("Did mouse over",i,C),"cart"===i?._openMenu?.currentMenu)&&!C&&i._toggleSingleOpenMenu&&i._toggleSingleOpenMenu(null,"cart",!0))}),React.useCallback(e=>{n(null)})),T=React.useCallback(async t=>{try{if(console.log(t.currentTarget.getAttribute,p),!p&&t&&t.currentTarget&&t.currentTarget.getAttribute){d(!0);var a=t.currentTarget.getAttribute("styleId"),r=t.currentTarget.getAttribute("optionId"),c=t.currentTarget.getAttribute("quantity");const l=t.currentTarget.getAttribute("productId");var s={};Number(t.currentTarget.value)<Number(c)&&(s.decrement=!0);let e;var n,o,u=JSON.parse(localStorage.getItem("cart"));(e=l&&u&&u.items?u.items.find(e=>e.product.id===l):e)&&(n=await addToCart(i.apiUrl,i.domainKey,i._loggedIn,u,e.product,{style:a,option:r},d,s))&&"success"===n.status&&(updateCart(u,n.cart),n.cart)&&n.cart.items&&(o=n.cart.items.find(e=>e.product.id===l))&&(t.target.value=o.quantity),d(!1)}}catch(e){console.log(e),d(!1)}});const O="undefined"!=typeof window?JSON.parse(localStorage.getItem("cart")):null,k=async(t,a,e,r={})=>{var c=await performPurchase(i.apiUrl,i.domainKey,i._loggedIn,a,d,{snapshot:t,extra:r});if(console.log(c),c)if(e&&clearTimeout(e),d(!1),console.log(c),"success"===c.status){c.data&&c.data.cart&&updateCart(i._cart,c.data.cart);let e=[...o];e=e.filter(e=>e&&"purchase"!==e.type);var s=i.devLocal?i.devAddress:"https://"+i.domainUrl;e.push({message:"Purchase success",href:s+"/r?o="+c.data.order.id,hrefCta:"View your Receipt Here",type:"purchase"}),u(e),fireGlobalEvent({event:"product_purchase",status:"success",prePurchaseCart:a,cart:c.data.cart,snapshot:t,extra:r,receipt:c.data.order.id,receiptUrl:s+"/r?o="+c.data.order.id},i._LocalEventEmitter),console.log("Purchase Success",c)}else n({message:"Purchase failed",placement:"purchase"}),fireGlobalEvent({event:"product_purchase",status:"failed",prePurchaseCart:a,snapshot:t,extra:r},i._LocalEventEmitter);else e&&clearTimeout(e),d(!1),n({message:"Purchase failed",placement:"purchase"})},M=React.useMemo(()=>{const t=O?.items&&O.items[0];if(t?.product?.styles){var e=t.product.styles.find(e=>e.sid===t.style);if(e){const a=resolveRegionBasedPrice(i,e);if(a){const r=[];e={items:O.items.filter(t=>{var e=t.product.styles.find(e=>e.sid===t.style);if(e){e=resolveRegionBasedPrice(i,e);if(e&&e.currency===a.currency)return!0}return r.push(t),!1}),currency:a,user:O.user};return e.remaining=r,e}}}},[i,O]);var I=React.useCallback(async e=>{try{if(!p){d(!0);var t=setTimeout(()=>{d(!1)},2e4);n(null),console.log(M);const a=calculateTotal(M,null,{region:M?.currency??null,object:!0},i);if(console.log("snapshot",a,y),y){if("stripe"===y.payment)k(a,M,t,{type:"stripe"});else if("paystack"===y.payment&&PaystackPop&&i?.paymentConfig?.keys?.paystack&&i?._loggedIn?.email){const r=uuidv4();clearTimeout(t),M?.currency?.currency&&(await PaystackPop.setup({key:i.paymentConfig.keys.paystack,email:i._loggedIn.email,amount:100*a.total,currency:M.currency.currency,ref:r,callback:function(e){i._LocalEventEmitter.dispatch("cart_update",{dispatch:"purchaseComplete",type:"paystack",data:{cart:M,paystackResponse:e,snapshot:a,status:"payment_complete",transactionRef:r,type:"paystack"}})},onClose:function(){d(!1),n({message:"Purchase failed",placement:"purchase"})}})).openIframe()}}else d(!1),n({message:"Purchase currently not supported in your Country",placement:"purchase"})}}catch(e){d(!1)}}),j=(React.useEffect(()=>{var e;"cart"!==i?._openMenu?.currentMenu&&!s||f?"cart"!==i?._openMenu?.currentMenu&&!s&&f&&(R(!0),e=setTimeout(()=>{R(!1),v(!1),b.current=null},500),b.current=e):(v(!0),R(!1),b?.current&&clearTimeout(b.current))},[i?._openMenu?.currentMenu,C,f,b?.current]),calculateTotal(M,null,{region:M?.currency??null,object:!0},i)),j=j&&Object.prototype.hasOwnProperty.call(j,"total")&&0===j.total&&0<O?.items?.length;return React.createElement(React.Fragment,null,React.createElement(Cart,_extends({},i,{fetchBusy:p,menuOpen:f,closing:C,cart:O,useCartOfCurrency:M,handleUpdateQuantity:T,handlePerformPurchase:I,handleClearError:P,pageError:a,free:j,validCc:r,setValidCc:c,cartMessages:o,handleToggleSettings:E,showContent:m,setShowContent:g,setSolution:h,ccChildren:i?.ccChildren,container:_})))};export default Module;