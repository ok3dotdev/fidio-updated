function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}import React from"react";import apiReq from"/modules/utility/api/apiReq";import{useRouter}from"next/router";import{checkSignedIn,attemptThirdPartySignIn}from"../../utility/onboarding/SignIn";import{setStripeSecretData}from"../../utility/payment/index";import{fetchPost}from"../../utility/fetch";import{SignInOnboard,RegisterOnboard}from"/layout/onboarding";import{debounce}from"../../util";import{handleLookupUsernameRequest}from"./tools";import{fireGlobalEvent}from"../../utility/utility";const Module=a=>{const t=useRouter(),n=t["asPath"];let r=React.useRef();const[e,i]=React.useState(!1),[o,s]=React.useState(!1);let[,l]=React.useState(!1),[c,u]=React.useState(!1),[d,g]=React.useState(!1);const[m,h]=React.useState(!1),[p,R]=React.useState(!1),[f,S]=React.useState(null),[v,_]=React.useState({});let[I,y]=React.useState(null);const E=React.useRef(),b=React.useRef(),w=React.useRef(),A=(React.useEffect(()=>{i(!0)},[e]),a._LocalEventEmitter.unsubscribe("showSignIn"),a._LocalEventEmitter.subscribe("showSignIn",e=>{g(!1),h(!1),L(500)}),a._LocalEventEmitter.unsubscribe("checkAdminAuth"),a._LocalEventEmitter.subscribe("checkAdminAuth",e=>{O(!0)}),React.useEffect(()=>{document.addEventListener("mute-login-error",()=>{y(null)},{once:!0})},[]),async e=>{e=await attemptThirdPartySignIn(e,a.apiUrl,a.domainKey,a._LocalEventEmitter,a._setAdminAuth,y);e?.data&&e?.data.hasOwnProperty("username")&&(e.data.username||l(!0)),"error"!=typeof e&&(setStripeSecretData(a.apiUrl,a.domainKey,e,a._setStripeSecret),a._setLoggedIn(e.data),console.log(a.redirectOnAuth,e.username),"/admin"===n&&setTimeout(()=>{a._LocalEventEmitter.dispatch("checkAdminAuth",{})},1e3),a.redirectOnAuth&&e?.data?.username&&n!==a.redirectOnAuth?t.push(a.redirectOnAuth):a.redirectOnAuth&&e?.data?.username&&n===a.redirectOnAuth&&t.reload(a.redirectOnAuth),setTimeout(()=>{y(null)},2e4),setTimeout(()=>{g(!0),h(!0)}))}),L=(e,t)=>{try{if(!c||t){const n={theme:"outline",size:"medium",logo_alignment:"center"};setTimeout(()=>{try{var e=checkSignedIn();e?a._setLoggedIn(e):(google.accounts.id.renderButton(r.current,n),u(!0),google.accounts.id.prompt(e=>{console.log("on prompt notification",e)}))}catch(e){setTimeout(()=>{try{var e=checkSignedIn();e?a._setLoggedIn(e):(google.accounts.id.renderButton(r.current,n),u(!0),google.accounts.id.prompt(e=>{console.log("on prompt notification",e)}))}catch(e){console.log(e)}},1e4)}},e)}}catch(e){console.log(e)}},O=(React.useEffect(()=>{document.removeEventListener("thirdparty-signin",A),document.addEventListener("thirdparty-signin",A),L(500)},[]),async e=>{(a?.path.match(/\/admin/)&&!o||e)&&(console.log(a),a?._loggedIn?.identifier)&&a?._loggedIn?.hash&&a?.domainKey&&!a._adminAuth&&a?._setAdminAuth&&(s(!0),(e=await(async(e,t,n,a)=>{if(t)return!!(e=await fetchPost(e+"/m/checkadminauth",null,null,{identifier:t,hash:n,domainKey:a}))&&(e.hasOwnProperty("status")?"disauthenticated"==e.status?(logout(),"disauthenticated"):"failed"!=e.status&&("success"==e.status?e:void 0):void 0)})(a.apiUrl,a._loggedIn.identifier,a._loggedIn.hash,a.domainKey))?.admin)&&a._setAdminAuth(e.admin)});React.useEffect(()=>{a?._loggedIn?.identifier&&a?._adminAuth?.userid&&a._loggedIn.identifier!==a._adminAuth.userid&&a._setAdminAuth(null)},[a._loggedIn,a._adminAuth]),O();var k=React.useCallback(e=>{(async()=>{E?.current?.value&&await apiReq("/onboarding/signinunregistered",{email:E?.current?.value,password:b?.current?.value,signIn:!0,props:a,setPageError:y})})()}),C=React.useCallback(e=>{(async()=>{E?.current?.value&&await apiReq("/onboarding/signinunregistered",{email:E?.current?.value,password:b?.current?.value,username:w?.current?.value,register:!0,props:a,setPageError:y})})()}),P=()=>{if(u(!1),L(500,!0),p)return R(!1),!1;R(!0)},T=(()=>{try{var e=document.getElementsByClassName("google-sign-in-btn");return e&&e[0]&&0<e[0].children.length&&e[0].children[0]?!0:!1}catch(e){return!1}})(),x=React.useCallback(e=>{y(null)}),U=d&&m||a?._loggedIn;const q=React.useCallback(debounce(async e=>{e=await handleLookupUsernameRequest(e?.target?.value);e?.data&&S(e)},1500),[]);var K=React.useCallback(async e=>{S(null),q(e)},[]),j=React.useCallback(e=>{S(null)}),D=React.useCallback(e=>{if(E?.current?.value){var t=E.current.value;if(v[t]&&v[t]>(new Date).getTime()-12e4)return!1;var n=v,n=(n[t]=(new Date).getTime(),_(n),{event:"reset_password",data:{email:t}});a?._LocalEventEmitter&&a._LocalEventEmitter.dispatch("global_event",n);try{window.dispatchEvent(new CustomEvent("global_event",{detail:Object.assign({},n)}))}catch(e){}}},[a?._LocalEventEmitter]);return React.createElement("div",{className:`${a.className} ${a._loggedIn||!T?"":a.classNameOnLoaded} SignIn_Container `+(a.noStyle?"":"SignIn_ContainerOn"),style:{width:a?.width??null,maxWidth:a?.width??null,margin:"0 auto"}}," ",a?._loggedIn?null:a?.loadRegister||p?React.createElement(RegisterOnboard,_extends({},a,{emailRef:E,passwordRef:b,usernameRef:w,handleRegisterManual:C,hideSignIn:m,allhidden:U,hideGoogleSignIn:d,googleSignInIsLoaded:T,googleSignInRendered:c,googleSignIn:r,handleSetLoadRegister:P,pageError:I,handleClearPageError:x,availableUsername:f,handleLookupUsername:K,handleClearUsername:j})):React.createElement(SignInOnboard,_extends({},a,{emailRef:E,passwordRef:b,handleSignInManual:k,hideSignIn:m,allhidden:U,hideGoogleSignIn:d,googleSignInIsLoaded:T,googleSignInRendered:c,googleSignIn:r,handleSetLoadRegister:P,pageError:I,handleClearPageError:x,handleSetResetPassword:D})))};export default Module;