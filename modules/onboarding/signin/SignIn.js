import React from"react";import apiReq from"/modules/utility/api/apiReq";import{useRouter}from"next/router";import{checkSignedIn,attemptThirdPartySignIn}from"../../utility/onboarding/SignIn";import{setStripeSecretData}from"../../utility/payment/index";import{fetchPost}from"../../utility/fetch";const Module=n=>{const t=useRouter(),a=t["asPath"];let i=React.useRef();const[e,o]=React.useState(!1),[r,c]=React.useState(!1);let[,l]=React.useState(!1),[s,d]=React.useState(!1),[u,m]=React.useState(!1);const[g,h]=React.useState(!1);let[p,_]=React.useState(null);const S=React.useRef(),R=(React.useEffect(()=>{o(!0)},[e]),n._LocalEventEmitter.unsubscribe("showSignIn"),n._LocalEventEmitter.subscribe("showSignIn",e=>{m(!1),h(!1),I(500)}),n._LocalEventEmitter.unsubscribe("checkAdminAuth"),n._LocalEventEmitter.subscribe("checkAdminAuth",e=>{f(!0)}),React.useEffect(()=>{document.addEventListener("mute-login-error",()=>{_(null)},{once:!0})},[]),async e=>{e=await attemptThirdPartySignIn(e,n.apiUrl,n.domainKey,n._LocalEventEmitter,n._setAdminAuth);e&&e.hasOwnProperty("username")&&(e.username||l(!0)),console.log(e),"error"!=typeof e&&(setStripeSecretData(n.apiUrl,n.domainKey,e,n._setStripeSecret),n._setLoggedIn(e),console.log(n.redirectOnAuth,e.username),"/admin"===a&&setTimeout(()=>{n._LocalEventEmitter.dispatch("checkAdminAuth",{})},1e3),n.redirectOnAuth&&e.username&&a!==n.redirectOnAuth?t.push(n.redirectOnAuth):n.redirectOnAuth&&e.username&&a===n.redirectOnAuth&&t.reload(n.redirectOnAuth),setTimeout(()=>{_(null)},2e4),setTimeout(()=>{m(!0),h(!0)}))}),I=e=>{try{if(!s){const t={theme:"outline",size:"medium",logo_alignment:"center"};setTimeout(()=>{try{var e=checkSignedIn();e?n._setLoggedIn(e):(google.accounts.id.renderButton(i.current,t),d(!0),google.accounts.id.prompt(e=>{console.log("on prompt notification",e)}))}catch(e){setTimeout(()=>{try{var e=checkSignedIn();e?n._setLoggedIn(e):(google.accounts.id.renderButton(i.current,t),d(!0),google.accounts.id.prompt(e=>{console.log("on prompt notification",e)}))}catch(e){console.log(e)}},1e4)}},e)}}catch(e){console.log(e)}},f=(React.useEffect(()=>{document.removeEventListener("thirdparty-signin",R),document.addEventListener("thirdparty-signin",R),I(500)},[]),async e=>{(n?.path.match(/\/admin/)&&!r||e)&&(console.log(n),n?._loggedIn?.identifier)&&n?._loggedIn?.hash&&n?.domainKey&&!n._adminAuth&&n?._setAdminAuth&&(c(!0),(e=await(async(e,t,n,a)=>{if(t)return!!(e=await fetchPost(e+"/m/checkadminauth",null,null,{identifier:t,hash:n,domainKey:a}))&&(e.hasOwnProperty("status")?"disauthenticated"==e.status?(logout(),"disauthenticated"):"failed"!=e.status&&("success"==e.status?e:void 0):void 0)})(n.apiUrl,n._loggedIn.identifier,n._loggedIn.hash,n.domainKey))?.admin)&&n._setAdminAuth(e.admin)});React.useEffect(()=>{n?._loggedIn?.identifier&&n?._adminAuth?.userid&&n._loggedIn.identifier!==n._adminAuth.userid&&n._setAdminAuth(null)},[n._loggedIn,n._adminAuth]),f();var E=React.useCallback(e=>{(async()=>{S?.current?.value&&await apiReq("/onboarding/signinunregistered",{email:S.current.value,props:n})})()}),y=(()=>{try{var e=document.getElementsByClassName("google-sign-in-btn");return e&&e[0]&&0<e[0].children.length&&e[0].children[0]?(console.log(e[0].children[0]),!0):!1}catch(e){return!1}})(),v=u&&g||n?._loggedIn;return React.createElement("div",{className:`${n.className} ${n._loggedIn||!y?"":n.classNameOnLoaded} SignIn_Container `+(n.noStyle?"":"SignIn_ContainerOn"),style:{width:n?.width??null,maxWidth:n?.width??null}}," ",n?.hideAnonSignIn?"":React.createElement("div",{className:"SignIn_ManualContainer "+(g||n?._loggedIn?"display-none":null)},React.createElement("div",{className:"SignIn_ManualContainer_Label_Container"},React.createElement("label",null,"Email"),React.createElement("input",{type:"text",ref:S})),React.createElement("button",{className:"SignIn_ManualButton",onClick:E},"Sign In")),v||n.hideSeparator?null:React.createElement("div",{className:"SignIn_Separator"}),n?.hideOAuthSignIn?"":React.createElement("div",{className:"SignIn_OauthContainer"},React.createElement("div",{className:u||!y?"display-none":null,style:{maxWidth:n.maxWidth??"170px"}},React.createElement("div",{className:s?"googleSignInContainer googleSignInContainer-padding":"googleSignInContainer"},React.createElement("div",{className:"g_id_signin google-sign-in-btn",ref:i,"data-size":"medium","data-logo_alignment":"center","data-theme":"outline"})))),p?React.createElement("div",{style:{paddingLeft:"1rem",paddingRight:"1rem"}},React.createElement("p",{className:"googleSignInPromptSmall error errorBg"},p)):null)};export default Module;